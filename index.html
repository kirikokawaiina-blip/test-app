<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>trpgé¯– ãƒˆãƒ¼ã‚¯ãƒ³ | CloudflareåŒæœŸç‰ˆ v14 (KV-poll)</title>
<meta name="description" content="Cloudflare Workers + KV ã‚’ä½¿ã£ãŸãƒ«ãƒ¼ãƒ åŒæœŸï¼ˆç„¡æ–™ãƒ—ãƒ©ãƒ³å¯¾å¿œï¼‰ã€‚"/>
<style>body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans JP',sans-serif;background:#0b1220;color:#e5edf6}header{position:sticky;top:0;background:#0b132a99;border-bottom:1px solid #60efff22;backdrop-filter:blur(12px)}.nav{max-width:1200px;margin:0 auto;padding:10px 14px;display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}.chip{padding:6px 10px;border:1px solid #60efff33;border-radius:999px;color:#94a3b8;font-size:12px}.btn{appearance:none;border:0;border-radius:10px;background:linear-gradient(90deg,#15c7b6,#60efff);padding:10px 12px;font-weight:800;cursor:pointer}.btn.secondary{background:transparent;border:1px solid #60efff55;color:#e5edf6}.grid{max-width:1200px;margin:16px auto 40px;padding:0 14px;display:grid;grid-template-columns:330px 1fr 340px;gap:14px}@media(max-width:1100px){.grid{grid-template-columns:1fr}}.card{background:#0f172acc;border:1px solid #1f2a44;border-radius:16px;box-shadow:0 10px 35px #0007}.card .hd{padding:10px;border-bottom:1px solid #60efff22}.card .bd{padding:12px}.tabbar{display:flex;gap:6px;flex-wrap:wrap}.tab{padding:6px 10px;border:1px solid #60efff33;border-radius:999px;cursor:pointer}.tab.active{background:#15c7b61a;border-color:#60efff66}.panel{border:1px solid #60efff22;border-radius:10px;padding:10px;background:#0c1628bb}.table{width:100%;display:block;border:1px solid #60efff13;border-radius:10px}.table table{width:100%;border-collapse:separate;border-spacing:0;min-width:760px}.table th,.table td{padding:8px 10px;border-bottom:1px solid #60efff10;white-space:nowrap}.pill{padding:4px 8px;border:1px solid #15c7b652;border-radius:999px;background:#15c7b61a}.toast{position:fixed;right:12px;bottom:12px;display:grid;gap:6px}</style>
</head>
<body>
<header><div class="nav"><div style="display:flex;gap:10px;align-items:center"><div style="width:28px;height:28px;border-radius:8px;background:conic-gradient(from 200deg,#15c7b6,#60efff)"></div>trpgé¯– ãƒˆãƒ¼ã‚¯ãƒ³<span class="chip">ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ & ãƒ«ãƒ¼ãƒ åŒæœŸï¼ˆKVï¼‰</span></div><div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap"><div id="userBadge" class="chip">æœªãƒ­ã‚°ã‚¤ãƒ³</div><div id="streakBadge" class="chip">ğŸ”¥0</div><div id="jackpotBadge" class="chip">JPOT: 0</div><button class="btn" id="morningBtn">æœæ´»</button><button class="btn secondary" id="exportBtn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button><label class="btn secondary">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ<input id="importFile" type="file" accept="application/json" style="display:none"/></label></div></div></header>
<main><div class="grid">
<section class="card"><div class="hd"><h3>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ & åŒæœŸ</h3></div><div class="bd">
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
    <div class="panel"><div class="chip">ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆJPOTé™¤å¤–ï¼‰</div><div id="kpiMembers" style="font-weight:800">0</div></div>
    <div class="panel"><div class="chip">ç·ä¾›çµ¦é‡</div><div id="kpiSupply" style="font-weight:800">0 coin</div></div>
  </div>
  <div class="panel">
    <label>åŒæœŸè¨­å®šï¼ˆHTTP API /stateï¼‰</label>
    <input id="syncUrl" type="text" placeholder="https://<your-worker>.workers.dev/state" style="width:100%;margin:6px 0"/>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <input id="syncRoom" type="text" placeholder="ãƒ«ãƒ¼ãƒ åï¼ˆä¾‹ï¼štrpgï¼‰"/>
      <input id="syncKey" type="text" placeholder="ãƒ«ãƒ¼ãƒ éµï¼ˆä¾‹ï¼š1ï¼‰"/>
    </div>
    <div class="tabbar" style="margin-top:8px"><button class="btn" id="btnConnect">é–‹å§‹/åœæ­¢</button><button class="btn secondary" id="btnSyncNow">æ‰‹å‹•åŒæœŸ</button><span id="syncStatus" class="chip">åœæ­¢ä¸­</span></div>
    <div id="lastSyncChip" class="chip" style="margin-top:6px">æœ€çµ‚åŒæœŸï¼šâ€”</div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
    <div class="panel">
      <label>ãƒ­ã‚°ã‚¤ãƒ³</label>
      <input id="loginName" type="text" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å"/><input id="loginPass" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"/>
      <div class="tabbar"><button class="btn" id="loginBtn">ãƒ­ã‚°ã‚¤ãƒ³</button><button class="btn secondary" id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button></div>
    </div>
    <div class="panel">
      <label>æ–°è¦ç™»éŒ²ï¼ˆåˆæœŸ 10,000 coinï¼‰</label>
      <input id="regName" type="text" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å"/><input id="regPass" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"/><button class="btn" id="registerBtn">ç™»éŒ²</button>
    </div>
  </div>
  <div class="panel" style="margin-top:8px"><label>ã‚¦ã‚©ãƒ¬ãƒƒãƒˆä¸€è¦§</label><div id="walletList" style="display:grid;gap:6px"></div></div>
</div></section>
<section class="card"><div class="hd"><h3>æ“ä½œ</h3><div class="tabbar"><div class="tab active" data-tab="transfer">é€é‡‘</div><div class="tab" data-tab="market">ãƒãƒ¼ã‚±ãƒƒãƒˆ</div><div class="tab" data-tab="myrights">è‡ªåˆ†ã®æ¨©åˆ©</div><div class="tab" data-tab="gamble">ã‚®ãƒ£ãƒ³ãƒ–ãƒ«</div></div></div>
<div class="bd">
<div id="tab-transfer">
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
    <div class="panel"><label>é€ä¿¡å…ƒï¼ˆã‚ãªãŸï¼‰</label><input id="fromFixed" type="text" disabled placeholder="æœªãƒ­ã‚°ã‚¤ãƒ³"/></div>
    <div class="panel"><label>é€ä¿¡å…ˆ</label><select id="toSelect"></select></div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 140px;gap:10px;margin-top:8px">
    <div class="panel"><label>é‡‘é¡ï¼ˆcoinï¼‰</label><input id="amountInput" type="number" min="1" step="1" placeholder="ä¾‹ï¼‰250"/></div>
    <div class="panel"><label>&nbsp;</label><button class="btn" id="sendBtn">é€ä¿¡ã™ã‚‹</button></div>
  </div>
  <div class="panel" style="margin-top:8px"><label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label><input id="memoInput" type="text" placeholder="ä¾‹ï¼‰ã‚®ãƒ«ãƒ‰è³é‡‘"/></div>
</div>
<div id="tab-market" style="display:none">
  <div class="tabbar" style="margin-bottom:6px"><div class="tab active" data-sub="sell">å‡ºå“ã™ã‚‹</div><div class="tab" data-sub="list">å‡ºå“ä¸€è¦§</div></div>
  <div id="market-sell" class="panel">
    <label>æ¨©åˆ©ã®å‡ºå“</label><input id="listTitle" type="text" placeholder="ä¾‹ï¼‰ã‚²ãƒ¼ãƒ ã‚’ä¸€ç·’ã«éŠã¶"/><textarea id="listDesc" rows="2" placeholder="èª¬æ˜ï¼ˆä»»æ„ï¼‰"></textarea>
    <div style="display:grid;grid-template-columns:1fr 1fr 140px;gap:8px">
      <div><label>ä¾¡æ ¼</label><input id="listPrice" type="number" min="1" step="1"/></div>
      <div><label>åœ¨åº«</label><input id="listQty" type="number" min="1" step="1"/></div>
      <div style="display:flex;align-items:end"><button class="btn" id="createListingBtn">å‡ºå“ã™ã‚‹</button></div>
    </div>
  </div>
  <div id="market-list" style="display:none">
    <div class="table"><table><thead><tr><th>ã‚¿ã‚¤ãƒˆãƒ«</th><th>ä¾¡æ ¼</th><th>åœ¨åº«</th><th>å‡ºå“è€…</th><th>èª¬æ˜</th><th>æ“ä½œ</th></tr></thead><tbody id="listingBody"></tbody></table></div>
  </div>
</div>
<div id="tab-myrights" style="display:none">
  <div class="table"><table><thead><tr><th>æ—¥ä»˜</th><th>ã‚¿ã‚¤ãƒˆãƒ«</th><th>è²©å£²è€…</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody id="rightsBody"></tbody></table></div>
</div>
<div id="tab-gamble" style="display:none">
  <div class="panel"><label>TRPGã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆ</label><div class="tabbar"><div class="chip" id="jackpotChip">ç¾åœ¨: 0 coin</div></div></div>
  <div class="panel"><h4 style="margin:0">ğŸ° ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼ˆ1å›100 coinï¼‰</h4><p style="margin:0;color:#94a3b8;font-size:12px">æœŸå¾…å€¤ç´„70%ã€‚1%ã§å…¨é¡ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆã€‚</p><div class="tabbar"><button class="btn" id="rouletteBtn">å›ã™</button></div><div id="rouletteResult" class="chip" style="margin-top:8px">çµæœ: â€”</div></div>
</div>
<div class="toast" id="toast"></div>
</div></section>
<section class="card"><div class="hd"><h3>å±¥æ­´</h3><div class="tabbar"><input id="searchInput" type="text" placeholder="æ¤œç´¢ï¼šåå‰ / ãƒ¡ãƒ¢ / æ¨©åˆ©" style="width:200px"/><select id="memberFilter"><option value="">ã™ã¹ã¦</option></select><div id="lastActivity" class="chip">æœ€çµ‚æ›´æ–°ï¼šâ€”</div></div></div>
<div class="bd"><div class="table"><table><thead><tr><th>æ—¥ä»˜</th><th>ç¨®åˆ¥</th><th>é€ä¿¡å…ƒ/è²©å£²è€…</th><th>é€ä¿¡å…ˆ/è³¼å…¥è€…</th><th>ãƒ¡ãƒ¢/æ¨©åˆ©</th><th style="text-align:right">é‡‘é¡</th></tr></thead><tbody id="historyBody"></tbody></table></div></div></section>
</div></main>
<script>
(function(){
const LS_KEY='trpg_token_state_v14_kv', INITIAL_BAL=10000, JACKPOT_NAME='ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆ';
let state={users:[],txs:[],listings:[],rights:[],currentUserId:null,jackpotUserId:'',lastRealUserId:null,approval:{active:false,votes:{}},version:14,vTick:0};
const els={kpiMembers:document.getElementById('kpiMembers'),kpiSupply:document.getElementById('kpiSupply'),walletList:document.getElementById('walletList'),toSelect:document.getElementById('toSelect'),sendBtn:document.getElementById('sendBtn'),amountInput:document.getElementById('amountInput'),memoInput:document.getElementById('memoInput'),historyBody:document.getElementById('historyBody'),searchInput:document.getElementById('searchInput'),memberFilter:document.getElementById('memberFilter'),exportBtn:document.getElementById('exportBtn'),importFile:document.getElementById('importFile'),lastActivity:document.getElementById('lastActivity'),userBadge:document.getElementById('userBadge'),fromFixed:document.getElementById('fromFixed'),streakBadge:document.getElementById('streakBadge'),jackpotBadge:document.getElementById('jackpotBadge'),morningBtn:document.getElementById('morningBtn'),loginName:document.getElementById('loginName'),loginPass:document.getElementById('loginPass'),loginBtn:document.getElementById('loginBtn'),logoutBtn:document.getElementById('logoutBtn'),regName:document.getElementById('regName'),regPass:document.getElementById('regPass'),registerBtn:document.getElementById('registerBtn'),tabs:Array.from(document.querySelectorAll('.tabbar .tab')),tabTransfer:document.getElementById('tab-transfer'),tabMarket:document.getElementById('tab-market'),tabMyRights:document.getElementById('tab-myrights'),tabGamble:document.getElementById('tab-gamble'),listTitle:document.getElementById('listTitle'),listDesc:document.getElementById('listDesc'),listPrice:document.getElementById('listPrice'),listQty:document.getElementById('listQty'),createListingBtn:document.getElementById('createListingBtn'),listingBody:document.getElementById('listingBody'),rightsBody:document.getElementById('rightsBody'),subtabs:Array.from(document.querySelectorAll('#tab-market .tab')),marketSell:document.getElementById('market-sell'),marketList:document.getElementById('market-list'),jackpotChip:document.getElementById('jackpotChip'),rouletteBtn:document.getElementById('rouletteBtn'),rouletteResult:document.getElementById('rouletteResult'),syncUrl:document.getElementById('syncUrl'),syncRoom:document.getElementById('syncRoom'),syncKey:document.getElementById('syncKey'),btnConnect:document.getElementById('btnConnect'),btnSyncNow:document.getElementById('btnSyncNow'),syncStatus:document.getElementById('syncStatus'),lastSyncChip:document.getElementById('lastSyncChip')};
const fmt=new Intl.NumberFormat('ja-JP'); const coins=n=>fmt.format(n)+' coin'; const ts2str=ts=>{const d=new Date(ts);const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${day}`}; const id=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
function toast(msg){const t=document.getElementById('toast');const div=document.createElement('div');div.className='chip';div.textContent=msg;t.appendChild(div);setTimeout(()=>div.remove(),2500);}
function saveLocal(skipPush){localStorage.setItem(LS_KEY,JSON.stringify(state)); if(!skipPush) schedulePush();}
function loadLocal(){try{const raw=localStorage.getItem(LS_KEY);if(raw){state=JSON.parse(raw)}}catch(e){} if(typeof state.vTick!=='number') state.vTick=0;}
const syncStoreKey='trpg_sync_kv'; let syncSettings={url:'',room:'',key:''}; function loadSyncSettings(){try{const s=JSON.parse(localStorage.getItem(syncStoreKey)||'{}'); syncSettings=Object.assign({url:'',room:'',key:''},s);}catch{} els.syncUrl.value=syncSettings.url; els.syncRoom.value=syncSettings.room; els.syncKey.value=syncSettings.key;} function saveSyncSettings(){syncSettings={url:els.syncUrl.value.trim(),room:els.syncRoom.value.trim(),key:els.syncKey.value.trim()}; localStorage.setItem(syncStoreKey,JSON.stringify(syncSettings));}
let pollTimer=null, pushTimer=null; function startPolling(){stopPolling(); els.syncStatus.textContent='åŒæœŸä¸­'; kvFetchLatest(); pollTimer=setInterval(kvFetchLatest,1500);} function stopPolling(){if(pollTimer){clearInterval(pollTimer);pollTimer=null;} els.syncStatus.textContent='åœæ­¢ä¸­';}
function schedulePush(){ if(pushTimer) clearTimeout(pushTimer); pushTimer=setTimeout(kvPushState,180); }
async function kvFetchLatest(){ if(!syncSettings.url||!syncSettings.room||!syncSettings.key) return; try{const u=new URL(syncSettings.url); u.searchParams.set('room',syncSettings.room); u.searchParams.set('key',syncSettings.key); u.searchParams.set('vt',String(state.vTick||0)); const res=await fetch(u.toString(),{method:'GET',headers:{'accept':'application/json'}}); if(!res.ok) return; const data=await res.json(); if(data && data.state && data.state.vTick>(state.vTick||0)){ const keep=state.currentUserId; state=data.state; state.currentUserId=keep||null; saveLocal(true); renderAll(); els.lastSyncChip.textContent='æœ€çµ‚åŒæœŸï¼šå—ä¿¡ '+new Date().toLocaleTimeString(); }}catch(e){} }
async function kvPushState(){ if(!syncSettings.url||!syncSettings.room||!syncSettings.key) return; try{const u=new URL(syncSettings.url); u.searchParams.set('room',syncSettings.room); u.searchParams.set('key',syncSettings.key); const payload=JSON.stringify({vTick:state.vTick, state:Object.assign({},state,{currentUserId:null})}); const res=await fetch(u.toString(),{method:'PUT',headers:{'content-type':'application/json'},body:payload}); if(res.ok){ els.lastSyncChip.textContent='æœ€çµ‚åŒæœŸï¼šé€ä¿¡ '+new Date().toLocaleTimeString(); }}catch(e){} }
async function sha256(text){const enc=new TextEncoder().encode(text);const buf=await crypto.subtle.digest('SHA-256',enc);return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');}
function findUserById(uid){return state.users.find(u=>u.id===uid)||null;} function findUserByName(name){return state.users.find(u=>u.name===name)||null;} function jackpotUser(){return findUserById(state.jackpotUserId);} function isJackpot(u){return u&&u.id===state.jackpotUserId;} function nameOf(uid){const u=findUserById(uid);return u?u.name:'';} function ensureJackpotUser(){let j=findUserByName(JACKPOT_NAME); if(!j){j={id:id(),name:JACKPOT_NAME,passHash:'',balance:0,streakCount:0,lastMorningDate:''}; state.users.unshift(j);} state.jackpotUserId=j.id;}
function addTx(obj){const base={id:id(),ts:Date.now()}; state.txs.unshift(Object.assign(base,obj));} function bump(){state.vTick=(state.vTick||0)+1;}
async function register(name,pass){name=(name||'').trim(); if(!name||!pass){toast('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›');return;} if(name===JACKPOT_NAME){toast('ã“ã®åå‰ã¯äºˆç´„ã•ã‚Œã¦ã„ã¾ã™');return;} if(state.users.some(u=>u.name===name)){toast('ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯ä½¿ç”¨æ¸ˆã¿');return;} const passHash=await sha256(pass); const u={id:id(),name,passHash,balance:INITIAL_BAL,streakCount:0,lastMorningDate:''}; state.users.push(u); state.currentUserId=u.id; state.lastRealUserId=u.id; addTx({type:'mint',to:u.id,amount:INITIAL_BAL,memo:'åˆæœŸç™ºè¡Œ'}); bump(); saveLocal(); renderAll(); toast('ç™»éŒ²å®Œäº†');}
async function login(name,pass){name=(name||'').trim(); const u=findUserByName(name); if(!u){toast('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;} if(isJackpot(u)){state.currentUserId=u.id;} else {const passHash=await sha256(pass||''); if(u.passHash!==passHash){toast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');return;} state.currentUserId=u.id; state.lastRealUserId=u.id;} localStorage.setItem('last_current_uid',state.currentUserId||''); saveLocal(true); renderAll(); toast('ãƒ­ã‚°ã‚¤ãƒ³');}
function logout(){state.currentUserId=null; localStorage.setItem('last_current_uid',''); saveLocal(true); renderAll(); toast('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ');}
function currentUser(){return findUserById(state.currentUserId);}
function transfer(toId,amount,memo){const from=currentUser(); if(!from){toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦');return;} amount=Math.floor(Number(amount)); if(!(amount>0)){toast('é‡‘é¡ã¯1ä»¥ä¸Šã®æ•´æ•°');return;} const to=findUserById(toId); if(!to){toast('é€ä¿¡å…ˆãŒä¸æ­£');return;} if(from.id===toId){toast('è‡ªåˆ†è‡ªèº«ã¸ã¯é€ã‚Œã¾ã›ã‚“');return;} if(isJackpot(to)){toast('ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆã¸ã¯ç›´æ¥é€é‡‘ã§ãã¾ã›ã‚“');return;} if(from.balance<amount){toast('æ®‹é«˜ä¸è¶³');return;} from.balance-=amount; to.balance+=amount; addTx({type:'transfer',from:from.id,to:to.id,amount, memo:(memo||'').trim()}); bump(); saveLocal(); renderAll();}
function createListing(title,price,desc){const seller=currentUser(); if(!seller){toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦');return;} if(isJackpot(seller)){toast('JPOTã§ã¯å‡ºå“ä¸å¯');return;} title=(title||'').trim(); desc=(desc||'').trim(); price=Math.floor(Number(price)); let qty=Math.floor(Number(els.listQty.value||1)); if(!title||!(price>0)||!(qty>0)){toast('å…¥åŠ›ã‚’ç¢ºèª');return;} const l={id:id(),title,price,desc,sellerId:seller.id,active:true,ts:Date.now(),qty,sold:0}; state.listings.unshift(l); bump(); saveLocal(); renderAll();}
function buyListing(listingId){const buyer=currentUser(); if(!buyer){toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦');return;} const l=state.listings.find(x=>x.id===listingId && x.active); if(!l){toast('å‡ºå“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;} if(l.sellerId===buyer.id){toast('è‡ªåˆ†ã®å‡ºå“ã¯è³¼å…¥ä¸å¯');return;} if(isJackpot(buyer)){toast('JPOTã§ã¯è³¼å…¥ä¸å¯');return;} const remaining=(l.qty||1)-(l.sold||0); if(remaining<=0){toast('åœ¨åº«åˆ‡ã‚Œ'); l.active=false; bump(); saveLocal(); renderAll(); return;} if(buyer.balance<l.price){toast('æ®‹é«˜ä¸è¶³');return;} const seller=findUserById(l.sellerId); const j=jackpotUser(); const fee=Math.floor(l.price*0.10); const sellerReceive=l.price-fee; buyer.balance-=l.price; seller.balance+=sellerReceive; j.balance+=fee; const right={id:id(),listingId:l.id,title:l.title,buyerId:buyer.id,sellerId:seller.id,ts:Date.now(),status:'owned',executed:false}; state.rights.unshift(right); l.sold=(l.sold||0)+1; if(l.sold>=l.qty){l.active=false;} addTx({type:'purchase',from:buyer.id,to:seller.id,amount:l.price,listingId:l.id,title:l.title,memo:'æ¨©åˆ©è³¼å…¥ï¼ˆæ‰‹æ•°æ–™10%ï¼‰'}); addTx({type:'fee',from:seller.id,to:j.id,amount:fee,listingId:l.id,title:l.title,memo:'è²©å£²æ‰‹æ•°æ–™'}); bump(); saveLocal(); renderAll();}
function deleteListing(listingId){const me=currentUser(); if(!me){toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦');return;} const idx=state.listings.findIndex(x=>x.id===listingId); if(idx<0){toast('å‡ºå“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;} const l=state.listings[idx]; if(l.sellerId!==me.id){toast('è‡ªåˆ†ã®å‡ºå“ã®ã¿å‰Šé™¤å¯');return;} if((l.sold||0)>0){toast('è³¼å…¥å±¥æ­´ãŒã‚ã‚‹ãŸã‚å‰Šé™¤ä¸å¯');return;} state.listings.splice(idx,1); bump(); saveLocal(); renderAll();}
function toggleListingActive(listingId){const me=currentUser(); if(!me){toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦');return;} const l=state.listings.find(x=>x.id===listingId); if(!l){toast('å‡ºå“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;} if(l.sellerId!==me.id){toast('è‡ªåˆ†ã®å‡ºå“ã®ã¿');return;} l.active=!l.active; bump(); saveLocal(); renderAll();}
function buyerReturn(rightId){const me=currentUser(); if(!me){toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦');return;} const r=state.rights.find(x=>x.id===rightId); if(!r) return; if(r.buyerId!==me.id || r.status!=='owned'){toast('ä¿æœ‰ä¸­ã®ã¿è¿”å“å¯');return;} const l=state.listings.find(x=>x.id===r.listingId); const seller=findUserById(r.sellerId); const refund=Math.floor(l.price*0.90); if(seller.balance<refund){toast('è²©å£²è€…ã®æ®‹é«˜ä¸è¶³');return;} seller.balance-=refund; const buyer=findUserById(r.buyerId); buyer.balance+=refund; l.sold=Math.max(0,(l.sold||0)-1); if(l.sold<l.qty){l.active=true;} state.rights=state.rights.filter(x=>x.id!==rightId); addTx({type:'return',from:seller.id,to:buyer.id,listingId:l.id,title:r.title,amount:refund,memo:'è³¼å…¥è€…ãŒè¿”å“ï¼ˆæ‰‹æ•°æ–™ã¯è¿”ã‚‰ãªã„ï¼‰'}); bump(); saveLocal(); renderAll();}
function buyerRequest(rightId){const me=currentUser(); if(!me){toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦');return;} const r=state.rights.find(x=>x.id===rightId); if(!r) return; if(r.buyerId!==me.id||r.status!=='owned'){toast('ç”³è«‹ã§ãã¾ã›ã‚“');return;} r.status='request'; addTx({type:'execute-request',from:r.buyerId,to:r.sellerId,listingId:r.listingId,title:r.title,memo:'å®Ÿè¡Œç”³è«‹'}); bump(); saveLocal(); renderAll();}
function sellerRespond(rightId,action){const me=currentUser(); if(!me){toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦');return;} const r=state.rights.find(x=>x.id===rightId); if(!r) return; if(r.sellerId!==me.id||r.status!=='request'){toast('å¯¾è±¡å¤–');return;} const l=state.listings.find(x=>x.id===r.listingId); if(action==='exec'){r.status='seller_executed'; addTx({type:'execute-done',from:r.sellerId,to:r.buyerId,listingId:r.listingId,title:r.title,memo:'è²©å£²è€…ãŒå®Ÿè¡Œ'});} else {const seller=findUserById(r.sellerId); if(seller.balance<l.price){toast('æ®‹é¡ä¸è¶³');return;} r.status='seller_cancel_requested'; addTx({type:'execute-cancel-ask',from:r.sellerId,to:r.buyerId,listingId:r.listingId,title:r.title,memo:'è²©å£²è€…ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ç”³è«‹'});} bump(); saveLocal(); renderAll();}
function buyerFinalize(rightId){const me=currentUser(); if(!me){toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦');return;} const r=state.rights.find(x=>x.id===rightId); if(!r) return; if(r.buyerId!==me.id){toast('ã‚ãªãŸã¯è³¼å…¥è€…ã§ã¯ã‚ã‚Šã¾ã›ã‚“');return;} const l=state.listings.find(x=>x.id===r.listingId); if(r.status==='seller_executed'){r.status='finalized'; r.executed=true; addTx({type:'execute-finalize',from:r.buyerId,to:r.sellerId,listingId:r.listingId,title:r.title,memo:'è³¼å…¥è€…ãŒå®Ÿè¡Œç¢ºèªï¼ˆç¢ºå®šï¼‰'});} else if(r.status==='seller_cancel_requested'){const seller=findUserById(r.sellerId); const buyer=findUserById(r.buyerId); if(seller.balance<l.price){toast('è²©å£²è€…ã®æ®‹é«˜ä¸è¶³');return;} seller.balance-=l.price; buyer.balance+=l.price; l.sold=Math.max(0,(l.sold||0)-1); if(l.sold<l.qty){l.active=true;} state.rights=state.rights.filter(x=>x.id!==rightId); addTx({type:'execute-cancel-ok',from:r.buyerId,to:r.sellerId,listingId:r.listingId,title:r.title,amount:l.price,memo:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«è¿”é‡‘ï¼ˆå…¨é¡ï¼‰ç¢ºå®š'});} else {toast('ç¢ºå®šä¸å¯ã®çŠ¶æ…‹');return;} bump(); saveLocal(); renderAll();}
const MORNING_HOUR=7,MORNING_MINUTE=30,MORNING_BASE=1000,STREAK_MAX=30,STREAK_INC=100; function todayKey(){const d=new Date();const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${day}`;} function beforeDeadline(){const n=new Date(); if(n.getHours()<MORNING_HOUR) return true; if(n.getHours()>MORNING_HOUR) return false; return n.getMinutes()<=MORNING_MINUTE;} function canClaimMorning(){const me=currentUser(); if(!me) return {ok:false,reason:'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'}; if(isJackpot(me)) return {ok:false,reason:'ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆã¯æœæ´»å¯¾è±¡å¤–'}; const t=todayKey(); if(me.lastMorningDate===t) return {ok:false,reason:'æœ¬æ—¥ã¯å—å–æ¸ˆã¿'}; if(!beforeDeadline()) return {ok:false,reason:'7:30ã‚’éãã¦ã„ã¾ã™'}; return {ok:true};}
function updateMorningButton(){const me=currentUser(); const s=canClaimMorning(); els.morningBtn.disabled=!s.ok; const cnt=me?(me.streakCount||0):0; els.streakBadge.textContent='ğŸ”¥'+cnt;}
function morningClaim(){const me=currentUser(); const c=canClaimMorning(); if(!c.ok){toast(c.reason); updateMorningButton(); return;} const today=todayKey(); if(me.lastMorningDate){const diff=Math.round((new Date(today)-new Date(me.lastMorningDate))/86400000); me.streakCount=(diff===1)?Math.min((me.streakCount||0)+1,STREAK_MAX):1;} else {me.streakCount=1;} me.lastMorningDate=today; const bonus=MORNING_BASE+STREAK_INC*(me.streakCount||0); me.balance+=bonus; addTx({type:'mint',to:me.id,amount:bonus,memo:`æœæ´»ï¼ˆé€£ç¶š${me.streakCount}æ—¥ï¼‰`}); bump(); saveLocal(); renderAll();}
function renderJackpot(){const j=jackpotUser(); const bal=j?j.balance:0; document.getElementById('jackpotChip').textContent='ç¾åœ¨: '+fmt.format(bal)+' coin'; els.jackpotBadge.textContent='JPOT: '+fmt.format(bal); const me=currentUser(); els.rouletteBtn.disabled=!me || (me&&me.balance<100) || bal<=0 || (me&&isJackpot(me));}
function rouletteSpin(){const me=currentUser(); if(!me){toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦');return;} if(isJackpot(me)){toast('ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆã§ã¯éŠã¹ã¾ã›ã‚“');return;} if(me.balance<100){toast('æ®‹é«˜ä¸è¶³');return;} const j=jackpotUser(); if(!j){toast('JPOTãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;} if(j.balance<=0){toast('ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆãŒç©ºã§ã™');return;} me.balance-=100; j.balance+=100; addTx({type:'jpot-fee',from:me.id,to:j.id,amount:100,memo:'ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆå‚åŠ è²»'}); const roll=Math.random(); if(roll<0.01){const payout=j.balance; if(payout>0){me.balance+=payout; addTx({type:'jackpot',from:j.id,to:me.id,amount:payout,memo:'ğŸ‰ ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆå½“é¸'}); j.balance=0; document.getElementById('rouletteResult').textContent='çµæœ: JACKPOT!! +'+fmt.format(payout)+' coin';} else {document.getElementById('rouletteResult').textContent='çµæœ: JACKPOT 0';} bump(); saveLocal(); renderAll(); return;} const prizes=[{p:0.40,v:0},{p:0.25,v:50},{p:0.18,v:100},{p:0.09,v:150},{p:0.05,v:200},{p:0.02,v:400},{p:0.0099,v:700}]; let r=Math.random(),acc=0,val=0; for(const it of prizes){acc+=it.p;if(r<acc){val=it.v;break;}} const payout=Math.min(j.balance,val); if(payout>0){me.balance+=payout;j.balance-=payout; addTx({type:'roulette',from:j.id,to:me.id,amount:payout,memo:'ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæ‰•ã„å‡ºã—'});} document.getElementById('rouletteResult').textContent='çµæœ: +'+fmt.format(payout)+' coin'; bump(); saveLocal(); renderAll();}
function renderSummary(){els.kpiMembers.textContent=state.users.filter(u=>!isJackpot(u)).length; els.kpiSupply.textContent=coins(state.users.reduce((s,u)=>s+(u.balance||0),0)); const last=state.txs[0]; els.lastActivity.textContent=last?'æœ€çµ‚æ›´æ–°ï¼š'+ts2str(last.ts):'æœ€çµ‚æ›´æ–°ï¼šâ€”';}
function renderWallets(){const list=els.walletList; list.innerHTML=''; state.users.forEach(u=>{const row=document.createElement('div'); row.style.cssText='padding:8px 10px;border:1px solid #60efff22;border-radius:10px;display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;background:#0e1836'; row.innerHTML='<div style="font-weight:750">'+u.name+(u.id===state.currentUserId?'ï¼ˆè‡ªåˆ†ï¼‰':'')+'</div><div class="pill">'+coins(u.balance)+'</div>'; list.appendChild(row);});}
function renderHeaderUser(){const me=currentUser(); els.userBadge.textContent=me?(me.name+' / '+coins(me.balance)):'æœªãƒ­ã‚°ã‚¤ãƒ³'; els.fromFixed.value=me? (me.name+'ï¼ˆæ®‹é«˜ï¼š'+fmt.format(me.balance)+'ï¼‰') : 'æœªãƒ­ã‚°ã‚¤ãƒ³'; updateMorningButton(); renderJackpot();}
function renderSelects(){const me=currentUser(); let list=state.users.filter(u=>!me||u.id!==me.id); if(me&&!isJackpot(me)) list=list.filter(u=>!isJackpot(u)); els.toSelect.innerHTML='<option value="">é¸æŠ</option>'+list.map(u=>'<option value="'+u.id+'">'+u.name+'ï¼ˆ'+fmt.format(u.balance)+'ï¼‰</option>').join(''); els.memberFilter.innerHTML='<option value="">ã™ã¹ã¦</option>'+state.users.map(u=>'<option value="'+u.id+'">'+u.name+'</option>').join('');}
function renderHistory(){const q=(els.searchInput.value||'').toLowerCase(); const f=els.memberFilter.value||''; els.historyBody.innerHTML=''; const frag=document.createDocumentFragment(); state.txs.filter(t=>{if(f && !((t.from&&t.from===f)||(t.to&&t.to===f)||(t.actedBy&&t.actedBy===f))) return false; if(!q) return true; const text=((t.memo||'')+' '+(t.title||'')).toLowerCase(); return text.includes(q);}).forEach(t=>{const tr=document.createElement('tr'); const c=x=>{const td=document.createElement('td'); td.innerHTML=x; return td;}; tr.append(c(ts2str(t.ts)), c(typeLabel(t.type)), c('<span class="pill">'+(nameOf(t.from)||'â€”')+'</span>'), c('<span class="pill">'+(nameOf(t.to)||'â€”')+'</span>'), c(t.title?(t.title+(t.memo?(' / '+t.memo):'')):(t.memo||'')), c('<span>'+ (t.amount?fmt.format(t.amount):'') +'</span>')); frag.appendChild(tr);}); els.historyBody.appendChild(frag);}
function typeLabel(tp){return tp==='transfer'?'é€é‡‘':tp==='purchase'?'è³¼å…¥':tp==='execute-request'?'å®Ÿè¡Œç”³è«‹':tp==='execute-done'?'å®Ÿè¡Œï¼ˆè²©å£²è€…ï¼‰':tp==='execute-finalize'?'å®Ÿè¡Œç¢ºå®šï¼ˆè³¼å…¥è€…ï¼‰':tp==='execute-cancel-ask'?'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç”³è«‹ï¼ˆè²©å£²è€…ï¼‰':tp==='execute-cancel-ok'?'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºå®šï¼ˆè³¼å…¥è€…ï¼‰':tp==='return'?'è¿”å“':tp==='mint'?'ç™ºè¡Œ':tp==='fee'?'æ‰‹æ•°æ–™':tp==='roulette'?'ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ':tp==='jackpot'?'ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆ':tp==='jpot-fee'?'JPOTå…¥é‡‘':'â€”';}
function renderListings(){els.listingBody.innerHTML=''; const me=currentUser(); state.listings.forEach(l=>{const remaining=(l.qty||1)-(l.sold||0); const tr=document.createElement('tr'); function td(text){const x=document.createElement('td'); x.textContent=text; return x;} tr.append(td(l.title+(l.active?'':'ï¼ˆåœæ­¢ä¸­ï¼‰')), (function(){const x=document.createElement('td'); x.innerHTML='<b>'+fmt.format(l.price)+'</b>'; return x;})(), td(remaining+'/'+l.qty), td(nameOf(l.sellerId)), td(l.desc||'')); const tdA=document.createElement('td'); if(me){ if(l.sellerId===me.id){const tog=document.createElement('button');tog.className='btn secondary';tog.textContent=l.active?'åœæ­¢':'å…¬é–‹';tog.onclick=()=>toggleListingActive(l.id); const del=document.createElement('button'); del.className='btn secondary'; del.textContent='å‰Šé™¤'; del.disabled=(l.sold||0)>0; del.onclick=()=>deleteListing(l.id); tdA.append(tog,document.createTextNode(' '),del);} else {const buy=document.createElement('button'); buy.className='btn'; buy.textContent='è³¼å…¥'; buy.disabled=!l.active || remaining<=0 || (me && isJackpot(me)); buy.onclick=()=>{buy.disabled=true; buyListing(l.id);}; tdA.appendChild(buy);} } else {const s=document.createElement('span'); s.className='chip'; s.textContent='ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'; tdA.appendChild(s);} tr.appendChild(tdA); els.listingBody.appendChild(tr);});}
function renderRights(){els.rightsBody.innerHTML=''; const me=currentUser(); if(!me) return; state.rights.filter(r=>r.buyerId===me.id).forEach(r=>{const tr=document.createElement('tr'); function td(t){const x=document.createElement('td'); x.textContent=t; return x;} tr.append(td(ts2str(r.ts)), td(r.title), td(nameOf(r.sellerId)), td(statusLabel(r))); const tdA=document.createElement('td'); tdA.appendChild(rightActionButtons(r)); tr.appendChild(tdA); els.rightsBody.appendChild(tr);});}
function statusLabel(r){return r.status==='owned'?'ä¿æœ‰ä¸­':r.status==='request'?'è²©å£²è€…ã®å¯¾å¿œå¾…ã¡':r.status==='seller_executed'?'è²©å£²è€…ãŒå®Ÿè¡Œæ¸ˆï¼ˆç¢ºèªå¾…ã¡ï¼‰':r.status==='seller_cancel_requested'?'è²©å£²è€…ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ç”³è«‹ï¼ˆç¢ºèªå¾…ã¡ï¼‰':r.status==='finalized'?(r.executed?'ç¢ºå®šï¼ˆå®Ÿè¡Œæ¸ˆï¼‰':'ç¢ºå®šï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰'):'â€”';}
function rightActionButtons(r){const span=document.createElement('span'); if(r.status==='owned'){const btn=document.createElement('button'); btn.className='btn'; btn.textContent='å®Ÿè¡Œã‚’ç”³è«‹'; btn.onclick=()=>{btn.disabled=true; buyerRequest(r.id);}; const ret=document.createElement('button'); ret.className='btn secondary'; ret.textContent='è¿”å“'; ret.onclick=()=>{ret.disabled=true; buyerReturn(r.id);}; span.append(btn,document.createTextNode(' '),ret);} else if(r.status==='seller_executed'){const btn=document.createElement('button'); btn.className='btn'; btn.textContent='æ¸ˆï¼ˆç¢ºå®šï¼‰'; btn.onclick=()=>{btn.disabled=true; buyerFinalize(r.id);}; span.appendChild(btn);} else if(r.status==='seller_cancel_requested'){const btn=document.createElement('button'); btn.className='btn secondary'; btn.textContent='ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ‰¿èªï¼ˆç¢ºå®šï¼‰'; btn.onclick=()=>{btn.disabled=true; buyerFinalize(r.id);}; span.appendChild(btn);} else {const chip=document.createElement('span'); chip.className='chip'; chip.textContent='æ“ä½œãªã—'; span.appendChild(chip);} return span;}
function switchMarketSub(which){document.querySelectorAll('#tab-market .tab').forEach(s=>s.classList.toggle('active',s.dataset.sub===which)); els.marketSell.style.display=which==='sell'?'block':'none'; els.marketList.style.display=which==='list'?'block':'none';}
function renderTabs(){const show=name=>{els.tabTransfer.style.display=name==='transfer'?'block':'none'; els.tabMarket.style.display=name==='market'?'block':'none'; els.tabMyRights.style.display=name==='myrights'?'block':'none'; els.tabGamble.style.display=name==='gamble'?'block':'none';}; const active=document.querySelector('.card .hd .tabbar .tab.active'); show(active?active.dataset.tab:'transfer');}
function renderAll(){renderSummary(); renderWallets(); renderHeaderUser(); renderSelects(); renderHistory(); renderListings(); renderRights(); renderTabs();}
els.registerBtn.addEventListener('click',()=>register(els.regName.value,els.regPass.value)); els.loginBtn.addEventListener('click',()=>login(els.loginName.value,els.loginPass.value)); els.logoutBtn.addEventListener('click',logout); els.sendBtn.addEventListener('click',()=>{transfer(els.toSelect.value,els.amountInput.value,els.memoInput.value); els.amountInput.value=''; els.memoInput.value='';}); els.searchInput.addEventListener('input',renderHistory); els.memberFilter.addEventListener('change',renderHistory); els.exportBtn.addEventListener('click',()=>{const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='trpg_token_v14.json'; a.click(); URL.revokeObjectURL(a.href);}); els.importFile.addEventListener('change',e=>{const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{try{const data=JSON.parse(ev.target.result); const keep=state.currentUserId; state=Object.assign({version:14,approval:{active:false,votes:{}},lastRealUserId:null,vTick:(state.vTick||0)+1},data); state.currentUserId=keep||null; ensureJackpotUser(); saveLocal(); renderAll();}catch{toast('èª­ã¿è¾¼ã¿å¤±æ•—')}}; r.readAsText(f); e.target.value='';}); document.querySelectorAll('.card .hd .tabbar .tab').forEach(t=>t.addEventListener('click',()=>{document.querySelectorAll('.card .hd .tabbar .tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); renderTabs();})); els.subtabs.forEach(s=>s.addEventListener('click',()=>switchMarketSub(s.dataset.sub))); els.morningBtn.addEventListener('click',morningClaim); els.rouletteBtn.addEventListener('click',rouletteSpin);
els.btnConnect.addEventListener('click',()=>{saveSyncSettings(); if(pollTimer) stopPolling(); else startPolling();}); els.btnSyncNow.addEventListener('click',()=>kvFetchLatest());
loadLocal(); ensureJackpotUser(); state.listings.forEach(l=>{if(typeof l.qty!=='number') l.qty=1; if(typeof l.sold!=='number') l.sold=0;}); state.rights.forEach(r=>{if(!r.status){r.status=r.executed?'finalized':'owned';}}); loadSyncSettings(); renderAll(); if(state.users.filter(u=>!isJackpot(u)).length===0){toast('ã¾ãšã¯æ–°è¦ç™»éŒ²ã—ã¦ãã ã•ã„ï¼ˆåˆæœŸ 10,000 coinï¼‰ / ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆã¯èª°ã§ã‚‚ãƒ­ã‚°ã‚¤ãƒ³å¯');}
function jackpotUserInitFix(){if(typeof state.jackpot==='number'){jackpotUser().balance+=state.jackpot; delete state.jackpot;}}
jackpotUserInitFix();
})();
</script>
</body>
</html>
