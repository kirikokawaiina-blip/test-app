<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>trpgÈØñ „Éà„Éº„ÇØ„É≥ | CloudflareÂêåÊúüÁâà v12</title>
  <meta name="description" content="Êì¨‰ºº„Éà„Éº„ÇØ„É≥ÈÄÅÂèóÈ†ò„ÉªÊ®©Âà©„Éû„Éº„Ç±„ÉÉ„ÉàÔºàÂú®Â∫´/ÂâäÈô§/ËøîÂìÅÔºâ„ÉªÊúùÊ¥ª„Çπ„Éà„É™„Éº„ÇØ„Éª„ÇÆ„É£„É≥„Éñ„É´„ÄÇ„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„Éà„ÅØ„É¶„Éº„Ç∂„Éº„Å®„Åó„Å¶Â≠òÂú®ÔºàÁõ¥Êé•ÂÖ•Èáë‰∏çÂèØÔºâ„ÄÇCloudflare Workers„ÅÆWebSocket„Çí‰Ωø„Å£„Åü„É´„Éº„É†ÂêåÊúüÂØæÂøú„ÄÇ" />
  <style>
    :root {
      --bg: #0b1220;
      --bg-2: #0e1730;
      --card: #0f172a;
      --muted: #94a3b8;
      --text: #e5edf6;
      --line: #1f2a44;
      --accent: #15c7b6;
      --accent-2: #60efff;
      --danger: #ef4444;
      --warn: #f59e0b;
      --ok: #22c55e;
      --shadow: 0 10px 35px rgba(0,0,0,.45), 0 2px 8px rgba(0,0,0,.35);
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", Meiryo, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 800px at 20% -10%, #11224e 0%, transparent 65%),
                  radial-gradient(800px 800px at 110% 10%, rgba(21,199,182,.15) 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
      overflow-y: auto;
    }
    header { position: sticky; top: 0; z-index: 50; backdrop-filter: saturate(120%) blur(14px); background: linear-gradient(180deg, rgba(9,14,30,.8), rgba(12,18,38,.4)); border-bottom: 1px solid rgba(96,239,255,.12); }
    .nav { max-width: 1200px; margin: 0 auto; padding: 10px 14px; display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
    .logo { display: grid; grid-auto-flow: column; align-items: center; gap: 10px; font-weight: 750; letter-spacing: .3px; font-size: 16px; }
    .logo-badge { width: 28px; height: 28px; border-radius: 8px; display: grid; place-items: center; background: conic-gradient(from 200deg, var(--accent), var(--accent-2)); box-shadow: 0 8px 20px rgba(21,199,182,.35); }
    .chip { padding: 6px 10px; border: 1px solid rgba(96,239,255,.18); border-radius: 999px; color: var(--muted); font-size: 12px; }

    main { max-width: 1200px; margin: 16px auto 40px; padding: 0 14px; }
    .grid { display: grid; grid-template-columns: 330px 1fr 340px; gap: 14px; }
    @media (max-width: 1100px) { .grid { grid-template-columns: 1fr; } }

    .card { background: linear-gradient(180deg, rgba(16,25,46,.8), rgba(12,20,38,.8)); border: 1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
    .card .hd { padding: 10px 12px; display:flex; align-items:center; justify-content:space-between; gap:10px; background: linear-gradient(180deg, rgba(22,32,58,.6), rgba(19,28,50,.2)); border-bottom: 1px solid rgba(96,239,255,.1); }
    .card .hd h3 { margin: 0; font-size: 14px; letter-spacing: .3px; color: #d9e7ff; font-weight: 700; }
    .card .bd { padding: 12px; }

    .stat { display:grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
    .kpi { padding: 8px; border: 1px solid rgba(96,239,255,.12); border-radius: 12px; background: rgba(17,28,52,.45); }
    .kpi .lbl { color: var(--muted); font-size: 11px; }
    .kpi .val { margin-top: 2px; font-size: 16px; font-weight: 800; letter-spacing: .2px; }

    .row { display: grid; gap: 8px; }
    label { font-size: 12px; color: var(--muted); }
    input[type="text"], input[type="password"], input[type="number"], select, textarea {
      width: 100%; padding: 10px 10px; border-radius: 10px; outline: none; color: var(--text);
      background: rgba(13,21,40,.75); border: 1px solid rgba(96,239,255,.12);
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    input:focus, select:focus, textarea:focus { border-color: rgba(96,239,255,.35); box-shadow: 0 0 0 4px rgba(96,239,255,.12); }

    .btn { appearance: none; border:0; cursor:pointer; color: #04151f; font-weight: 800; letter-spacing: .2px; padding: 10px 12px; border-radius: 10px; transition: transform .05s ease, filter .2s ease, opacity .2s ease; background: linear-gradient(90deg, var(--accent), var(--accent-2)); box-shadow: 0 10px 26px rgba(21,199,182,.35), inset 0 0 0 1px rgba(255,255,255,.18); font-size: 14px; }
    .btn:active { transform: translateY(1px); }
    .btn.secondary { color: var(--text); background: transparent; border: 1px solid rgba(96,239,255,.22); box-shadow: none; }
    .btn.warn { color: #1a1007; background: linear-gradient(90deg, #f59e0b, #fde047); box-shadow: 0 10px 26px rgba(245,158,11,.3); }
    .btn.danger { color: #1a0b0b; background: linear-gradient(90deg, #ef4444, #fb7185); box-shadow: 0 10px 26px rgba(239,68,68,.32); }
    .btn:disabled { filter: grayscale(1) brightness(.85); opacity: .6; cursor: not-allowed; box-shadow: none; }

    .wallet-list { display: grid; gap: 6px; }
    .wallet { padding: 8px 10px; border: 1px solid rgba(96,239,255,.12); border-radius: 10px; display:grid; grid-template-columns: 1fr auto; gap: 8px; align-items:center; background: rgba(14,24,44,.5); }
    .wallet .name { font-weight: 750; font-size: 14px; }
    .wallet .balance { font-variant-numeric: tabular-nums; background: rgba(21,199,182,.08); border:1px solid rgba(21,199,182,.24); padding: 4px 8px; border-radius: 999px; font-size: 12px; }

    .history-tools { display:flex; gap: 8px; align-items:center; margin-bottom: 8px; flex-wrap: wrap; }
    .table { width: 100%; border-collapse: separate; border-spacing: 0; overflow: auto; display:block; border: 1px solid rgba(96,249,255,.08); border-radius: 10px; background: rgba(13,22,40,.4); }
    .table thead { position: sticky; top: 0; backdrop-filter: blur(8px); background: rgba(15,23,42,.75); }
    .table th, .table td { padding: 8px 10px; text-align: left; border-bottom: 1px solid rgba(96,239,255,.06); white-space: nowrap; }
    .table td.memo { white-space: normal; }
    .pill { padding: 4px 8px; border-radius:999px; font-weight: 700; font-size: 12px; background: rgba(21,199,182,.12); border:1px solid rgba(21,199,182,.32); }
    .amount { font-variant-numeric: tabular-nums; font-weight: 800; }

    .toolbar { display:flex; gap: 8px; flex-wrap: wrap; }

    .toast { position: fixed; right: 12px; bottom: 12px; display:grid; gap:6px; z-index: 60; }
    .toast .msg { padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(96,239,255,.2); background: rgba(17,27,48,.9); box-shadow: var(--shadow); font-size: 13px; }

    .tabbar { display:flex; gap:6px; flex-wrap:wrap; }
    .tabbar .tab { padding:6px 10px; border:1px solid rgba(96,239,255,.2); border-radius:999px; background: rgba(15,25,46,.6); cursor:pointer; font-size: 13px; }
    .tabbar .tab.active { border-color: rgba(96,239,255,.45); background: rgba(21,199,182,.1); }

    .subtabs { display:flex; gap:6px; margin-bottom:6px; flex-wrap: wrap; }
    .subtabs .sub { padding:5px 8px; border:1px solid rgba(96,239,255,.2); border-radius:999px; cursor:pointer; background: rgba(15,25,46,.6); font-size:12px; }
    .subtabs .sub.active { border-color: rgba(96,239,255,.45); background: rgba(21,199,182,.1); }

    .panel { border:1px solid rgba(96,239,255,.12); border-radius:10px; padding:10px; background: rgba(12,22,40,.5); }

    .banner { border:1px dashed rgba(245,158,11,.5); background: rgba(245,158,11,.08); border-radius:10px; padding:8px; display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
    .banner .txt { font-size: 13px; }
    .banner .actions { display:flex; gap:6px; }

  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="logo">
        <div class="logo-badge"></div>
        trpgÈØñ „Éà„Éº„ÇØ„É≥
        <span class="chip">„É≠„Éº„Ç´„É´‰øùÂ≠ò & „É´„Éº„É†ÂêåÊúü</span>
      </div>
      <div class="toolbar">
        <div id="userBadge" class="chip">Êú™„É≠„Ç∞„Ç§„É≥</div>
        <div id="actingBadge" class="chip" title="„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„ÉàÊìç‰Ωú„ÅÆ‰ª£ÁêÜ‰∫∫" style="display:none;">acting: ‚Äî</div>
        <div id="streakBadge" class="chip" title="ÊúùÊ¥ª„Çπ„Éà„É™„Éº„ÇØ">üî•0</div>
        <div id="jackpotBadge" class="chip" title="TRPG„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„Éà">JPOT: 0</div>
        <button class="btn" id="morningBtn" title="ÊúùÊ¥ª„Éú„Éº„Éä„ÇπÔºö7:30„Åæ„Åß„Å´Êäº„Åô„Å®1Êó•1Âõû">ÊúùÊ¥ª</button>
        <button class="btn secondary" id="exportBtn">„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
        <label class="btn secondary" for="importFile">„Ç§„É≥„Éù„Éº„Éà<input type="file" id="importFile" accept="application/json" style="display:none" /></label>
      </div>
    </div>
  </header>

  <main>
    <div class="grid">
      <section class="card" aria-label="„Ç¢„Ç´„Ç¶„É≥„Éà">
        <div class="hd"><h3>„Ç¢„Ç´„Ç¶„É≥„Éà & ÂêåÊúü</h3></div>
        <div class="bd">
          <div class="stat" id="summary">
            <div class="kpi"><div class="lbl">Á∑è„É¶„Éº„Ç∂„ÉºÔºàJPOTÈô§Â§ñÔºâ</div><div class="val" id="kpiMembers">0</div></div>
            <div class="kpi"><div class="lbl">Á∑è‰æõÁµ¶Èáè</div><div class="val" id="kpiSupply">0 coin</div></div>
          </div>

          <div class="row panel" style="margin-bottom:8px;">
            <label>ÂêåÊúüË®≠ÂÆöÔºàCloudflare Workers „ÅÆ WSSÔºâ</label>
            <input id="syncUrl" type="text" placeholder="wss://<your-worker>.<subdomain>.workers.dev/ws" />
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
              <input id="syncRoom" type="text" placeholder="„É´„Éº„É†ÂêçÔºà‰æãÔºötrpg-guildÔºâ" />
              <input id="syncKey" type="text" placeholder="„É´„Éº„É†ÈçµÔºàÂèãÈÅî„Å†„Åë„ÅßÂÖ±ÊúâÔºâ" />
            </div>
            <div class="toolbar">
              <button class="btn" id="btnConnect">Êé•Á∂ö</button>
              <button class="btn secondary" id="btnDisconnect">ÂàáÊñ≠</button>
              <button class="btn warn" id="btnBroadcast">„ÅÑ„Åæ„ÅÆÁä∂ÊÖã„ÇíÈÄÅ‰ø°</button>
              <span id="syncStatus" class="chip">Êú™Êé•Á∂ö</span>
            </div>
          </div>

          <div class="row" style="margin-bottom:8px;">
            <div class="row panel">
              <label for="loginName">„É≠„Ç∞„Ç§„É≥</label>
              <input id="loginName" type="text" placeholder="„É¶„Éº„Ç∂„ÉºÂêçÔºà„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„Éà„ÅØ„Éë„Çπ‰∏çË¶ÅÔºâ" />
              <input id="loginPass" type="password" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" />
              <div class="toolbar">
                <button class="btn" id="loginBtn">„É≠„Ç∞„Ç§„É≥</button>
                <button class="btn secondary" id="logoutBtn">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
              </div>
            </div>
            <div class="row panel">
              <label for="regName">Êñ∞Ë¶èÁôªÈå≤ÔºàÂàùÊúüÊÆãÈ´ò 10,000 coinÔºâ</label>
              <input id="regName" type="text" placeholder="„É¶„Éº„Ç∂„ÉºÂêçÔºàÈáçË§á‰∏çÂèØÔºâ" />
              <input id="regPass" type="password" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" />
              <button class="btn" id="registerBtn">ÁôªÈå≤</button>
            </div>
          </div>

          <div class="row panel">
            <label>„Ç¶„Ç©„É¨„ÉÉ„Éà‰∏ÄË¶ß</label>
            <div class="wallet-list" id="walletList" aria-live="polite"></div>
          </div>
        </div>
      </section>

      <section class="card" aria-label="Êìç‰Ωú">
        <div class="hd">
          <h3>Êìç‰Ωú</h3>
          <div class="tabbar">
            <div class="tab active" data-tab="transfer">ÈÄÅÈáë</div>
            <div class="tab" data-tab="market">„Éû„Éº„Ç±„ÉÉ„Éà</div>
            <div class="tab" data-tab="myrights">Ëá™ÂàÜ„ÅÆÊ®©Âà©</div>
            <div class="tab" data-tab="gamble">„ÇÆ„É£„É≥„Éñ„É´</div>
          </div>
        </div>
        <div class="bd">

          <div id="approvalBanner" class="banner" style="display:none;">
            <div class="txt" id="approvalText">‚Äî</div>
            <div class="actions" id="approvalActions">
              <button class="btn secondary" id="btnReject">ÊãíÂê¶</button>
              <button class="btn" id="btnApprove">Ë®±ÂèØ</button>
            </div>
          </div>

          <div id="rightReqBanner" class="banner" style="display:none;">
            <div class="txt" id="rightReqText">‚Äî</div>
            <div class="actions" id="rightReqActions">
              <button class="btn secondary" id="btnRightCancel">„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã</button>
              <button class="btn" id="btnRightExec">ÂÆüË°å</button>
            </div>
          </div>

          <div id="tab-transfer">
            <div class="row" style="grid-template-columns: 1fr 1fr; display:grid; gap:10px;">
              <div class="row">
                <label>ÈÄÅ‰ø°ÂÖÉÔºà„ÅÇ„Å™„ÅüÔºâ</label>
                <input id="fromFixed" type="text" disabled placeholder="Êú™„É≠„Ç∞„Ç§„É≥" />
              </div>
              <div class="row">
                <label for="toSelect">ÈÄÅ‰ø°ÂÖà</label>
                <select id="toSelect"></select>
              </div>
            </div>
            <div class="row" style="margin-top:8px; grid-template-columns: 1fr 140px; display:grid; gap:10px;">
              <div class="row">
                <label for="amountInput">ÈáëÈ°çÔºàcoinÔºâ</label>
                <input id="amountInput" type="number" min="1" step="1" placeholder="‰æãÔºâ250" />
              </div>
              <div class="row">
                <label>&nbsp;</label>
                <button class="btn" id="sendBtn">ÈÄÅ‰ø°„Åô„Çã</button>
              </div>
            </div>
            <div class="row" style="margin-top:8px;">
              <label for="memoInput">„É°„É¢Ôºà‰ªªÊÑèÔºâ</label>
              <input id="memoInput" type="text" placeholder="‰æãÔºâ„ÇÆ„É´„ÉâË≥ûÈáë" />
            </div>
          </div>

          <div id="tab-market" style="display:none;">
            <div class="subtabs">
              <div class="sub active" data-sub="sell">Âá∫ÂìÅ„Åô„Çã</div>
              <div class="sub" data-sub="list">Âá∫ÂìÅ‰∏ÄË¶ß</div>
            </div>
            <div id="market-sell">
              <div class="row panel">
                <label>Ê®©Âà©„ÅÆÂá∫ÂìÅÔºàË≤©Â£≤ËÄÖÔºâ</label>
                <input id="listTitle" type="text" placeholder="‰æãÔºâ„Ç≤„Éº„É†„Çí‰∏ÄÁ∑í„Å´ÈÅä„Å∂" />
                <textarea id="listDesc" rows="2" placeholder="Ë™¨ÊòéÔºà‰ªªÊÑèÔºâ"></textarea>
                <div style="display:grid; grid-template-columns: 1fr 1fr 140px; gap:8px;">
                  <div class="row">
                    <label for="listPrice">‰æ°Ê†ºÔºàcoinÔºâ</label>
                    <input id="listPrice" type="number" min="1" step="1" placeholder="‰æãÔºâ1000" />
                  </div>
                  <div class="row">
                    <label for="listQty">Âú®Â∫´ÔºàÂÄãÊï∞Ôºâ</label>
                    <input id="listQty" type="number" min="1" step="1" placeholder="‰æãÔºâ5" />
                  </div>
                  <div class="row">
                    <label>&nbsp;</label>
                    <button class="btn" id="createListingBtn">Âá∫ÂìÅ„Åô„Çã</button>
                  </div>
                </div>
              </div>
            </div>
            <div id="market-list" style="display:none;">
              <div class="row">
                <label>Âá∫ÂìÅ‰∏ÄË¶ß</label>
                <div class="table" role="region" aria-label="Âá∫ÂìÅ‰∏ÄË¶ß">
                  <table style="min-width:860px; width:100%;">
                    <thead>
                      <tr>
                        <th>„Çø„Ç§„Éà„É´</th>
                        <th>‰æ°Ê†º</th>
                        <th>Âú®Â∫´</th>
                        <th>Âá∫ÂìÅËÄÖ</th>
                        <th>Ë™¨Êòé</th>
                        <th>Êìç‰Ωú</th>
                      </tr>
                    </thead>
                    <tbody id="listingBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div id="tab-myrights" style="display:none;">
            <div class="row">
              <label>Ëá™ÂàÜ„Åå‰øùÊúâ„Åô„ÇãÊ®©Âà©</label>
              <div class="table" role="region" aria-label="Ëá™ÂàÜ„ÅÆÊ®©Âà©">
                <table style="min-width:860px; width:100%;">
                  <thead>
                    <tr>
                      <th>Êó•‰ªò</th>
                      <th>„Çø„Ç§„Éà„É´</th>
                      <th>Ë≤©Â£≤ËÄÖ</th>
                      <th>Áä∂ÊÖã</th>
                      <th>Êìç‰Ωú</th>
                    </tr>
                  </thead>
                  <tbody id="rightsBody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div id="tab-gamble" style="display:none;">
            <div class="row panel">
              <label>TRPG„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„ÉàÔºà„É¶„Éº„Ç∂„ÉºÊÆãÈ´òÔºâ</label>
              <div class="toolbar">
                <div class="chip" id="jackpotChip">ÁèæÂú®: 0 coin</div>
              </div>
            </div>
            <div class="row panel">
              <h4 style="margin:0;">üé∞ „É´„Éº„É¨„ÉÉ„ÉàÔºà1Âõû100 coinÔºâ</h4>
              <p style="margin:0; color:var(--muted); font-size:12px;">ÊúüÂæÖÂÄ§„ÅØÁ¥Ñ70%„ÄÇ1%„Åß<strong>„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„ÉàÂÖ®È°ç</strong>„ÄÇÂèÇÂä†Ë≤ª„ÅØJPOT„Å´Âä†ÁÆó„ÄÅÊâï„ÅÑÂá∫„Åó„ÅØJPOT„Åã„Çâ„ÄÇ</p>
              <div class="toolbar">
                <button class="btn" id="rouletteBtn">Âõû„Åô</button>
              </div>
              <div id="rouletteResult" class="chip" style="margin-top:8px;">ÁµêÊûú: ‚Äî</div>
            </div>
          </div>
        </div>
      </section>

      <section class="card" aria-label="Â±•Ê≠¥">
        <div class="hd">
          <h3>Â±•Ê≠¥</h3>
          <div class="history-tools">
            <input id="searchInput" type="text" placeholder="Ê§úÁ¥¢ÔºöÂêçÂâç / „É°„É¢ / Ê®©Âà©" style="width:200px" />
            <select id="memberFilter"><option value="">„Åô„Åπ„Å¶</option></select>
            <div id="lastActivity" class="chip">ÊúÄÁµÇÊõ¥Êñ∞Ôºö‚Äî</div>
          </div>
        </div>
        <div class="bd">
          <div class="table" role="region" aria-label="Â±•Ê≠¥„ÉÜ„Éº„Éñ„É´">
            <table style="min-width:760px; width:100%;">
              <thead>
                <tr>
                  <th>Êó•‰ªò</th>
                  <th>Á®ÆÂà•</th>
                  <th>ÈÄÅ‰ø°ÂÖÉ / Ë≤©Â£≤ËÄÖ</th>
                  <th>ÈÄÅ‰ø°ÂÖà / Ë≥ºÂÖ•ËÄÖ</th>
                  <th>„É°„É¢ / Ê®©Âà©</th>
                  <th style="text-align:right;">ÈáëÈ°ç</th>
                </tr>
              </thead>
              <tbody id="historyBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>

  <div class="toast" id="toast" aria-live="polite"></div>

  <script>
  (function(){
    const LS_KEY = 'trpg_token_state_v12_cfws';
    const LS_SYNC = 'trpg_token_sync_settings';
    const INITIAL_BAL = 10000;
    const JACKPOT_NAME = '„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„Éà';

    let state = { users: [], txs: [], listings: [], rights: [], currentUserId: null, jackpotUserId: '', lastRealUserId: null, approval:{active:false, votes:{}}, version: 12, vTick: 0 };

    const sync = {
      ws: null,
      clientId: (localStorage.getItem('trpg_token_client_id') || Math.random().toString(36).slice(2)),
      url: '', room: '', key: '',
      connected: false,
      saveSettings(){ const s = { url: sync.url, room: sync.room, key: sync.key }; localStorage.setItem(LS_SYNC, JSON.stringify(s)); },
      loadSettings(){ try { const raw = localStorage.getItem(LS_SYNC); if(raw){ const s=JSON.parse(raw); sync.url=s.url||''; sync.room=s.room||''; sync.key=s.key||''; } } catch(e){}; els.syncUrl.value = sync.url; els.syncRoom.value = sync.room; els.syncKey.value = sync.key; },
      connect(){
        if(sync.connected){ toast('„Åô„Åß„Å´Êé•Á∂ö‰∏≠'); return; }
        sync.url = (els.syncUrl.value||'').trim();
        sync.room = (els.syncRoom.value||'').trim();
        sync.key = (els.syncKey.value||'').trim();
        if(!sync.url || !sync.room || !sync.key){ toast('URL / „É´„Éº„É† / Èçµ „ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
        try { sync.ws = new WebSocket(sync.url.replace(/^http/, 'ws')); } catch(e){ toast('URL„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
        sync.saveSettings();
        els.syncStatus.textContent = 'Êé•Á∂ö‰∏≠‚Ä¶';
        sync.ws.onopen = () => {
          sync.connected = true;
          els.syncStatus.textContent = 'Êé•Á∂öÊ∏à„Åø';
          sync.ws.send(JSON.stringify({ type:'join', room: sync.room, key: sync.key, cid: sync.clientId }));
          setTimeout(()=>{ sync.send({ type:'app', action:'hello', cid: sync.clientId }); }, 300);
        };
        sync.ws.onmessage = (ev) => {
          let msg={}; try{ msg=JSON.parse(ev.data); }catch{};
          if(msg.type==='app'){
            if(msg.cid && msg.cid===sync.clientId) return;
            if(msg.action==='hello'){ setTimeout(()=>{ sync.broadcastState(); }, 300); }
            if(msg.action==='state' && msg.state){
              if(typeof msg.state.vTick === 'number' && msg.state.vTick > (state.vTick||0)){
                state = msg.state;
                state.currentUserId = localStorage.getItem('last_current_uid') || null;
                save(true); renderAll(); toast('ÂêåÊúüÔºöÊúÄÊñ∞Áä∂ÊÖã„ÇíÂèó‰ø°„Åó„Åæ„Åó„Åü');
              }
            }
          }
        };
        sync.ws.onclose = () => { sync.connected=false; els.syncStatus.textContent='Êú™Êé•Á∂ö'; };
        sync.ws.onerror = () => { sync.connected=false; els.syncStatus.textContent='Êú™Êé•Á∂öÔºà„Ç®„É©„ÉºÔºâ'; };
      },
      disconnect(){ if(sync.ws){ try{ sync.ws.close(); }catch{} } sync.connected=false; els.syncStatus.textContent='Êú™Êé•Á∂ö'; toast('ÂàáÊñ≠„Åó„Åæ„Åó„Åü'); },
      send(obj){ if(!sync.connected || !sync.ws) return; try { sync.ws.send(JSON.stringify(obj)); } catch(e){} },
      broadcastState(){ const tmp = Object.assign({}, state, { currentUserId: null }); sync.send({ type:'app', action:'state', cid: sync.clientId, state: tmp }); }
    };
    localStorage.setItem('trpg_token_client_id', sync.clientId);

    const els = {
      kpiMembers: document.getElementById('kpiMembers'),
      kpiSupply: document.getElementById('kpiSupply'),
      walletList: document.getElementById('walletList'),
      toSelect: document.getElementById('toSelect'),
      sendBtn: document.getElementById('sendBtn'),
      amountInput: document.getElementById('amountInput'),
      memoInput: document.getElementById('memoInput'),
      historyBody: document.getElementById('historyBody'),
      searchInput: document.getElementById('searchInput'),
      memberFilter: document.getElementById('memberFilter'),
      exportBtn: document.getElementById('exportBtn'),
      importFile: document.getElementById('importFile'),
      lastActivity: document.getElementById('lastActivity'),
      toast: document.getElementById('toast'),
      userBadge: document.getElementById('userBadge'),
      actingBadge: document.getElementById('actingBadge'),
      fromFixed: document.getElementById('fromFixed'),
      streakBadge: document.getElementById('streakBadge'),
      jackpotBadge: document.getElementById('jackpotBadge'),
      morningBtn: document.getElementById('morningBtn'),
      loginName: document.getElementById('loginName'),
      loginPass: document.getElementById('loginPass'),
      loginBtn: document.getElementById('loginBtn'),
      logoutBtn: document.getElementById('logoutBtn'),
      regName: document.getElementById('regName'),
      regPass: document.getElementById('regPass'),
      registerBtn: document.getElementById('registerBtn'),
      tabs: Array.from(document.querySelectorAll('.tabbar .tab')),
      tabTransfer: document.getElementById('tab-transfer'),
      tabMarket: document.getElementById('tab-market'),
      tabMyRights: document.getElementById('tab-myrights'),
      tabGamble: document.getElementById('tab-gamble'),
      listTitle: document.getElementById('listTitle'),
      listDesc: document.getElementById('listDesc'),
      listPrice: document.getElementById('listPrice'),
      listQty: document.getElementById('listQty'),
      createListingBtn: document.getElementById('createListingBtn'),
      listingBody: document.getElementById('listingBody'),
      rightsBody: document.getElementById('rightsBody'),
      subtabs: Array.from(document.querySelectorAll('#tab-market .subtabs .sub')),
      marketSell: document.getElementById('market-sell'),
      marketList: document.getElementById('market-list'),
      jackpotChip: document.getElementById('jackpotChip'),
      rouletteBtn: document.getElementById('rouletteBtn'),
      rouletteResult: document.getElementById('rouletteResult'),
      approvalBanner: document.getElementById('approvalBanner'),
      approvalText: document.getElementById('approvalText'),
      approvalActions: document.getElementById('approvalActions'),
      btnApprove: document.getElementById('btnApprove'),
      btnReject: document.getElementById('btnReject'),
      rightReqBanner: document.getElementById('rightReqBanner'),
      rightReqText: document.getElementById('rightReqText'),
      rightReqActions: document.getElementById('rightReqActions'),
      btnRightExec: document.getElementById('btnRightExec'),
      btnRightCancel: document.getElementById('btnRightCancel'),
      syncUrl: document.getElementById('syncUrl'),
      syncRoom: document.getElementById('syncRoom'),
      syncKey: document.getElementById('syncKey'),
      btnConnect: document.getElementById('btnConnect'),
      btnDisconnect: document.getElementById('btnDisconnect'),
      btnBroadcast: document.getElementById('btnBroadcast'),
      syncStatus: document.getElementById('syncStatus'),
    };

    const fmt = new Intl.NumberFormat('ja-JP');
    const coins = n => `${fmt.format(n)} coin`;
    const ts2str = ts => { const d = new Date(ts); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; };
    const id = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const escapeHtml = (s)=> String(s).replace(/[&<>\"']/g, (c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    const pill = (txt)=> `<span class="pill">${escapeHtml(txt)}</span>`;

    function save(skipBroadcast){ localStorage.setItem(LS_KEY, JSON.stringify(state)); if(!skipBroadcast){ syncDebounced(); } }
    function load(){ try { const raw = localStorage.getItem(LS_KEY); if(raw){ state = JSON.parse(raw); } } catch(e){}; if(typeof state.vTick!=='number') state.vTick=0; }

    function toast(msg){
      const div = document.createElement('div'); div.className = 'msg'; div.textContent = msg; els.toast.appendChild(div);
      setTimeout(()=>{ div.style.opacity = '0'; div.style.transform = 'translateY(4px)'; }, 2400);
      setTimeout(()=>{ div.remove(); }, 3000);
    }

    async function sha256(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    function findUserById(uid){ return state.users.find(u=>u.id===uid)||null; }
    function findUserByName(name){ return state.users.find(u=>u.name===name)||null; }
    function jackpotUser(){ return findUserById(state.jackpotUserId); }
    function isJackpot(u){ return u && u.id===state.jackpotUserId; }
    function nameOf(uid){ const u=findUserById(uid); return u?u.name:''; }

    function ensureJackpotUser(){
      let j = findUserByName(JACKPOT_NAME);
      if(!j){ j = { id: id(), name: JACKPOT_NAME, passHash: '', balance: 0, streakCount: 0, lastMorningDate: '' }; state.users.unshift(j); }
      state.jackpotUserId = j.id;
    }

    async function register(name, pass){
      name = (name||'').trim();
      if(!name || !pass){ toast('„É¶„Éº„Ç∂„ÉºÂêç„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ'); return; }
      if(name===JACKPOT_NAME){ toast('„Åì„ÅÆÂêçÂâç„ÅØ‰∫àÁ¥Ñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô'); return; }
      if(state.users.some(u=>u.name===name)){ toast('„Åù„ÅÆ„É¶„Éº„Ç∂„ÉºÂêç„ÅØ‰ΩøÁî®Ê∏à„Åø'); return; }
      const passHash = await sha256(pass);
      const u = { id: id(), name, passHash, balance: 10000, streakCount: 0, lastMorningDate: '' };
      state.users.push(u);
      state.currentUserId = u.id; state.lastRealUserId = u.id;
      addTx({ type:'mint', to:u.id, amount:10000, memo:'ÂàùÊúüÁô∫Ë°å' });
      bump(); save(); renderAll(); toast(`ÁôªÈå≤ÂÆå‰∫ÜÔºö${name}`);
    }

    async function login(name, pass){
      name = (name||'').trim();
      let u = findUserByName(name);
      if(!u){ toast('„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì'); return; }
      if(isJackpot(u)){ state.currentUserId = u.id; }
      else {
        const passHash = await sha256(pass||'');
        if(u.passHash !== passHash){ toast('„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô'); return; }
        state.currentUserId = u.id; state.lastRealUserId = u.id;
      }
      localStorage.setItem('last_current_uid', state.currentUserId || '');
      save(true); renderAll(); toast(`„É≠„Ç∞„Ç§„É≥Ôºö${u.name}`);
    }

    function logout(){ state.currentUserId = null; localStorage.setItem('last_current_uid',''); save(true); renderAll(); toast('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü'); }
    function currentUser(){ return findUserById(state.currentUserId); }

    function addTx(obj){
      const now = Date.now(); const base = { id:id(), ts: now };
      const me = currentUser(); const actedBy = (me && isJackpot(me) && state.lastRealUserId) ? state.lastRealUserId : null;
      if(actedBy) obj.actedBy = actedBy;
      state.txs.unshift(Object.assign(base, obj));
    }
    function bump(){ state.vTick = (state.vTick||0) + 1; }

    function startApproval(toId, amount, memo){
      const j = jackpotUser();
      if(!j) { toast('JPOT„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì'); return; }
      if(j.balance < amount){ toast('„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„ÉàÊÆãÈ´ò„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô'); return; }
      state.approval = { active:true, toId, amount, memo:(memo||'').trim(), votes:{}, ts: Date.now() };
      bump(); save(); renderAll();
      toast(`ÊâøË™ç‰æùÈ†ºÔºö${nameOf(j.id)} ‚Üí ${nameOf(toId)} „Å´ ${fmt.format(amount)} coin`);
    }

    function approve(agree){
      const me = currentUser(); if(!me){ toast('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô'); return; }
      if(isJackpot(me)){ toast('„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„Éà„ÅØÊäïÁ•®„Åß„Åç„Åæ„Åõ„Çì'); return; }
      if(!state.approval.active){ toast('ÊâøË™ç‰æùÈ†º„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
      state.approval.votes[me.id] = agree ? 'approve' : 'reject';
      bump(); save(); renderApprovalBanner(true);
      checkApproval();
    }

    function cancelApproval(){
      const me=currentUser();
      if(!me || !isJackpot(me)) return;
      if(!state.approval.active) return;
      state.approval = {active:false, votes:{}};
      bump(); save(); renderAll(); toast('ÊâøË™ç‰æùÈ†º„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åó„Åü');
    }

    function checkApproval(){
      const totalVoters = state.users.filter(u=>!isJackpot(u)).map(u=>u.id);
      const votes = state.approval.votes || {};
      if(Object.values(votes).includes('reject')){
        state.approval = {active:false, votes:{}};
        bump(); save(); renderAll(); toast('ÊâøË™çÔºöÊãíÂê¶„Åå„ÅÇ„Å£„Åü„Åü„ÇÅ„Ç≠„É£„É≥„Çª„É´');
        return;
      }
      const allApproved = totalVoters.every(uid => votes[uid] === 'approve');
      if(!allApproved){ bump(); save(); renderAll(); return; }
      const j = jackpotUser();
      const to = findUserById(state.approval.toId);
      const amt = state.approval.amount||0;
      if(!j || !to){ state.approval={active:false, votes:{}}; bump(); save(); renderAll(); return; }
      if(j.balance < amt){ state.approval={active:false, votes:{}}; bump(); save(); renderAll(); return; }
      j.balance -= amt; to.balance += amt;
      addTx({ type:'transfer', from: j.id, to: to.id, amount: amt, memo: `ÔºàÂÖ®Âì°ÊâøË™çÈÄÅÈáëÔºâ${state.approval.memo||''}` });
      state.approval = {active:false, votes:{}};
      bump(); save(); renderAll(); toast(`ÂÖ®Âì°ÊâøË™ç ‚Üí ÈÄÅÈáëÂÆüË°åÔºö${nameOf(j.id)} ‚Üí ${nameOf(to.id)} ${fmt.format(amt)} coin`);
    }

    function transfer(toId, amount, memo){
      const from = currentUser();
      if(!from){ toast('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô'); return; }
      amount = Math.floor(Number(amount));
      if(!(amount > 0)) { toast('ÈáëÈ°ç„ÅØ1‰ª•‰∏ä„ÅÆÊï¥Êï∞„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
      if(!toId){ toast('ÈÄÅ‰ø°ÂÖà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
      const to = findUserById(toId);
      if(!to){ toast('ÈÄÅ‰ø°ÂÖà„Åå‰∏çÊ≠£„Åß„Åô'); return; }
      if(from.id === toId){ toast('Ëá™ÂàÜËá™Ë∫´„Å∏„ÅØÈÄÅ‰ø°„Åß„Åç„Åæ„Åõ„Çì'); return; }

      if(isJackpot(from)){
        if(isJackpot(to)){ toast('„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„Éà„Å∏„ÅØÈÄÅÈáë„Åß„Åç„Åæ„Åõ„Çì'); return; }
        startApproval(toId, amount, memo); return;
      }
      if(isJackpot(to)){ toast('„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„Éà„Å∏„ÅØÁõ¥Êé•ÈÄÅÈáë„Åß„Åç„Åæ„Åõ„ÇìÔºàÊâãÊï∞Êñô„Éª„ÇÆ„É£„É≥„Éñ„É´„ÅÆ„ÅøÔºâ'); return; }

      if(from.balance < amount){ toast('ÊÆãÈ´ò„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô'); return; }
      from.balance -= amount; to.balance += amount;
      addTx({ type:'transfer', from: from.id, to: to.id, amount, memo: (memo||'').trim() });
      bump(); save(); renderAll(); toast(`${from.name} ‚Üí ${to.name} „Å´ ${fmt.format(amount)} coin ÈÄÅ‰ø°„Åó„Åæ„Åó„Åü`);
    }

    function exportJSON(){
      const blob = new Blob([JSON.stringify(state, null, 2)], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `trpg_token_sync_v12_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
      a.click(); URL.revokeObjectURL(a.href);
    }

    function importJSON(file){
      const reader = new FileReader();
      reader.onload = (e)=>{
        try { const data = JSON.parse(e.target.result);
          if(!data || !Array.isArray(data.users) || !Array.isArray(data.txs)) throw new Error('‰∏çÊ≠£„Å™ÂΩ¢Âºè');
          const keepUid = state.currentUserId;
          state = Object.assign({version:12, approval:{active:false, votes:{}}, lastRealUserId: null, vTick:(state.vTick||0)+1}, data);
          state.currentUserId = keepUid || null;
          ensureJackpotUser();
          state.listings.forEach(l=>{ if(typeof l.qty!=='number') l.qty=1; if(typeof l.sold!=='number') l.sold=0; });
          state.rights.forEach(r=>{ if(!r.status){ r.status = r.executed? 'finalized':'owned'; } });
          save(); renderAll(); toast('„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü');
        } catch(err){ toast('Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'); }
      };
      reader.readAsText(file);
    }

    function createListing(title, price, desc){
      const seller = currentUser();
      if(!seller){ toast('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô'); return; }
      if(isJackpot(seller)){ toast('„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„Éà„Åß„ÅØÂá∫ÂìÅ„Åß„Åç„Åæ„Åõ„Çì'); return; }
      title = (title||'').trim(); desc = (desc||'').trim(); price = Math.floor(Number(price));
      let qty = Math.floor(Number(els.listQty.value||1));
      if(!title){ toast('„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
      if(!(price>0)){ toast('‰æ°Ê†º„ÅØ1‰ª•‰∏ä„ÅÆÊï¥Êï∞'); return; }
      if(!(qty>0)){ toast('Âú®Â∫´„ÅØ1‰ª•‰∏ä„ÅÆÊï¥Êï∞'); return; }
      const listing = { id:id(), title, price, desc, sellerId: seller.id, active:true, ts: Date.now(), qty, sold: 0 };
      state.listings.unshift(listing);
      bump(); save(); renderAll(); toast('Âá∫ÂìÅ„Åó„Åæ„Åó„Åü');
      els.listTitle.value=''; els.listDesc.value=''; els.listPrice.value=''; els.listQty.value='';
      switchMarketSub('list');
    }

    function buyListing(listingId){
      const buyer = currentUser(); if(!buyer){ toast('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô'); return; }
      const l = state.listings.find(x=>x.id===listingId && x.active);
      if(!l){ toast('Âá∫ÂìÅ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì'); return; }
      if(l.sellerId === buyer.id){ toast('Ëá™ÂàÜ„ÅÆÂá∫ÂìÅ„ÅØË≥ºÂÖ•„Åß„Åç„Åæ„Åõ„Çì'); return; }
      if(isJackpot(buyer)){ toast('„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„Éà„Åß„ÅØË≥ºÂÖ•„Åß„Åç„Åæ„Åõ„Çì'); return; }
      const remaining = (l.qty||1) - (l.sold||0);
      if(remaining<=0){ toast('Âú®Â∫´Âàá„Çå'); l.active=false; bump(); save(); renderAll(); return; }
      if(buyer.balance < l.price){ toast('ÊÆãÈ´ò‰∏çË∂≥'); return; }
      const seller = findUserById(l.sellerId); if(!seller){ toast('Ë≤©Â£≤ËÄÖ„Åå‰∏çÊòé'); return; }

      const fee = Math.floor(l.price * 0.10);
      const sellerReceive = l.price - fee;
      const j = jackpotUser(); if(!j){ toast('JPOT„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì'); return; }

      buyer.balance -= l.price; seller.balance += sellerReceive; j.balance += fee;

      const right = { id:id(), listingId: l.id, title: l.title, buyerId: buyer.id, sellerId: seller.id, ts: Date.now(), status:'owned', executed:false };
      state.rights.unshift(right);

      l.sold = (l.sold||0) + 1;
      if(l.sold >= l.qty){ l.active = false; }

      addTx({ type:'purchase', from: buyer.id, to: seller.id, amount: l.price, listingId:l.id, title:l.title, memo:`Ê®©Âà©Ë≥ºÂÖ•ÔºàÊâãÊï∞Êñô10%Ôºâ` });
      addTx({ type:'fee', from: seller.id, to: j.id, amount: fee, listingId:l.id, title:l.title, memo:'Ë≤©Â£≤ÊâãÊï∞Êñô' });

      bump(); save(); renderAll(); toast(`Ë≥ºÂÖ•Ôºö${l.title}ÔºàÊÆã„ÇäÂú®Â∫´ ${l.qty - l.sold}Ôºâ`);
    }

    function deleteListing(listingId){
      const me = currentUser(); if(!me){ toast('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô'); return; }
      const idx = state.listings.findIndex(x=>x.id===listingId);
      if(idx<0){ toast('Âá∫ÂìÅ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì'); return; }
      const l = state.listings[idx];
      if(l.sellerId !== me.id){ toast('Ëá™ÂàÜ„ÅÆÂá∫ÂìÅ„ÅÆ„ÅøÂâäÈô§ÂèØËÉΩ'); return; }
      if((l.sold||0) > 0){ toast('Ë≥ºÂÖ•Â±•Ê≠¥„Åå„ÅÇ„Çã„Åü„ÇÅÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì'); return; }
      if(!confirm('„Åì„ÅÆÂá∫ÂìÅ„ÇíÂÆåÂÖ®„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
      state.listings.splice(idx,1);
      bump(); save(); renderAll(); toast('Âá∫ÂìÅ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
    }

    function toggleListingActive(listingId){
      const me = currentUser(); if(!me){ toast('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô'); return; }
      const l = state.listings.find(x=>x.id===listingId);
      if(!l){ toast('Âá∫ÂìÅ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì'); return; }
      if(l.sellerId !== me.id){ toast('Ëá™ÂàÜ„ÅÆÂá∫ÂìÅ„ÅÆ„ÅøÊìç‰ΩúÂèØËÉΩ'); return; }
      l.active = !l.active; bump(); save(); renderAll(); toast(l.active?'Âá∫ÂìÅ„ÇíÂÖ¨Èñã„Åó„Åæ„Åó„Åü':'Âá∫ÂìÅ„ÇíÂÅúÊ≠¢„Åó„Åæ„Åó„Åü');
    }

    function buyerRequest(rightId){
      const me=currentUser(); if(!me){ toast('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å'); return; }
      const r = state.rights.find(x=>x.id===rightId); if(!r) return;
      if(r.buyerId!==me.id){ toast('Ëá™ÂàÜ„ÅÆÊ®©Âà©„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
      if(r.status!=='owned'){ toast('„Åì„ÅÆÊ®©Âà©„ÅØÁî≥Ë´ãÊ∏à„Åø„Åß„Åô'); return; }
      r.status='request';
      addTx({type:'execute-request', from:r.buyerId, to:r.sellerId, listingId:r.listingId, title:r.title, memo:'ÂÆüË°åÁî≥Ë´ã'});
      bump(); save(); renderAll(); toast('ÂÆüË°å„ÇíÁî≥Ë´ã„Åó„Åæ„Åó„ÅüÔºàË≤©Â£≤ËÄÖ„Å´ÈÄöÁü•Ôºâ');
    }

    function buyerReturn(rightId){
      const me=currentUser(); if(!me){ toast('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å'); return; }
      const r = state.rights.find(x=>x.id===rightId); if(!r) return;
      if(r.buyerId!==me.id || r.status!=='owned'){ toast('‰øùÊúâ‰∏≠„ÅÆËá™ÂàÜ„ÅÆÊ®©Âà©„ÅÆ„ÅøËøîÂìÅÂèØËÉΩ'); return; }
      const l = state.listings.find(x=>x.id===r.listingId); if(!l){ toast('Âá∫ÂìÅÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì'); return; }
      const seller = findUserById(r.sellerId); if(!seller){ toast('Ë≤©Â£≤ËÄÖ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì'); return; }
      const refund = Math.floor(l.price * 0.90);
      if(seller.balance < refund){ toast('Ë≤©Â£≤ËÄÖ„ÅÆÊÆãÈ´ò„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„ÅôÔºàËøîÂìÅ‰∏çÂèØÔºâ'); return; }

      seller.balance -= refund;
      const buyer = findUserById(r.buyerId); buyer.balance += refund;
      l.sold = Math.max(0, (l.sold||0)-1);
      if(l.sold < l.qty){ l.active = true; }
      state.rights = state.rights.filter(x=>x.id!==rightId);

      addTx({type:'return', from:seller.id, to:buyer.id, listingId:l.id, title:r.title, amount:refund, memo:'Ë≥ºÂÖ•ËÄÖ„ÅåËøîÂìÅÔºàÊâãÊï∞Êñô„ÅØËøî„Çâ„Å™„ÅÑÔºâ'});
      bump(); save(); renderAll(); toast(`ËøîÂìÅÔºö${r.title}ÔºàËøîÈáë ${fmt.format(refund)} coinÔºâ`);
    }

    function sellerRespond(rightId, action){
      const me=currentUser(); if(!me){ toast('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å'); return; }
      const r = state.rights.find(x=>x.id===rightId); if(!r) return;
      if(r.sellerId!==me.id){ toast('„ÅÇ„Å™„Åü„ÅØË≤©Â£≤ËÄÖ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
      if(r.status!=='request'){ toast('„Åì„ÅÆÊ®©Âà©„ÅØÂæÖÊ©ü‰∏≠„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
      const l = state.listings.find(x=>x.id===r.listingId); if(!l){ toast('Âá∫ÂìÅÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì'); return; }
      if(action==='exec'){
        r.status='seller_executed';
        addTx({type:'execute-done', from:r.sellerId, to:r.buyerId, listingId:r.listingId, title:r.title, memo:'Ë≤©Â£≤ËÄÖ„ÅåÂÆüË°å'});
        bump(); save(); renderAll(); toast('ÂÆüË°å„ÇíÂ†±Âëä„Åó„Åæ„Åó„Åü');
      }else{
        const seller = findUserById(r.sellerId);
        if(seller.balance < l.price){ toast('ÊÆãÈ°ç„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô'); return; }
        r.status='seller_cancel_requested';
        addTx({type:'execute-cancel-ask', from:r.sellerId, to:r.buyerId, listingId:r.listingId, title:r.title, memo:'Ë≤©Â£≤ËÄÖ„Åå„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ã'});
        bump(); save(); renderAll(); toast('„Ç≠„É£„É≥„Çª„É´„ÇíÁî≥Ë´ã„Åó„Åæ„Åó„Åü');
      }
    }

    function buyerFinalize(rightId){
      const me=currentUser(); if(!me){ toast('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å'); return; }
      const r = state.rights.find(x=>x.id===rightId); if(!r) return;
      if(r.buyerId!==me.id){ toast('„ÅÇ„Å™„Åü„ÅØË≥ºÂÖ•ËÄÖ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
      const l = state.listings.find(x=>x.id===r.listingId); if(!l){ toast('Âá∫ÂìÅÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì'); return; }
      if(r.status==='seller_executed'){
        r.status='finalized'; r.executed=true;
        addTx({type:'execute-finalize', from:r.buyerId, to:r.sellerId, listingId:r.listingId, title:r.title, memo:'Ë≥ºÂÖ•ËÄÖ„ÅåÂÆüË°åÁ¢∫Ë™çÔºàÁ¢∫ÂÆöÔºâ'});
        bump(); save(); renderAll(); toast('ÂÆüË°å„ÇíÁ¢∫ÂÆö„Åó„Åæ„Åó„Åü');
      } else if(r.status==='seller_cancel_requested'){
        const seller = findUserById(r.sellerId);
        const buyer = findUserById(r.buyerId);
        if(seller.balance < l.price){ toast('Ë≤©Â£≤ËÄÖ„ÅÆÊÆãÈ´ò„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„ÅôÔºàÁ¢∫ÂÆö‰∏çÂèØÔºâ'); return; }
        seller.balance -= l.price; buyer.balance += l.price;
        l.sold = Math.max(0, (l.sold||0)-1); if(l.sold < l.qty){ l.active = true; }
        state.rights = state.rights.filter(x=>x.id!==rightId);
        addTx({type:'execute-cancel-ok', from:r.buyerId, to:r.sellerId, listingId:r.listingId, title:r.title, amount:l.price, memo:'„Ç≠„É£„É≥„Çª„É´ËøîÈáëÔºàÂÖ®È°çÔºâÁ¢∫ÂÆö'});
        bump(); save(); renderAll(); toast('„Ç≠„É£„É≥„Çª„É´ÔºàÂÖ®È°çËøîÈáëÔºâ„ÇíÁ¢∫ÂÆö„Åó„Åæ„Åó„Åü');
      } else { toast('Á¢∫ÂÆöÂèØËÉΩ„Å™Áä∂ÊÖã„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì'); }
    }

    const MORNING_HOUR = 7, MORNING_MINUTE = 30, MORNING_BASE = 1000, STREAK_MAX = 30, STREAK_INC = 100;
    function todayKey(){ const d = new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
    function beforeDeadline(){ const n=new Date(); if(n.getHours()<MORNING_HOUR) return true; if(n.getHours()>MORNING_HOUR) return false; return n.getMinutes()<=MORNING_MINUTE; }
    function canClaimMorning(){
      const me=currentUser(); if(!me) return {ok:false,reason:'„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ'};
      if(isJackpot(me)) return {ok:false,reason:'„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„Éà„ÅØÊúùÊ¥ªÂØæË±°Â§ñ'};
      const t=todayKey(); if(me.lastMorningDate===t) return {ok:false,reason:'Êú¨Êó•„ÅØÂèóÂèñÊ∏à„Åø'};
      if(!beforeDeadline()) return {ok:false,reason:'7:30„ÇíÈÅé„Åé„Å¶„ÅÑ„Åæ„Åô'}; return {ok:true};
    }
    function updateMorningButton(){
      const me=currentUser();
      const s=canClaimMorning(); els.morningBtn.disabled=!s.ok; els.morningBtn.title = s.ok? `ÊúùÊ¥ªÔºö7:30„Åæ„Åß / ÈÄ£Á∂ö +${STREAK_INC}Ôºà‰∏äÈôê${STREAK_MAX}Ôºâ` : s.reason;
      const cnt = me ? (me.streakCount||0) : 0;
      els.streakBadge.textContent = `üî•${cnt}`;
    }
    function morningClaim(){
      const me=currentUser(); const c=canClaimMorning();
      if(!c.ok){ toast(c.reason); updateMorningButton(); return; }
      const today = todayKey();
      if(me.lastMorningDate){
        const diff = Math.round((new Date(today) - new Date(me.lastMorningDate))/86400000);
        me.streakCount = (diff===1) ? Math.min((me.streakCount||0)+1, STREAK_MAX) : 1;
      } else { me.streakCount = 1; }
      me.lastMorningDate = today;
      const bonus = MORNING_BASE + STREAK_INC * (me.streakCount||0);
      me.balance += bonus;
      addTx({ type:'mint', to: me.id, amount: bonus, memo:`ÊúùÊ¥ªÔºàÈÄ£Á∂ö${me.streakCount}Êó•Ôºâ` });
      bump(); save(); renderAll(); toast(`ÊúùÊ¥ª +${fmt.format(bonus)} coinÔºàÈÄ£Á∂ö${me.streakCount}Êó•Ôºâ`);
    }

    function renderJackpot(){
      const j = jackpotUser();
      const bal = j? j.balance : 0;
      els.jackpotChip.textContent = `ÁèæÂú®: ${fmt.format(bal)} coin`;
      els.jackpotBadge.textContent = `JPOT: ${fmt.format(bal)}`;
      const me=currentUser();
      els.rouletteBtn.disabled = !me || (me && me.balance < 100) || bal<=0 || (me && isJackpot(me));
    }
    function rouletteSpin(){
      const me=currentUser(); if(!me){ toast('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô'); return; }
      if(isJackpot(me)){ toast('„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„Éà„Åß„ÅØÈÅä„Åπ„Åæ„Åõ„Çì'); return; }
      if(me.balance < 100){ toast('ÊÆãÈ´ò„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„ÅôÔºà100 coinÂøÖË¶ÅÔºâ'); return; }
      const j = jackpotUser(); if(!j){ toast('JPOT„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì'); return; }
      if(j.balance <= 0){ toast('„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„Éà„ÅåÁ©∫„Åß„Åô'); return; }

      me.balance -= 100; j.balance += 100;
      addTx({ type:'jpot-fee', from: me.id, to: j.id, amount: 100, memo:'„É´„Éº„É¨„ÉÉ„ÉàÂèÇÂä†Ë≤ª' });

      const roll = Math.random();
      if(roll < 0.01){
        const payout = j.balance;
        if(payout > 0){
          me.balance += payout;
          addTx({ type:'jackpot', from: j.id, to: me.id, amount: payout, memo:'üéâ „Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„ÉàÂΩìÈÅ∏Ôºà„É´„Éº„É¨„ÉÉ„ÉàÔºâ' });
          j.balance = 0;
          els.rouletteResult.textContent = `ÁµêÊûú: JACKPOT!! +${fmt.format(payout)} coin`;
        } else { els.rouletteResult.textContent = `ÁµêÊûú: JACKPOTÁô∫Áîü„ÇÇ„Éó„Éº„É´0`; }
        bump(); save(); renderAll(); return;
      }
      const prizes = [{p:0.40, v:0},{p:0.25, v:50},{p:0.18, v:100},{p:0.09, v:150},{p:0.05, v:200},{p:0.02, v:400},{p:0.0099, v:700}];
      let r = Math.random(), acc=0, val=0;
      for(const it of prizes){ acc += it.p; if(r < acc){ val = it.v; break; } }
      const payout = Math.min(j.balance, val);
      if(payout>0){ me.balance += payout; j.balance -= payout; addTx({ type:'roulette', from: j.id, to: me.id, amount: payout, memo:'„É´„Éº„É¨„ÉÉ„ÉàÊâï„ÅÑÂá∫„Åó' }); }
      els.rouletteResult.textContent = `ÁµêÊûú: +${fmt.format(payout)} coin`;
      bump(); save(); renderAll();
    }

    function renderSummary(){
      els.kpiMembers.textContent = state.users.filter(u=>!isJackpot(u)).length;
      const sumBalances = state.users.reduce((s,u)=>s+(u.balance||0),0);
      els.kpiSupply.textContent = coins(sumBalances);
      const last = state.txs[0];
      els.lastActivity.textContent = last ? `ÊúÄÁµÇÊõ¥Êñ∞Ôºö${ts2str(last.ts)}` : 'ÊúÄÁµÇÊõ¥Êñ∞Ôºö‚Äî';
    }

    function renderWallets(){
      els.walletList.innerHTML = '';
      const frag = document.createDocumentFragment();
      state.users.forEach(u => {
        const row = document.createElement('div'); row.className = 'wallet';
        const name = document.createElement('div'); name.className = 'name'; name.textContent = u.name + (u.id===state.currentUserId?'ÔºàËá™ÂàÜÔºâ':'');
        const bal = document.createElement('div'); bal.className = 'balance'; bal.textContent = coins(u.balance);
        row.appendChild(name); row.appendChild(bal); frag.appendChild(row);
      });
      els.walletList.appendChild(frag);
    }

    function renderHeaderUser(){
      const me = currentUser();
      els.userBadge.textContent = me ? `${me.name} / ${coins(me.balance)}` : 'Êú™„É≠„Ç∞„Ç§„É≥';
      els.fromFixed.value = me ? `${me.name}ÔºàÊÆãÈ´òÔºö${fmt.format(me.balance)}Ôºâ` : 'Êú™„É≠„Ç∞„Ç§„É≥';
      if(me && isJackpot(me) && state.lastRealUserId){
        const actor = findUserById(state.lastRealUserId);
        els.actingBadge.style.display = actor? 'inline-block':'none';
        els.actingBadge.textContent = actor? `acting: ${actor.name}` : 'acting: ‚Äî';
      } else { els.actingBadge.style.display = 'none'; }
      updateMorningButton();
      renderJackpot();
      renderApprovalBanner();
      renderRightRequestBanner();
    }

    function renderSelects(){
      const me = currentUser();
      let list = state.users.filter(u=>!me || u.id!==me.id);
      if(me && !isJackpot(me)) list = list.filter(u=>!isJackpot(u));
      const opts = list.map(u => `<option value="${u.id}">${escapeHtml(u.name)}Ôºà${fmt.format(u.balance)}Ôºâ</option>`).join('');
      els.toSelect.innerHTML = `<option value="">ÈÅ∏Êäû</option>${opts}`;
      els.memberFilter.innerHTML = `<option value="">„Åô„Åπ„Å¶</option>` + state.users.map(u=>`<option value="${u.id}">${escapeHtml(u.name)}</option>`).join('');
    }

    function renderHistory(){
      const q = (els.searchInput.value||'').toLowerCase();
      const f = els.memberFilter.value||'';
      els.historyBody.innerHTML = '';
      const frag = document.createDocumentFragment();
      state.txs
        .filter(t => {
          if(f && !((t.from&&t.from===f) || (t.to&&t.to===f) || (t.actedBy&&t.actedBy===f))) return false;
          if(!q) return true;
          const fromName = nameOf(t.from);
          const toName = nameOf(t.to);
          const actorName = nameOf(t.actedBy);
          const text = `${fromName} ${toName} ${actorName} ${(t.memo||'')} ${(t.title||'')}`.toLowerCase();
          return text.includes(q);
        })
        .forEach(t => frag.appendChild(trHistory(t)));
      els.historyBody.appendChild(frag);
    }

    function trHistory(t){
      const tr = document.createElement('tr');
      const tdTime = document.createElement('td'); tdTime.textContent = ts2str(t.ts);
      const tdType = document.createElement('td'); tdType.textContent = typeLabel(t.type);
      const tdFrom = document.createElement('td'); tdFrom.innerHTML = pill(nameOf(t.from)||'‚Äî');
      const tdTo = document.createElement('td'); tdTo.innerHTML = pill(nameOf(t.to)||'‚Äî');
      const suffix = t.actedBy ? ` / actedBy:${nameOf(t.actedBy)}` : '';
      const tdMemo = document.createElement('td'); tdMemo.className='memo'; tdMemo.textContent = t.title ? `${t.title}${t.memo?` / ${t.memo}`:''}${suffix}` : ((t.memo||'')+suffix);
      const tdAmt = document.createElement('td'); tdAmt.style.textAlign = 'right'; tdAmt.innerHTML = t.amount? `<span class="amount">${fmt.format(t.amount)}</span>` : '';
      tr.append(tdTime, tdType, tdFrom, tdTo, tdMemo, tdAmt);
      return tr;
    }

    function typeLabel(tp){
      return tp==='transfer'?'ÈÄÅÈáë'
        : tp==='purchase'?'Ë≥ºÂÖ•'
        : tp==='execute-request'?'ÂÆüË°åÁî≥Ë´ã'
        : tp==='execute-done'?'ÂÆüË°åÔºàË≤©Â£≤ËÄÖÔºâ'
        : tp==='execute-finalize'?'ÂÆüË°åÁ¢∫ÂÆöÔºàË≥ºÂÖ•ËÄÖÔºâ'
        : tp==='execute-cancel-ask'?'„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ãÔºàË≤©Â£≤ËÄÖÔºâ'
        : tp==='execute-cancel-ok'?'„Ç≠„É£„É≥„Çª„É´Á¢∫ÂÆöÔºàË≥ºÂÖ•ËÄÖÔºâ'
        : tp==='return'?'ËøîÂìÅ'
        : tp==='mint'?'Áô∫Ë°å'
        : tp==='burn'?'ÁÑºÂç¥'
        : tp==='fee'?'ÊâãÊï∞Êñô'
        : tp==='roulette'?'„É´„Éº„É¨„ÉÉ„Éà'
        : tp==='jackpot'?'„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„Éà'
        : tp==='jpot-fee'?'JPOTÂÖ•Èáë'
        : '‚Äî';
    }

    function renderListings(){
      els.listingBody.innerHTML='';
      const me = currentUser();
      state.listings.forEach(l=>{
        const remaining = (l.qty||1)-(l.sold||0);
        const tr = document.createElement('tr');
        const tdT = document.createElement('td'); tdT.textContent = l.title + (l.active?'':'ÔºàÂÅúÊ≠¢‰∏≠Ôºâ');
        const tdP = document.createElement('td'); tdP.innerHTML = `<span class="amount">${fmt.format(l.price)}</span>`;
        const tdQ = document.createElement('td'); tdQ.textContent = `${remaining}/${l.qty}`;
        const tdS = document.createElement('td'); tdS.textContent = nameOf(l.sellerId);
        const tdD = document.createElement('td'); tdD.textContent = l.desc||'';
        const tdA = document.createElement('td');
        if(me){
          if(l.sellerId === me.id){
            const tog = document.createElement('button'); tog.className='btn secondary'; tog.textContent = l.active?'ÂÅúÊ≠¢':'ÂÖ¨Èñã'; tog.onclick = ()=>toggleListingActive(l.id);
            const del = document.createElement('button'); del.className='btn danger'; del.textContent='ÂâäÈô§'; del.disabled = (l.sold||0)>0; del.onclick = ()=>deleteListing(l.id);
            tdA.appendChild(tog); tdA.appendChild(document.createTextNode(' ')); tdA.appendChild(del);
          } else {
            const buy = document.createElement('button'); buy.className='btn'; buy.textContent='Ë≥ºÂÖ•';
            buy.disabled = !l.active || remaining<=0 || isJackpot(me);
            buy.onclick=()=>{ buy.disabled=true; buyListing(l.id); };
            tdA.appendChild(buy);
          }
        } else {
          const s = document.createElement('span'); s.className='chip'; s.textContent='„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ'; tdA.appendChild(s);
        }
        tr.append(tdT, tdP, tdQ, tdS, tdD, tdA);
        els.listingBody.appendChild(tr);
      });
    }

    function renderRights(){
      els.rightsBody.innerHTML='';
      const me = currentUser(); if(!me) return;
      const my = state.rights.filter(r=>r.buyerId===me.id);
      my.forEach(r=>{
        const tr = document.createElement('tr');
        const tdTs = document.createElement('td'); tdTs.textContent = ts2str(r.ts);
        const tdT = document.createElement('td'); tdT.textContent = r.title;
        const tdS = document.createElement('td'); tdS.textContent = nameOf(r.sellerId);
        const tdSt = document.createElement('td'); tdSt.textContent = statusLabel(r);
        const tdA = document.createElement('td'); tdA.appendChild(rightActionButtons(r));
        tr.append(tdTs, tdT, tdS, tdSt, tdA);
        els.rightsBody.appendChild(tr);
      });
    }

    function statusLabel(r){
      return r.status==='owned'?'‰øùÊúâ‰∏≠'
        : r.status==='request'?'Ë≤©Â£≤ËÄÖ„ÅÆÂØæÂøúÂæÖ„Å°'
        : r.status==='seller_executed'?'Ë≤©Â£≤ËÄÖ„ÅåÂÆüË°åÊ∏àÔºàÁ¢∫Ë™çÂæÖ„Å°Ôºâ'
        : r.status==='seller_cancel_requested'?'Ë≤©Â£≤ËÄÖ„Åå„Ç≠„É£„É≥„Çª„É´Áî≥Ë´ãÔºàÁ¢∫Ë™çÂæÖ„Å°Ôºâ'
        : r.status==='finalized'? (r.executed?'Á¢∫ÂÆöÔºàÂÆüË°åÊ∏àÔºâ':'Á¢∫ÂÆöÔºà„Ç≠„É£„É≥„Çª„É´Ôºâ')
        : '‚Äî';
    }

    function rightActionButtons(r){
      const span = document.createElement('span');
      if(r.status==='owned'){
        const btn = document.createElement('button'); btn.className='btn warn'; btn.textContent='ÂÆüË°å„ÇíÁî≥Ë´ã'; btn.onclick=()=>{ btn.disabled=true; buyerRequest(r.id); };
        const ret = document.createElement('button'); ret.className='btn danger'; ret.textContent='ËøîÂìÅ'; ret.onclick=()=>{ ret.disabled=true; buyerReturn(r.id); };
        span.appendChild(btn); span.appendChild(document.createTextNode(' ')); span.appendChild(ret);
      } else if(r.status==='seller_executed'){
        const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Ê∏àÔºàÁ¢∫ÂÆöÔºâ'; btn.onclick=()=>{ btn.disabled=true; buyerFinalize(r.id); };
        span.appendChild(btn);
      } else if(r.status==='seller_cancel_requested'){
        const btn = document.createElement('button'); btn.className='btn secondary'; btn.textContent='„Ç≠„É£„É≥„Çª„É´ÊâøË™çÔºàÁ¢∫ÂÆöÔºâ'; btn.onclick=()=>{ btn.disabled=true; buyerFinalize(r.id); };
        span.appendChild(btn);
      } else {
        const chip = document.createElement('span'); chip.className='chip'; chip.textContent='Êìç‰Ωú„Å™„Åó'; span.appendChild(chip);
      }
      return span;
    }

    function switchMarketSub(which){
      els.subtabs.forEach(s=> s.classList.toggle('active', s.dataset.sub===which));
      els.marketSell.style.display = which==='sell' ? 'block' : 'none';
      els.marketList.style.display = which==='list' ? 'block' : 'none';
    }

    function renderApprovalBanner(forceGray){
      if(!state.approval.active){ els.approvalBanner.style.display='none'; return; }
      const to=findUserById(state.approval.toId);
      const amt=state.approval.amount||0;
      els.approvalText.textContent = `„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„Éà„Åå ${to?to.name:'?'} „Å´ ${fmt.format(amt)} coin „ÇíÈÄÅÈáë„Åó„Çà„ÅÜ„Å®„Åó„Å¶„ÅÑ„Åæ„Åô` + (state.approval.memo? `Ôºà${state.approval.memo}Ôºâ` : '');
      const me=currentUser();
      if(me && !isJackpot(me)){
        const voted = state.approval.votes && state.approval.votes[me.id];
        els.btnApprove.disabled = !!voted || !!forceGray;
        els.btnReject.disabled = !!voted || !!forceGray;
        els.approvalActions.style.display='flex';
      } else if(me && isJackpot(me)){
        els.btnApprove.disabled = true;
        els.btnReject.textContent = '„Ç≠„É£„É≥„Çª„É´';
        els.btnReject.disabled = false;
        els.approvalActions.style.display='flex';
      } else { els.approvalActions.style.display='none'; }
      els.approvalBanner.style.display='flex';
    }

    function renderRightRequestBanner(){
      const me=currentUser(); if(!me){ els.rightReqBanner.style.display='none'; return; }
      const pending = state.rights.filter(r=>r.sellerId===me.id && r.status==='request').sort((a,b)=>b.ts-a.ts)[0];
      if(!pending){ els.rightReqBanner.style.display='none'; return; }
      const buyer = findUserById(pending.buyerId);
      els.rightReqText.textContent = `Ê®©Âà©ÂÆüË°å„É™„ÇØ„Ç®„Çπ„ÉàÔºö${buyer?buyer.name:'?'} „Åå„Äå${pending.title}„Äç„ÅÆÂÆüË°å„ÇíÁî≥Ë´ã„Åó„Å¶„ÅÑ„Åæ„Åô`;
      els.btnRightExec.onclick = ()=>{ els.btnRightExec.disabled=true; els.btnRightCancel.disabled=true; sellerRespond(pending.id,'exec'); };
      els.btnRightCancel.onclick = ()=>{ els.btnRightExec.disabled=true; els.btnRightCancel.disabled=true; sellerRespond(pending.id,'cancel'); };
      els.rightReqBanner.style.display='flex';
    }

    function renderTabs(){
      const show = (name)=>{
        els.tabTransfer.style.display = name==='transfer'? 'block':'none';
        els.tabMarket.style.display   = name==='market'  ? 'block':'none';
        els.tabMyRights.style.display = name==='myrights'? 'block':'none';
        els.tabGamble.style.display   = name==='gamble'  ? 'block':'none';
      }
      const active = document.querySelector('.tabbar .tab.active');
      show(active? active.dataset.tab : 'transfer');
    }

    function renderAll(){ renderSummary(); renderWallets(); renderHeaderUser(); renderSelects(); renderHistory(); renderListings(); renderRights(); renderTabs(); }

    let syncTimer = null;
    function syncDebounced(){ if(!sync.connected) return; if(syncTimer) clearTimeout(syncTimer); syncTimer = setTimeout(()=>{ sync.broadcastState(); }, 180); }

    els.registerBtn.addEventListener('click', ()=> register(els.regName.value, els.regPass.value));
    els.loginBtn.addEventListener('click', ()=> login(els.loginName.value, els.loginPass.value));
    els.logoutBtn.addEventListener('click', logout);
    els.sendBtn.addEventListener('click', ()=>{ transfer(els.toSelect.value, els.amountInput.value, els.memoInput.value); els.amountInput.value=''; els.memoInput.value=''; });
    els.searchInput.addEventListener('input', renderHistory);
    els.memberFilter.addEventListener('change', renderHistory);
    els.exportBtn.addEventListener('click', exportJSON);
    els.importFile.addEventListener('change', (e)=>{ const f=e.target.files[0]; if(f) importJSON(f); e.target.value=''; });
    els.createListingBtn.addEventListener('click', ()=> createListing(els.listTitle.value, els.listPrice.value, els.listDesc.value));
    els.tabs.forEach(t=> t.addEventListener('click', ()=>{ document.querySelectorAll('.tabbar .tab').forEach(x=>x.classList.remove('active')); t.addEventListener('animationend',()=>{}, {once:true}); t.classList.add('active'); renderTabs(); }));
    els.subtabs.forEach(s=> s.addEventListener('click', ()=> switchMarketSub(s.dataset.sub)));
    els.morningBtn.addEventListener('click', morningClaim);
    els.rouletteBtn.addEventListener('click', rouletteSpin);
    els.btnApprove.addEventListener('click', ()=> approve(true));
    els.btnReject.addEventListener('click', ()=>{ const me=currentUser(); if(me && isJackpot(me)){ cancelApproval(); } else { approve(false); } });
    els.btnConnect.addEventListener('click', ()=> sync.connect());
    els.btnDisconnect.addEventListener('click', ()=> sync.disconnect());
    els.btnBroadcast.addEventListener('click', ()=> sync.broadcastState());

    load(); ensureJackpotUser();
    state.listings.forEach(l=>{ if(typeof l.qty!=='number') l.qty=1; if(typeof l.sold!=='number') l.sold=0; });
    state.rights.forEach(r=>{ if(!r.status){ r.status = r.executed? 'finalized':'owned'; } });
    if(typeof state.jackpot === 'number'){ jackpotUser().balance += state.jackpot; delete state.jackpot; }
    state.txs.forEach(t=>{ if(t.to==='_jackpot'){ t.to = state.jackpotUserId; } if(t.from==='_jackpot'){ t.from = state.jackpotUserId; } });
    state.users.forEach(u=>{ if(typeof u.streakCount!=='number') u.streakCount=0; if(typeof u.lastMorningDate!=='string') u.lastMorningDate=''; });

    sync.loadSettings();
    save(true); renderAll();
    setInterval(()=>{ try{ updateMorningButton(); renderApprovalBanner(); renderRightRequestBanner(); }catch(e){} }, 30000);

    if(state.users.filter(u=>!isJackpot(u)).length===0){ toast(`„Åæ„Åö„ÅØÊñ∞Ë¶èÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÂàùÊúüÊÆãÈ´ò„ÅØ 10,000 coinÔºâ / ${JACKPOT_NAME} „ÅØ„Éë„Çπ‰∏çË¶Å„ÅßË™∞„Åß„ÇÇ„É≠„Ç∞„Ç§„É≥ÂèØ`); }
  })();
  </script>
</body>
</html>
