<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TRPGトークン | v15 (React)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <style>
        :root {
            --font-primary: 'Helvetica Neue', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            --font-mono: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            --bg-dark-1: #16161e; --bg-dark-2: #1a1b26; --bg-dark-3: #24283b; --bg-dark-4: #414868;
            --fg-light-1: #c0caf5; --fg-light-2: #a9b1d6; --fg-light-3: #787c99;
            --accent-blue: #7aa2f7; --accent-cyan: #7dcfff; --accent-purple: #bb9af7;
            --accent-green: #9ece6a; --accent-yellow: #e0af68; --accent-red: #f7768e;
            --border-radius: 8px; --transition-speed: 0.3s;
        }
        * { box-sizing: border-box; }
        html, body, #root { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { background-color: var(--bg-dark-1); color: var(--fg-light-1); font-family: var(--font-primary); font-size: 15px; -webkit-font-smoothing: antialiased; }
        #root { display: flex; transition: background-color var(--transition-speed); }
        .app-container, .login-screen { width: 100%; height: 100%; }
        .login-screen { display: flex; justify-content: center; align-items: center; background: linear-gradient(160deg, var(--bg-dark-2), var(--bg-dark-1)); }
        .login-box { background-color: var(--bg-dark-2); padding: 40px; border-radius: var(--border-radius); box-shadow: 0 15px 40px rgba(0,0,0,0.5); border: 1px solid var(--bg-dark-4); width: 100%; max-width: 400px; text-align: center; }
        .login-box h1 { color: var(--accent-purple); margin-bottom: 30px; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; color: var(--fg-light-2); font-size: 0.9em; }
        .input-group input { width: 100%; padding: 12px; background-color: var(--bg-dark-1); border: 1px solid var(--bg-dark-4); border-radius: var(--border-radius); color: var(--fg-light-1); font-size: 1em; transition: all var(--transition-speed); }
        .input-group input:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(122, 162, 247, 0.3); }
        .btn-primary { width: 100%; padding: 12px; border-radius: var(--border-radius); border: none; background: linear-gradient(145deg, var(--accent-blue), var(--accent-purple)); color: white; font-size: 1em; font-weight: 600; cursor: pointer; transition: all var(--transition-speed); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .toggle-form { margin-top: 25px; font-size: 0.9em; color: var(--fg-light-3); }
        .toggle-form span { color: var(--accent-cyan); cursor: pointer; font-weight: 600; }
        .dashboard { display: grid; grid-template-columns: 320px 1fr 400px; grid-template-rows: auto 1fr; height: 100vh; gap: 1px; background-color: var(--bg-dark-4); }
        .dashboard-header { grid-column: 1 / -1; background-color: var(--bg-dark-2); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--bg-dark-4); }
        .dashboard-header h1 { font-size: 1.2em; margin: 0; }
        .user-badge { background-color: var(--bg-dark-3); padding: 8px 12px; border-radius: var(--border-radius); font-size: 0.9em; }
        .dashboard-left, .dashboard-main, .dashboard-right { overflow-y: auto; padding: 20px; background-color: var(--bg-dark-2); }
        .dashboard-main { background-color: var(--bg-dark-1); }
        .panel { background-color: var(--bg-dark-2); border: 1px solid var(--bg-dark-4); border-radius: var(--border-radius); padding: 20px; margin-bottom: 20px; }
        .panel h2 { margin-top: 0; color: var(--accent-purple); font-size: 1.1em; border-bottom: 1px solid var(--bg-dark-4); padding-bottom: 10px; margin-bottom: 15px;}
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef, Fragment } = React;

        // --- API Logic ---
        const API = {
            async sha256(text) {
                const enc = new TextEncoder().encode(text);
                const buf = await crypto.subtle.digest('SHA-256', enc);
                return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
            },
            createOperation(type, data, userId) {
                return { id: `op_${Math.random().toString(36).slice(2)}_${Date.now()}`, type, data, timestamp: Date.now(), userId, clientId: 'client_main_v15' };
            },
            async fetchState(settings, lastSync) {
                const url = new URL(settings.url);
                url.searchParams.set('room', settings.room);
                url.searchParams.set('key', settings.key);
                if (lastSync) url.searchParams.set('lastSync', lastSync);
                const res = await fetch(url.toString());
                if (res.status === 204) return null;
                if (!res.ok) throw new Error(`サーバーエラー: ${res.status}`);
                return res.json();
            },
            async sendOperations(settings, operations) {
                const url = new URL(settings.url);
                url.searchParams.set('room', settings.room);
                url.searchParams.set('key', settings.key);
                const res = await fetch(url.toString(), { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ operations }) });
                if (!res.ok) { const errorText = await res.text(); throw new Error(`操作送信失敗: ${res.status} ${errorText}`); }
                return res.json();
            }
        };

        // --- Main App Component ---
        function App() {
            const [appState, setAppState] = useState({ state: null, currentUser: null, settings: {} });

            useEffect(() => {
                const settings = JSON.parse(localStorage.getItem('trpg_sync_kv') || '{}');
                const lastUserId = localStorage.getItem('last_current_uid');
                setAppState(s => ({...s, settings}));
                if (lastUserId && settings.url) {
                    API.fetchState(settings).then(data => {
                        if (data && data.state) {
                            const user = data.state.users.find(u => u.id === lastUserId);
                            if (user) {
                                setAppState(s => ({...s, state: data.state, currentUser: user}));
                            }
                        }
                    }).catch(console.error);
                }
            }, []);

            const handleLogin = (user, state) => {
                setAppState(s => ({...s, currentUser: user, state}));
                localStorage.setItem('last_current_uid', user.id);
            };
            
            const handleLogout = () => {
                setAppState(s => ({...s, currentUser: null}));
                localStorage.removeItem('last_current_uid');
            };

            return (
                <div className="app-container">
                    {!appState.currentUser || !appState.state ? (
                        <LoginScreen onLogin={handleLogin} settings={appState.settings} />
                    ) : (
                        <MainDashboard user={appState.currentUser} initialState={appState.state} settings={appState.settings} onLogout={handleLogout} />
                    )}
                </div>
            );
        }

        function StatsPanel({ state, currentUser }) {
            const pieChartRef = useRef(null);

            useEffect(() => {
                if (!state.users || !d3) return;

                const topUsers = [...state.users]
                    .filter(u => u.name !== 'ジャックポット')
                    .sort((a, b) => b.balance - a.balance)
                    .slice(0, 5);

                const otherUsersBalance = state.users
                    .filter(u => u.name !== 'ジャックポット')
                    .slice(5)
                    .reduce((acc, u) => acc + u.balance, 0);

                const data = [...topUsers.map(u => ({name: u.name, value: u.balance}))];
                if (otherUsersBalance > 0) {
                    data.push({ name: 'その他', value: otherUsersBalance });
                }

                const width = 280, height = 280, margin = 20;
                const radius = Math.min(width, height) / 2 - margin;

                d3.select(pieChartRef.current).select("svg").remove();

                const svg = d3.select(pieChartRef.current)
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .append("g")
                    .attr("transform", `translate(${width / 2},${height / 2})`);

                const color = d3.scaleOrdinal()
                    .domain(data.map(d => d.name))
                    .range(d3.schemeSpectral[data.length]);

                const pie = d3.pie().value(d => d.value);
                const data_ready = pie(data);

                svg.selectAll('whatever')
                    .data(data_ready)
                    .join('path')
                    .attr('d', d3.arc().innerRadius(0).outerRadius(radius))
                    .attr('fill', d => color(d.data.name))
                    .attr("stroke", "var(--bg-dark-1)")
                    .style("stroke-width", "2px");

            }, [state.users]);

            return (
                <div className="panel">
                    <h2>資産分布</h2>
                    <div ref={pieChartRef}></div>
                </div>
            );
        }

        function MainDashboard({ user, onLogout, initialState, settings }) {
            const [state, setState] = useState(initialState);
            let lastSyncTime = useRef(Date.now());

            useEffect(() => {
                const poll = () => {
                    API.fetchState(settings, lastSyncTime.current).then(data => {
                        if (data && data.state) {
                            setState(data.state);
                            lastSyncTime.current = data.lastUpdate;
                        }
                    }).catch(console.error);
                };
                const interval = setInterval(poll, 3000);
                return () => clearInterval(interval);
            }, [settings]);

            const onSendOperation = useCallback(async (type, data) => {
                const op = API.createOperation(type, data, user.id);
                const result = await API.sendOperations(settings, [op]);
                if (result.newState) setState(result.newState);
            }, [user, settings]);

            return (
                <div className="dashboard">
                    <header className="dashboard-header">
                        <h1>TRPGトークン</h1>
                        <div className="user-badge">{user.name} | {state.users.find(u=>u.id===user.id)?.balance.toLocaleString()} coin</div>
                        <button onClick={onLogout}>ログアウト</button>
                    </header>
                    <aside className="dashboard-left">
                        <div className="panel"><h2>統計</h2><p>実装予定...</p></div>
                    </aside>
                    <main className="dashboard-main">
                        <div className="panel"><h2>アクション</h2>{/* Action panel will go here */}</div>
                    </main>
                    <aside className="dashboard-right">
                        <div className="panel"><h2>取引履歴</h2>{/* History panel will go here */}</div>
                        <StatsPanel state={state} currentUser={user} />
                    </aside>
                </div>
            );
        }

        function LoginScreen({ onLogin, settings }) {
            const [isLoginView, setIsLoginView] = useState(true);
            const [name, setName] = useState('');
            const [pass, setPass] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const passRef = useRef(null);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    const serverData = await API.fetchState(settings);
                    const serverState = serverData ? serverData.state : { users: [] };
                    if (isLoginView) {
                        const user = serverState.users.find(u => u.name === name);
                        if (!user) throw new Error('ユーザーが見つかりません');
                        const passHash = await API.sha256(pass);
                        if (user.passHash !== passHash) { passRef.current.select(); throw new Error('パスワードが違います'); }
                        onLogin(user, serverState);
                    } else {
                        if (serverState.users.some(u => u.name === name)) throw new Error('そのユーザー名は使用済みです');
                        const passHash = await API.sha256(pass);
                        const op = API.createOperation('register_user', { name, passHash }, null);
                        const result = await API.sendOperations(settings, [op]);
                        const newUser = result.newState.users.find(u => u.name === name);
                        if (newUser) onLogin(newUser, result.newState);
                        else throw new Error('登録後のユーザーが見つかりませんでした。');
                    }
                } catch (err) { setError(err.message); } finally { setLoading(false); }
            };

            return (
                <div className="login-screen">
                    <div className="login-box">
                        <h1>{isLoginView ? 'ログイン' : '新規登録'}</h1>
                        <form onSubmit={handleSubmit}>
                            <div className="input-group"><label htmlFor="username">ユーザー名</label><input id="username" type="text" value={name} onChange={e => setName(e.target.value)} required /></div>
                            <div className="input-group"><label htmlFor="password">パスワード</label><input id="password" type="password" ref={passRef} value={pass} onChange={e => setPass(e.target.value)} required /></div>
                            {error && <p style={{color: 'var(--accent-red)'}}>{error}</p>}
                            <button type="submit" className="btn-primary" disabled={loading}>{loading ? '処理中...' : (isLoginView ? 'ログイン' : '登録してログイン')}</button>
                        </form>
                        <p className="toggle-form">{isLoginView ? 'アカウントがありませんか？' : '既にアカウントがありますか？'}<span onClick={() => setIsLoginView(!isLoginView)}>{isLoginView ? ' 新規登録' : ' ログイン'}</span></p>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
