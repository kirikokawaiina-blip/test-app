<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>trpgé¯– ãƒˆãƒ¼ã‚¯ãƒ³ | CloudflareåŒæœŸç‰ˆ v12</title>
  <meta name="description" content="æ“¬ä¼¼ãƒˆãƒ¼ã‚¯ãƒ³é€å—é ˜ãƒ»æ¨©åˆ©ãƒãƒ¼ã‚±ãƒƒãƒˆï¼ˆåœ¨åº«/å‰Šé™¤/è¿”å“ï¼‰ãƒ»æœæ´»ã‚¹ãƒˆãƒªãƒ¼ã‚¯ãƒ»ã‚®ãƒ£ãƒ³ãƒ–ãƒ«ã€‚ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦å­˜åœ¨ï¼ˆç›´æ¥å…¥é‡‘ä¸å¯ï¼‰ã€‚Cloudflare Workersã®WebSocketã‚’ä½¿ã£ãŸãƒ«ãƒ¼ãƒ åŒæœŸå¯¾å¿œã€‚" />
  <style>
    :root {
      --bg: #0b1220;
      --bg-2: #0e1730;
      --card: #0f172a;
      --muted: #94a3b8;
      --text: #e5edf6;
      --line: #1f2a44;
      --accent: #15c7b6;
      --accent-2: #60efff;
      --danger: #ef4444;
      --warn: #f59e0b;
      --ok: #22c55e;
      --shadow: 0 10px 35px rgba(0,0,0,.45), 0 2px 8px rgba(0,0,0,.35);
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", Meiryo, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 800px at 20% -10%, #11224e 0%, transparent 65%),
                  radial-gradient(800px 800px at 110% 10%, rgba(21,199,182,.15) 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
      overflow-y: auto;
    }
    header { position: sticky; top: 0; z-index: 50; backdrop-filter: saturate(120%) blur(14px); background: linear-gradient(180deg, rgba(9,14,30,.8), rgba(12,18,38,.4)); border-bottom: 1px solid rgba(96,239,255,.12); }
    .nav { max-width: 1200px; margin: 0 auto; padding: 10px 14px; display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
    .logo { display: grid; grid-auto-flow: column; align-items: center; gap: 10px; font-weight: 750; letter-spacing: .3px; font-size: 16px; }
    .logo-badge { width: 28px; height: 28px; border-radius: 8px; display: grid; place-items: center; background: conic-gradient(from 200deg, var(--accent), var(--accent-2)); box-shadow: 0 8px 20px rgba(21,199,182,.35); }
    .chip { padding: 6px 10px; border: 1px solid rgba(96,239,255,.18); border-radius: 999px; color: var(--muted); font-size: 12px; }

    main { max-width: 1200px; margin: 16px auto 40px; padding: 0 14px; }
    .grid { display: grid; grid-template-columns: 330px 1fr 340px; gap: 14px; }
    @media (max-width: 1100px) { .grid { grid-template-columns: 1fr; } }

    .card { background: linear-gradient(180deg, rgba(16,25,46,.8), rgba(12,20,38,.8)); border: 1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
    .card .hd { padding: 10px 12px; display:flex; align-items:center; justify-content:space-between; gap:10px; background: linear-gradient(180deg, rgba(22,32,58,.6), rgba(19,28,50,.2)); border-bottom: 1px solid rgba(96,239,255,.1); }
    .card .hd h3 { margin: 0; font-size: 14px; letter-spacing: .3px; color: #d9e7ff; font-weight: 700; }
    .card .bd { padding: 12px; }

    .stat { display:grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
    .kpi { padding: 8px; border: 1px solid rgba(96,239,255,.12); border-radius: 12px; background: rgba(17,28,52,.45); }
    .kpi .lbl { color: var(--muted); font-size: 11px; }
    .kpi .val { margin-top: 2px; font-size: 16px; font-weight: 800; letter-spacing: .2px; }

    .row { display: grid; gap: 8px; }
    label { font-size: 12px; color: var(--muted); }
    input[type="text"], input[type="password"], input[type="number"], select, textarea {
      width: 100%; padding: 10px 10px; border-radius: 10px; outline: none; color: var(--text);
      background: rgba(13,21,40,.75); border: 1px solid rgba(96,239,255,.12);
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    input:focus, select:focus, textarea:focus { border-color: rgba(96,239,255,.35); box-shadow: 0 0 0 4px rgba(96,239,255,.12); }

    .btn { appearance: none; border:0; cursor:pointer; color: #04151f; font-weight: 800; letter-spacing: .2px; padding: 10px 12px; border-radius: 10px; transition: transform .05s ease, filter .2s ease, opacity .2s ease; background: linear-gradient(90deg, var(--accent), var(--accent-2)); box-shadow: 0 10px 26px rgba(21,199,182,.35), inset 0 0 0 1px rgba(255,255,255,.18); font-size: 14px; }
    .btn:active { transform: translateY(1px); }
    .btn.secondary { color: var(--text); background: transparent; border: 1px solid rgba(96,239,255,.22); box-shadow: none; }
    .btn.warn { color: #1a1007; background: linear-gradient(90deg, #f59e0b, #fde047); box-shadow: 0 10px 26px rgba(245,158,11,.3); }
    .btn.danger { color: #1a0b0b; background: linear-gradient(90deg, #ef4444, #fb7185); box-shadow: 0 10px 26px rgba(239,68,68,.32); }
    .btn:disabled { filter: grayscale(1) brightness(.85); opacity: .6; cursor: not-allowed; box-shadow: none; }

    .wallet-list { display: grid; gap: 6px; }
    .wallet { padding: 8px 10px; border: 1px solid rgba(96,239,255,.12); border-radius: 10px; display:grid; grid-template-columns: 1fr auto; gap: 8px; align-items:center; background: rgba(14,24,44,.5); }
    .wallet .name { font-weight: 750; font-size: 14px; }
    .wallet .balance { font-variant-numeric: tabular-nums; background: rgba(21,199,182,.08); border:1px solid rgba(21,199,182,.24); padding: 4px 8px; border-radius: 999px; font-size: 12px; }

    .history-tools { display:flex; gap: 8px; align-items:center; margin-bottom: 8px; flex-wrap: wrap; }
    .table { width: 100%; border-collapse: separate; border-spacing: 0; overflow: auto; display:block; border: 1px solid rgba(96,249,255,.08); border-radius: 10px; background: rgba(13,22,40,.4); }
    .table thead { position: sticky; top: 0; backdrop-filter: blur(8px); background: rgba(15,23,42,.75); }
    .table th, .table td { padding: 8px 10px; text-align: left; border-bottom: 1px solid rgba(96,239,255,.06); white-space: nowrap; }
    .table td.memo { white-space: normal; }
    .pill { padding: 4px 8px; border-radius:999px; font-weight: 700; font-size: 12px; background: rgba(21,199,182,.12); border:1px solid rgba(21,199,182,.32); }
    .amount { font-variant-numeric: tabular-nums; font-weight: 800; }

    .toolbar { display:flex; gap: 8px; flex-wrap: wrap; }

    .toast { position: fixed; right: 12px; bottom: 12px; display:grid; gap:6px; z-index: 60; }
    .toast .msg { padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(96,239,255,.2); background: rgba(17,27,48,.9); box-shadow: var(--shadow); font-size: 13px; }

    .tabbar { display:flex; gap:6px; flex-wrap:wrap; }
    .tabbar .tab { padding:6px 10px; border:1px solid rgba(96,239,255,.2); border-radius:999px; background: rgba(15,25,46,.6); cursor:pointer; font-size: 13px; }
    .tabbar .tab.active { border-color: rgba(96,239,255,.45); background: rgba(21,199,182,.1); }

    .subtabs { display:flex; gap:6px; margin-bottom:6px; flex-wrap: wrap; }
    .subtabs .sub { padding:5px 8px; border:1px solid rgba(96,239,255,.2); border-radius:999px; cursor:pointer; background: rgba(15,25,46,.6); font-size:12px; }
    .subtabs .sub.active { border-color: rgba(96,239,255,.45); background: rgba(21,199,182,.1); }

    .panel { border:1px solid rgba(96,239,255,.12); border-radius:10px; padding:10px; background: rgba(12,22,40,.5); }

    .banner { border:1px dashed rgba(245,158,11,.5); background: rgba(245,158,11,.08); border-radius:10px; padding:8px; display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
    .banner .txt { font-size: 13px; }
    .banner .actions { display:flex; gap:6px; }

  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="logo">
        <div class="logo-badge"></div>
        trpgé¯– ãƒˆãƒ¼ã‚¯ãƒ³
        <span class="chip">ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ & ãƒ«ãƒ¼ãƒ åŒæœŸ</span>
      </div>
      <div class="toolbar">
        <div id="userBadge" class="chip">æœªãƒ­ã‚°ã‚¤ãƒ³</div>
        <div id="actingBadge" class="chip" title="ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆæ“ä½œã®ä»£ç†äºº" style="display:none;">acting: â€”</div>
        <div id="streakBadge" class="chip" title="æœæ´»ã‚¹ãƒˆãƒªãƒ¼ã‚¯">ğŸ”¥0</div>
        <div id="jackpotBadge" class="chip" title="TRPGã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆ">JPOT: 0</div>
        <button class="btn" id="morningBtn" title="æœæ´»ãƒœãƒ¼ãƒŠã‚¹ï¼š7:30ã¾ã§ã«æŠ¼ã™ã¨1æ—¥1å›">æœæ´»</button>
        <button class="btn secondary" id="exportBtn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <label class="btn secondary" for="importFile">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ<input type="file" id="importFile" accept="application/json" style="display:none" /></label>
      </div>
    </div>
  </header>

  <main>
    <div class="grid">
      <section class="card" aria-label="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ">
        <div class="hd"><h3>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ & åŒæœŸ</h3></div>
        <div class="bd">
          <div class="stat" id="summary">
            <div class="kpi"><div class="lbl">ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆJPOTé™¤å¤–ï¼‰</div><div class="val" id="kpiMembers">0</div></div>
            <div class="kpi"><div class="lbl">ç·ä¾›çµ¦é‡</div><div class="val" id="kpiSupply">0 coin</div></div>
          </div>

          <div class="row panel" style="margin-bottom:8px;">
            <label>åŒæœŸè¨­å®šï¼ˆCloudflare Workers ã® WSSï¼‰</label>
            <input id="syncUrl" type="text" placeholder="wss://<your-worker>.<subdomain>.workers.dev/ws" />
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
              <input id="syncRoom" type="text" placeholder="ãƒ«ãƒ¼ãƒ åï¼ˆä¾‹ï¼štrpg-guildï¼‰" />
              <input id="syncKey" type="text" placeholder="ãƒ«ãƒ¼ãƒ éµï¼ˆå‹é”ã ã‘ã§å…±æœ‰ï¼‰" />
            </div>
            <div class="toolbar">
              <button class="btn" id="btnConnect">æ¥ç¶š</button>
              <button class="btn secondary" id="btnDisconnect">åˆ‡æ–­</button>
              <button class="btn warn" id="btnBroadcast">ã„ã¾ã®çŠ¶æ…‹ã‚’é€ä¿¡</button>
              <span id="syncStatus" class="chip">æœªæ¥ç¶š</span>
            </div>
          </div>

          <div class="row" style="margin-bottom:8px;">
            <div class="row panel">
              <label for="loginName">ãƒ­ã‚°ã‚¤ãƒ³</label>
              <input id="loginName" type="text" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆã¯ãƒ‘ã‚¹ä¸è¦ï¼‰" />
              <input id="loginPass" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
              <div class="toolbar">
                <button class="btn" id="loginBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button class="btn secondary" id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
              </div>
            </div>
            <div class="row panel">
              <label for="regName">æ–°è¦ç™»éŒ²ï¼ˆåˆæœŸæ®‹é«˜ 10,000 coinï¼‰</label>
              <input id="regName" type="text" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆé‡è¤‡ä¸å¯ï¼‰" />
              <input id="regPass" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
              <button class="btn" id="registerBtn">ç™»éŒ²</button>
            </div>
          </div>

          <div class="row panel">
            <label>ã‚¦ã‚©ãƒ¬ãƒƒãƒˆä¸€è¦§</label>
            <div class="wallet-list" id="walletList" aria-live="polite"></div>
          </div>
        </div>
      </section>

      <section class="card" aria-label="æ“ä½œ">
        <div class="hd">
          <h3>æ“ä½œ</h3>
          <div class="tabbar">
            <div class="tab active" data-tab="transfer">é€é‡‘</div>
            <div class="tab" data-tab="market">ãƒãƒ¼ã‚±ãƒƒãƒˆ</div>
            <div class="tab" data-tab="myrights">è‡ªåˆ†ã®æ¨©åˆ©</div>
            <div class="tab" data-tab="gamble">ã‚®ãƒ£ãƒ³ãƒ–ãƒ«</div>
          </div>
        </div>
        <div class="bd">

          <div id="approvalBanner" class="banner" style="display:none;">
            <div class="txt" id="approvalText">â€”</div>
            <div class="actions" id="approvalActions">
              <button class="btn secondary" id="btnReject">æ‹’å¦</button>
              <button class="btn" id="btnApprove">è¨±å¯</button>
            </div>
          </div>

          <div id="rightReqBanner" class="banner" style="display:none;">
            <div class="txt" id="rightReqText">â€”</div>
            <div class="actions" id="rightReqActions">
              <button class="btn secondary" id="btnRightCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç”³è«‹</button>
              <button class="btn" id="btnRightExec">å®Ÿè¡Œ</button>
            </div>
          </div>

          <div id="tab-transfer">
            <div class="row" style="grid-template-columns: 1fr 1fr; display:grid; gap:10px;">
              <div class="row">
                <label>é€ä¿¡å…ƒï¼ˆã‚ãªãŸï¼‰</label>
                <input id="fromFixed" type="text" disabled placeholder="æœªãƒ­ã‚°ã‚¤ãƒ³" />
              </div>
              <div class="row">
                <label for="toSelect">é€ä¿¡å…ˆ</label>
                <select id="toSelect"></select>
              </div>
            </div>
            <div class="row" style="margin-top:8px; grid-template-columns: 1fr 140px; display:grid; gap:10px;">
              <div class="row">
                <label for="amountInput">é‡‘é¡ï¼ˆcoinï¼‰</label>
                <input id="amountInput" type="number" min="1" step="1" placeholder="ä¾‹ï¼‰250" />
              </div>
              <div class="row">
                <label>&nbsp;</label>
                <button class="btn" id="sendBtn">é€ä¿¡ã™ã‚‹</button>
              </div>
            </div>
            <div class="row" style="margin-top:8px;">
              <label for="memoInput">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
              <input id="memoInput" type="text" placeholder="ä¾‹ï¼‰ã‚®ãƒ«ãƒ‰è³é‡‘" />
            </div>
          </div>

          <div id="tab-market" style="display:none;">
            <div class="subtabs">
              <div class="sub active" data-sub="sell">å‡ºå“ã™ã‚‹</div>
              <div class="sub" data-sub="list">å‡ºå“ä¸€è¦§</div>
            </div>
            <div id="market-sell">
              <div class="row panel">
                <label>æ¨©åˆ©ã®å‡ºå“ï¼ˆè²©å£²è€…ï¼‰</label>
                <input id="listTitle" type="text" placeholder="ä¾‹ï¼‰ã‚²ãƒ¼ãƒ ã‚’ä¸€ç·’ã«éŠã¶" />
                <textarea id="listDesc" rows="2" placeholder="èª¬æ˜ï¼ˆä»»æ„ï¼‰"></textarea>
                <div style="display:grid; grid-template-columns: 1fr 1fr 140px; gap:8px;">
                  <div class="row">
                    <label for="listPrice">ä¾¡æ ¼ï¼ˆcoinï¼‰</label>
                    <input id="listPrice" type="number" min="1" step="1" placeholder="ä¾‹ï¼‰1000" />
                  </div>
                  <div class="row">
                    <label for="listQty">åœ¨åº«ï¼ˆå€‹æ•°ï¼‰</label>
                    <input id="listQty" type="number" min="1" step="1" placeholder="ä¾‹ï¼‰5" />
                  </div>
                  <div class="row">
                    <label>&nbsp;</label>
                    <button class="btn" id="createListingBtn">å‡ºå“ã™ã‚‹</button>
                  </div>
                </div>
              </div>
            </div>
            <div id="market-list" style="display:none;">
              <div class="row">
                <label>å‡ºå“ä¸€è¦§</label>
                <div class="table" role="region" aria-label="å‡ºå“ä¸€è¦§">
                  <table style="min-width:860px; width:100%;">
                    <thead>
                      <tr>
                        <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
                        <th>ä¾¡æ ¼</th>
                        <th>åœ¨åº«</th>
                        <th>å‡ºå“è€…</th>
                        <th>èª¬æ˜</th>
                        <th>æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody id="listingBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div id="tab-myrights" style="display:none;">
            <div class="row">
              <label>è‡ªåˆ†ãŒä¿æœ‰ã™ã‚‹æ¨©åˆ©</label>
              <div class="table" role="region" aria-label="è‡ªåˆ†ã®æ¨©åˆ©">
                <table style="min-width:860px; width:100%;">
                  <thead>
                    <tr>
                      <th>æ—¥ä»˜</th>
                      <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
                      <th>è²©å£²è€…</th>
                      <th>çŠ¶æ…‹</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody id="rightsBody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div id="tab-gamble" style="display:none;">
            <div class="row panel">
              <label>TRPGã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ®‹é«˜ï¼‰</label>
              <div class="toolbar">
                <div class="chip" id="jackpotChip">ç¾åœ¨: 0 coin</div>
              </div>
            </div>
            <div class="row panel">
              <h4 style="margin:0;">ğŸ° ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼ˆ1å›100 coinï¼‰</h4>
              <p style="margin:0; color:var(--muted); font-size:12px;">æœŸå¾…å€¤ã¯ç´„70%ã€‚1%ã§<strong>ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆå…¨é¡</strong>ã€‚å‚åŠ è²»ã¯JPOTã«åŠ ç®—ã€æ‰•ã„å‡ºã—ã¯JPOTã‹ã‚‰ã€‚</p>
              <div class="toolbar">
                <button class="btn" id="rouletteBtn">å›ã™</button>
              </div>
              <div id="rouletteResult" class="chip" style="margin-top:8px;">çµæœ: â€”</div>
            </div>
          </div>
        </div>
      </section>

      <section class="card" aria-label="å±¥æ­´">
        <div class="hd">
          <h3>å±¥æ­´</h3>
          <div class="history-tools">
            <input id="searchInput" type="text" placeholder="æ¤œç´¢ï¼šåå‰ / ãƒ¡ãƒ¢ / æ¨©åˆ©" style="width:200px" />
            <select id="memberFilter"><option value="">ã™ã¹ã¦</option></select>
            <div id="lastActivity" class="chip">æœ€çµ‚æ›´æ–°ï¼šâ€”</div>
          </div>
        </div>
        <div class="bd">
          <div class="table" role="region" aria-label="å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«">
            <table style="min-width:760px; width:100%;">
              <thead>
                <tr>
                  <th>æ—¥ä»˜</th>
                  <th>ç¨®åˆ¥</th>
                  <th>é€ä¿¡å…ƒ / è²©å£²è€…</th>
                  <th>é€ä¿¡å…ˆ / è³¼å…¥è€…</th>
                  <th>ãƒ¡ãƒ¢ / æ¨©åˆ©</th>
                  <th style="text-align:right;">é‡‘é¡</th>
                </tr>
              </thead>
              <tbody id="historyBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>

  <div class="toast" id="toast" aria-live="polite"></div>

  <script>
  (function(){
    const LS_KEY = 'trpg_token_state_v12_cfws';
    const LS_SYNC = 'trpg_token_sync_settings';
    const INITIAL_BAL = 10000;
    const JACKPOT_NAME = 'ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆ';

    let state = { users: [], txs: [], listings: [], rights: [], currentUserId: null, jackpotUserId: '', lastRealUserId: null, approval:{active:false, votes:{}}, version: 12, vTick: 0 };

    const sync = {
      ws: null,
      clientId: (localStorage.getItem('trpg_token_client_id') || Math.random().toString(36).slice(2)),
      url: '', room: '', key: '',
      connected: false,
      saveSettings(){ const s = { url: sync.url, room: sync.room, key: sync.key }; localStorage.setItem(LS_SYNC, JSON.stringify(s)); },
      loadSettings(){ try { const raw = localStorage.getItem(LS_SYNC); if(raw){ const s=JSON.parse(raw); sync.url=s.url||''; sync.room=s.room||''; sync.key=s.key||''; } } catch(e){}; els.syncUrl.value = sync.url; els.syncRoom.value = sync.room; els.syncKey.value = sync.key; },
      connect(){
        if(sync.connected){ toast('ã™ã§ã«æ¥ç¶šä¸­'); return; }
        sync.url = (els.syncUrl.value||'').trim();
        sync.room = (els.syncRoom.value||'').trim();
        sync.key = (els.syncKey.value||'').trim();
        if(!sync.url || !sync.room || !sync.key){ toast('URL / ãƒ«ãƒ¼ãƒ  / éµ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        try { sync.ws = new WebSocket(sync.url.replace(/^http/, 'ws')); } catch(e){ toast('URLãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'); return; }
        sync.saveSettings();
        els.syncStatus.textContent = 'æ¥ç¶šä¸­â€¦';
        sync.ws.onopen = () => {
          sync.connected = true;
          els.syncStatus.textContent = 'æ¥ç¶šæ¸ˆã¿';
          sync.ws.send(JSON.stringify({ type:'join', room: sync.room, key: sync.key, cid: sync.clientId }));
          setTimeout(()=>{ sync.send({ type:'app', action:'hello', cid: sync.clientId }); }, 300);
        };
        sync.ws.onmessage = (ev) => {
          let msg={}; try{ msg=JSON.parse(ev.data); }catch{};
          if(msg.type==='app'){
            if(msg.cid && msg.cid===sync.clientId) return;
            if(msg.action==='hello'){ setTimeout(()=>{ sync.broadcastState(); }, 300); }
            if(msg.action==='state' && msg.state){
              if(typeof msg.state.vTick === 'number' && msg.state.vTick > (state.vTick||0)){
                state = msg.state;
                state.currentUserId = localStorage.getItem('last_current_uid') || null;
                save(true); renderAll(); toast('åŒæœŸï¼šæœ€æ–°çŠ¶æ…‹ã‚’å—ä¿¡ã—ã¾ã—ãŸ');
              }
            }
          }
        };
        sync.ws.onclose = () => { sync.connected=false; els.syncStatus.textContent='æœªæ¥ç¶š'; };
        sync.ws.onerror = () => { sync.connected=false; els.syncStatus.textContent='æœªæ¥ç¶šï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰'; };
      },
      disconnect(){ if(sync.ws){ try{ sync.ws.close(); }catch{} } sync.connected=false; els.syncStatus.textContent='æœªæ¥ç¶š'; toast('åˆ‡æ–­ã—ã¾ã—ãŸ'); },
      send(obj){ if(!sync.connected || !sync.ws) return; try { sync.ws.send(JSON.stringify(obj)); } catch(e){} },
      broadcastState(){ const tmp = Object.assign({}, state, { currentUserId: null }); sync.send({ type:'app', action:'state', cid: sync.clientId, state: tmp }); }
    };
    localStorage.setItem('trpg_token_client_id', sync.clientId);

    const els = {
      kpiMembers: document.getElementById('kpiMembers'),
      kpiSupply: document.getElementById('kpiSupply'),
      walletList: document.getElementById('walletList'),
      toSelect: document.getElementById('toSelect'),
      sendBtn: document.getElementById('sendBtn'),
      amountInput: document.getElementById('amountInput'),
      memoInput: document.getElementById('memoInput'),
      historyBody: document.getElementById('historyBody'),
      searchInput: document.getElementById('searchInput'),
      memberFilter: document.getElementById('memberFilter'),
      exportBtn: document.getElementById('exportBtn'),
      importFile: document.getElementById('importFile'),
      lastActivity: document.getElementById('lastActivity'),
      toast: document.getElementById('toast'),
      userBadge: document.getElementById('userBadge'),
      actingBadge: document.getElementById('actingBadge'),
      fromFixed: document.getElementById('fromFixed'),
      streakBadge: document.getElementById('streakBadge'),
      jackpotBadge: document.getElementById('jackpotBadge'),
      morningBtn: document.getElementById('morningBtn'),
      loginName: document.getElementById('loginName'),
      loginPass: document.getElementById('loginPass'),
      loginBtn: document.getElementById('loginBtn'),
      logoutBtn: document.getElementById('logoutBtn'),
      regName: document.getElementById('regName'),
      regPass: document.getElementById('regPass'),
      registerBtn: document.getElementById('registerBtn'),
      tabs: Array.from(document.querySelectorAll('.tabbar .tab')),
      tabTransfer: document.getElementById('tab-transfer'),
      tabMarket: document.getElementById('tab-market'),
      tabMyRights: document.getElementById('tab-myrights'),
      tabGamble: document.getElementById('tab-gamble'),
      listTitle: document.getElementById('listTitle'),
      listDesc: document.getElementById('listDesc'),
      listPrice: document.getElementById('listPrice'),
      listQty: document.getElementById('listQty'),
      createListingBtn: document.getElementById('createListingBtn'),
      listingBody: document.getElementById('listingBody'),
      rightsBody: document.getElementById('rightsBody'),
      subtabs: Array.from(document.querySelectorAll('#tab-market .subtabs .sub')),
      marketSell: document.getElementById('market-sell'),
      marketList: document.getElementById('market-list'),
      jackpotChip: document.getElementById('jackpotChip'),
      rouletteBtn: document.getElementById('rouletteBtn'),
      rouletteResult: document.getElementById('rouletteResult'),
      approvalBanner: document.getElementById('approvalBanner'),
      approvalText: document.getElementById('approvalText'),
      approvalActions: document.getElementById('approvalActions'),
      btnApprove: document.getElementById('btnApprove'),
      btnReject: document.getElementById('btnReject'),
      rightReqBanner: document.getElementById('rightReqBanner'),
      rightReqText: document.getElementById('rightReqText'),
      rightReqActions: document.getElementById('rightReqActions'),
      btnRightExec: document.getElementById('btnRightExec'),
      btnRightCancel: document.getElementById('btnRightCancel'),
      syncUrl: document.getElementById('syncUrl'),
      syncRoom: document.getElementById('syncRoom'),
      syncKey: document.getElementById('syncKey'),
      btnConnect: document.getElementById('btnConnect'),
      btnDisconnect: document.getElementById('btnDisconnect'),
      btnBroadcast: document.getElementById('btnBroadcast'),
      syncStatus: document.getElementById('syncStatus'),
    };

    const fmt = new Intl.NumberFormat('ja-JP');
    const coins = n => `${fmt.format(n)} coin`;
    const ts2str = ts => { const d = new Date(ts); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; };
    const id = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const escapeHtml = (s)=> String(s).replace(/[&<>\"']/g, (c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    const pill = (txt)=> `<span class="pill">${escapeHtml(txt)}</span>`;

    function save(skipBroadcast){ localStorage.setItem(LS_KEY, JSON.stringify(state)); if(!skipBroadcast){ syncDebounced(); } }
    function load(){ try { const raw = localStorage.getItem(LS_KEY); if(raw){ state = JSON.parse(raw); } } catch(e){}; if(typeof state.vTick!=='number') state.vTick=0; }

    function toast(msg){
      const div = document.createElement('div'); div.className = 'msg'; div.textContent = msg; els.toast.appendChild(div);
      setTimeout(()=>{ div.style.opacity = '0'; div.style.transform = 'translateY(4px)'; }, 2400);
      setTimeout(()=>{ div.remove(); }, 3000);
    }

    async function sha256(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    function findUserById(uid){ return state.users.find(u=>u.id===uid)||null; }
    function findUserByName(name){ return state.users.find(u=>u.name===name)||null; }
    function jackpotUser(){ return findUserById(state.jackpotUserId); }
    function isJackpot(u){ return u && u.id===state.jackpotUserId; }
    function nameOf(uid){ const u=findUserById(uid); return u?u.name:''; }

    function ensureJackpotUser(){
      let j = findUserByName(JACKPOT_NAME);
      if(!j){ j = { id: id(), name: JACKPOT_NAME, passHash: '', balance: 0, streakCount: 0, lastMorningDate: '' }; state.users.unshift(j); }
      state.jackpotUserId = j.id;
    }

    async function register(name, pass){
      name = (name||'').trim();
      if(!name || !pass){ toast('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›'); return; }
      if(name===JACKPOT_NAME){ toast('ã“ã®åå‰ã¯äºˆç´„ã•ã‚Œã¦ã„ã¾ã™'); return; }
      if(state.users.some(u=>u.name===name)){ toast('ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯ä½¿ç”¨æ¸ˆã¿'); return; }
      const passHash = await sha256(pass);
      const u = { id: id(), name, passHash, balance: 10000, streakCount: 0, lastMorningDate: '' };
      state.users.push(u);
      state.currentUserId = u.id; state.lastRealUserId = u.id;
      addTx({ type:'mint', to:u.id, amount:10000, memo:'åˆæœŸç™ºè¡Œ' });
      bump(); save(); renderAll(); toast(`ç™»éŒ²å®Œäº†ï¼š${name}`);
    }

    async function login(name, pass){
      name = (name||'').trim();
      let u = findUserByName(name);
      if(!u){ toast('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
      if(isJackpot(u)){ state.currentUserId = u.id; }
      else {
        const passHash = await sha256(pass||'');
        if(u.passHash !== passHash){ toast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™'); return; }
        state.currentUserId = u.id; state.lastRealUserId = u.id;
      }
      localStorage.setItem('last_current_uid', state.currentUserId || '');
      save(true); renderAll(); toast(`ãƒ­ã‚°ã‚¤ãƒ³ï¼š${u.name}`);
    }

    function logout(){ state.currentUserId = null; localStorage.setItem('last_current_uid',''); save(true); renderAll(); toast('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ'); }
    function currentUser(){ return findUserById(state.currentUserId); }

    function addTx(obj){
      const now = Date.now(); const base = { id:id(), ts: now };
      const me = currentUser(); const actedBy = (me && isJackpot(me) && state.lastRealUserId) ? state.lastRealUserId : null;
      if(actedBy) obj.actedBy = actedBy;
      state.txs.unshift(Object.assign(base, obj));
    }
    function bump(){ state.vTick = (state.vTick||0) + 1; }

    function startApproval(toId, amount, memo){
      const j = jackpotUser();
      if(!j) { toast('JPOTãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
      if(j.balance < amount){ toast('ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆæ®‹é«˜ãŒä¸è¶³ã—ã¦ã„ã¾ã™'); return; }
      state.approval = { active:true, toId, amount, memo:(memo||'').trim(), votes:{}, ts: Date.now() };
      bump(); save(); renderAll();
      toast(`æ‰¿èªä¾é ¼ï¼š${nameOf(j.id)} â†’ ${nameOf(toId)} ã« ${fmt.format(amount)} coin`);
    }

    function approve(agree){
      const me = currentUser(); if(!me){ toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™'); return; }
      if(isJackpot(me)){ toast('ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆã¯æŠ•ç¥¨ã§ãã¾ã›ã‚“'); return; }
      if(!state.approval.active){ toast('æ‰¿èªä¾é ¼ã¯ã‚ã‚Šã¾ã›ã‚“'); return; }
      state.approval.votes[me.id] = agree ? 'approve' : 'reject';
      bump(); save(); renderApprovalBanner(true);
      checkApproval();
    }

    function cancelApproval(){
      const me=currentUser();
      if(!me || !isJackpot(me)) return;
      if(!state.approval.active) return;
      state.approval = {active:false, votes:{}};
      bump(); save(); renderAll(); toast('æ‰¿èªä¾é ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
    }

    function checkApproval(){
      const totalVoters = state.users.filter(u=>!isJackpot(u)).map(u=>u.id);
      const votes = state.approval.votes || {};
      if(Object.values(votes).includes('reject')){
        state.approval = {active:false, votes:{}};
        bump(); save(); renderAll(); toast('æ‰¿èªï¼šæ‹’å¦ãŒã‚ã£ãŸãŸã‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
        return;
      }
      const allApproved = totalVoters.every(uid => votes[uid] === 'approve');
      if(!allApproved){ bump(); save(); renderAll(); return; }
      const j = jackpotUser();
      const to = findUserById(state.approval.toId);
      const amt = state.approval.amount||0;
      if(!j || !to){ state.approval={active:false, votes:{}}; bump(); save(); renderAll(); return; }
      if(j.balance < amt){ state.approval={active:false, votes:{}}; bump(); save(); renderAll(); return; }
      j.balance -= amt; to.balance += amt;
      addTx({ type:'transfer', from: j.id, to: to.id, amount: amt, memo: `ï¼ˆå…¨å“¡æ‰¿èªé€é‡‘ï¼‰${state.approval.memo||''}` });
      state.approval = {active:false, votes:{}};
      bump(); save(); renderAll(); toast(`å…¨å“¡æ‰¿èª â†’ é€é‡‘å®Ÿè¡Œï¼š${nameOf(j.id)} â†’ ${nameOf(to.id)} ${fmt.format(amt)} coin`);
    }

    function transfer(toId, amount, memo){
      const from = currentUser();
      if(!from){ toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™'); return; }
      amount = Math.floor(Number(amount));
      if(!(amount > 0)) { toast('é‡‘é¡ã¯1ä»¥ä¸Šã®æ•´æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      if(!toId){ toast('é€ä¿¡å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
      const to = findUserById(toId);
      if(!to){ toast('é€ä¿¡å…ˆãŒä¸æ­£ã§ã™'); return; }
      if(from.id === toId){ toast('è‡ªåˆ†è‡ªèº«ã¸ã¯é€ä¿¡ã§ãã¾ã›ã‚“'); return; }

      if(isJackpot(from)){
        if(isJackpot(to)){ toast('ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆã¸ã¯é€é‡‘ã§ãã¾ã›ã‚“'); return; }
        startApproval(toId, amount, memo); return;
      }
      if(isJackpot(to)){ toast('ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆã¸ã¯ç›´æ¥é€é‡‘ã§ãã¾ã›ã‚“ï¼ˆæ‰‹æ•°æ–™ãƒ»ã‚®ãƒ£ãƒ³ãƒ–ãƒ«ã®ã¿ï¼‰'); return; }

      if(from.balance < amount){ toast('æ®‹é«˜ãŒä¸è¶³ã—ã¦ã„ã¾ã™'); return; }
      from.balance -= amount; to.balance += amount;
      addTx({ type:'transfer', from: from.id, to: to.id, amount, memo: (memo||'').trim() });
      bump(); save(); renderAll(); toast(`${from.name} â†’ ${to.name} ã« ${fmt.format(amount)} coin é€ä¿¡ã—ã¾ã—ãŸ`);
    }

    function exportJSON(){
      const blob = new Blob([JSON.stringify(state, null, 2)], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `trpg_token_sync_v12_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
      a.click(); URL.revokeObjectURL(a.href);
    }

    function importJSON(file){
      const reader = new FileReader();
      reader.onload = (e)=>{
        try { const data = JSON.parse(e.target.result);
          if(!data || !Array.isArray(data.users) || !Array.isArray(data.txs)) throw new Error('ä¸æ­£ãªå½¢å¼');
          const keepUid = state.currentUserId;
          state = Object.assign({version:12, approval:{active:false, votes:{}}, lastRealUserId: null, vTick:(state.vTick||0)+1}, data);
          state.currentUserId = keepUid || null;
          ensureJackpotUser();
          state.listings.forEach(l=>{ if(typeof l.qty!=='number') l.qty=1; if(typeof l.sold!=='number') l.sold=0; });
          state.rights.forEach(r=>{ if(!r.status){ r.status = r.executed? 'finalized':'owned'; } });
          save(); renderAll(); toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
        } catch(err){ toast('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
      };
      reader.readAsText(file);
    }

    function createListing(title, price, desc){
      const seller = currentUser();
      if(!seller){ toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™'); return; }
      if(isJackpot(seller)){ toast('ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆã§ã¯å‡ºå“ã§ãã¾ã›ã‚“'); return; }
      title = (title||'').trim(); desc = (desc||'').trim(); price = Math.floor(Number(price));
      let qty = Math.floor(Number(els.listQty.value||1));
      if(!title){ toast('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      if(!(price>0)){ toast('ä¾¡æ ¼ã¯1ä»¥ä¸Šã®æ•´æ•°'); return; }
      if(!(qty>0)){ toast('åœ¨åº«ã¯1ä»¥ä¸Šã®æ•´æ•°'); return; }
      const listing = { id:id(), title, price, desc, sellerId: seller.id, active:true, ts: Date.now(), qty, sold: 0 };
      state.listings.unshift(listing);
      bump(); save(); renderAll(); toast('å‡ºå“ã—ã¾ã—ãŸ');
      els.listTitle.value=''; els.listDesc.value=''; els.listPrice.value=''; els.listQty.value='';
      switchMarketSub('list');
    }

    function buyListing(listingId){
      const buyer = currentUser(); if(!buyer){ toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™'); return; }
      const l = state.listings.find(x=>x.id===listingId && x.active);
      if(!l){ toast('å‡ºå“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
      if(l.sellerId === buyer.id){ toast('è‡ªåˆ†ã®å‡ºå“ã¯è³¼å…¥ã§ãã¾ã›ã‚“'); return; }
      if(isJackpot(buyer)){ toast('ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆã§ã¯è³¼å…¥ã§ãã¾ã›ã‚“'); return; }
      const remaining = (l.qty||1) - (l.sold||0);
      if(remaining<=0){ toast('åœ¨åº«åˆ‡ã‚Œ'); l.active=false; bump(); save(); renderAll(); return; }
      if(buyer.balance < l.price){ toast('æ®‹é«˜ä¸è¶³'); return; }
      const seller = findUserById(l.sellerId); if(!seller){ toast('è²©å£²è€…ãŒä¸æ˜'); return; }

      const fee = Math.floor(l.price * 0.10);
      const sellerReceive = l.price - fee;
      const j = jackpotUser(); if(!j){ toast('JPOTãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

      buyer.balance -= l.price; seller.balance += sellerReceive; j.balance += fee;

      const right = { id:id(), listingId: l.id, title: l.title, buyerId: buyer.id, sellerId: seller.id, ts: Date.now(), status:'owned', executed:false };
      state.rights.unshift(right);

      l.sold = (l.sold||0) + 1;
      if(l.sold >= l.qty){ l.active = false; }

      addTx({ type:'purchase', from: buyer.id, to: seller.id, amount: l.price, listingId:l.id, title:l.title, memo:`æ¨©åˆ©è³¼å…¥ï¼ˆæ‰‹æ•°æ–™10%ï¼‰` });
      addTx({ type:'fee', from: seller.id, to: j.id, amount: fee, listingId:l.id, title:l.title, memo:'è²©å£²æ‰‹æ•°æ–™' });

      bump(); save(); renderAll(); toast(`è³¼å…¥ï¼š${l.title}ï¼ˆæ®‹ã‚Šåœ¨åº« ${l.qty - l.sold}ï¼‰`);
    }

    function deleteListing(listingId){
      const me = currentUser(); if(!me){ toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™'); return; }
      const idx = state.listings.findIndex(x=>x.id===listingId);
      if(idx<0){ toast('å‡ºå“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
      const l = state.listings[idx];
      if(l.sellerId !== me.id){ toast('è‡ªåˆ†ã®å‡ºå“ã®ã¿å‰Šé™¤å¯èƒ½'); return; }
      if((l.sold||0) > 0){ toast('è³¼å…¥å±¥æ­´ãŒã‚ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“'); return; }
      if(!confirm('ã“ã®å‡ºå“ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      state.listings.splice(idx,1);
      bump(); save(); renderAll(); toast('å‡ºå“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    }

    function toggleListingActive(listingId){
      const me = currentUser(); if(!me){ toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™'); return; }
      const l = state.listings.find(x=>x.id===listingId);
      if(!l){ toast('å‡ºå“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
      if(l.sellerId !== me.id){ toast('è‡ªåˆ†ã®å‡ºå“ã®ã¿æ“ä½œå¯èƒ½'); return; }
      l.active = !l.active; bump(); save(); renderAll(); toast(l.active?'å‡ºå“ã‚’å…¬é–‹ã—ã¾ã—ãŸ':'å‡ºå“ã‚’åœæ­¢ã—ã¾ã—ãŸ');
    }

    function buyerRequest(rightId){
      const me=currentUser(); if(!me){ toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦'); return; }
      const r = state.rights.find(x=>x.id===rightId); if(!r) return;
      if(r.buyerId!==me.id){ toast('è‡ªåˆ†ã®æ¨©åˆ©ã§ã¯ã‚ã‚Šã¾ã›ã‚“'); return; }
      if(r.status!=='owned'){ toast('ã“ã®æ¨©åˆ©ã¯ç”³è«‹æ¸ˆã¿ã§ã™'); return; }
      r.status='request';
      addTx({type:'execute-request', from:r.buyerId, to:r.sellerId, listingId:r.listingId, title:r.title, memo:'å®Ÿè¡Œç”³è«‹'});
      bump(); save(); renderAll(); toast('å®Ÿè¡Œã‚’ç”³è«‹ã—ã¾ã—ãŸï¼ˆè²©å£²è€…ã«é€šçŸ¥ï¼‰');
    }

    function buyerReturn(rightId){
      const me=currentUser(); if(!me){ toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦'); return; }
      const r = state.rights.find(x=>x.id===rightId); if(!r) return;
      if(r.buyerId!==me.id || r.status!=='owned'){ toast('ä¿æœ‰ä¸­ã®è‡ªåˆ†ã®æ¨©åˆ©ã®ã¿è¿”å“å¯èƒ½'); return; }
      const l = state.listings.find(x=>x.id===r.listingId); if(!l){ toast('å‡ºå“æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
      const seller = findUserById(r.sellerId); if(!seller){ toast('è²©å£²è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
      const refund = Math.floor(l.price * 0.90);
      if(seller.balance < refund){ toast('è²©å£²è€…ã®æ®‹é«˜ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆè¿”å“ä¸å¯ï¼‰'); return; }

      seller.balance -= refund;
      const buyer = findUserById(r.buyerId); buyer.balance += refund;
      l.sold = Math.max(0, (l.sold||0)-1);
      if(l.sold < l.qty){ l.active = true; }
      state.rights = state.rights.filter(x=>x.id!==rightId);

      addTx({type:'return', from:seller.id, to:buyer.id, listingId:l.id, title:r.title, amount:refund, memo:'è³¼å…¥è€…ãŒè¿”å“ï¼ˆæ‰‹æ•°æ–™ã¯è¿”ã‚‰ãªã„ï¼‰'});
      bump(); save(); renderAll(); toast(`è¿”å“ï¼š${r.title}ï¼ˆè¿”é‡‘ ${fmt.format(refund)} coinï¼‰`);
    }

    function sellerRespond(rightId, action){
      const me=currentUser(); if(!me){ toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦'); return; }
      const r = state.rights.find(x=>x.id===rightId); if(!r) return;
      if(r.sellerId!==me.id){ toast('ã‚ãªãŸã¯è²©å£²è€…ã§ã¯ã‚ã‚Šã¾ã›ã‚“'); return; }
      if(r.status!=='request'){ toast('ã“ã®æ¨©åˆ©ã¯å¾…æ©Ÿä¸­ã§ã¯ã‚ã‚Šã¾ã›ã‚“'); return; }
      const l = state.listings.find(x=>x.id===r.listingId); if(!l){ toast('å‡ºå“æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
      if(action==='exec'){
        r.status='seller_executed';
        addTx({type:'execute-done', from:r.sellerId, to:r.buyerId, listingId:r.listingId, title:r.title, memo:'è²©å£²è€…ãŒå®Ÿè¡Œ'});
        bump(); save(); renderAll(); toast('å®Ÿè¡Œã‚’å ±å‘Šã—ã¾ã—ãŸ');
      }else{
        const seller = findUserById(r.sellerId);
        if(seller.balance < l.price){ toast('æ®‹é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™'); return; }
        r.status='seller_cancel_requested';
        addTx({type:'execute-cancel-ask', from:r.sellerId, to:r.buyerId, listingId:r.listingId, title:r.title, memo:'è²©å£²è€…ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ç”³è«‹'});
        bump(); save(); renderAll(); toast('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’ç”³è«‹ã—ã¾ã—ãŸ');
      }
    }

    function buyerFinalize(rightId){
      const me=currentUser(); if(!me){ toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦'); return; }
      const r = state.rights.find(x=>x.id===rightId); if(!r) return;
      if(r.buyerId!==me.id){ toast('ã‚ãªãŸã¯è³¼å…¥è€…ã§ã¯ã‚ã‚Šã¾ã›ã‚“'); return; }
      const l = state.listings.find(x=>x.id===r.listingId); if(!l){ toast('å‡ºå“æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
      if(r.status==='seller_executed'){
        r.status='finalized'; r.executed=true;
        addTx({type:'execute-finalize', from:r.buyerId, to:r.sellerId, listingId:r.listingId, title:r.title, memo:'è³¼å…¥è€…ãŒå®Ÿè¡Œç¢ºèªï¼ˆç¢ºå®šï¼‰'});
        bump(); save(); renderAll(); toast('å®Ÿè¡Œã‚’ç¢ºå®šã—ã¾ã—ãŸ');
      } else if(r.status==='seller_cancel_requested'){
        const seller = findUserById(r.sellerId);
        const buyer = findUserById(r.buyerId);
        if(seller.balance < l.price){ toast('è²©å£²è€…ã®æ®‹é«˜ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆç¢ºå®šä¸å¯ï¼‰'); return; }
        seller.balance -= l.price; buyer.balance += l.price;
        l.sold = Math.max(0, (l.sold||0)-1); if(l.sold < l.qty){ l.active = true; }
        state.rights = state.rights.filter(x=>x.id!==rightId);
        addTx({type:'execute-cancel-ok', from:r.buyerId, to:r.sellerId, listingId:r.listingId, title:r.title, amount:l.price, memo:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«è¿”é‡‘ï¼ˆå…¨é¡ï¼‰ç¢ºå®š'});
        bump(); save(); renderAll(); toast('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆå…¨é¡è¿”é‡‘ï¼‰ã‚’ç¢ºå®šã—ã¾ã—ãŸ');
      } else { toast('ç¢ºå®šå¯èƒ½ãªçŠ¶æ…‹ã§ã¯ã‚ã‚Šã¾ã›ã‚“'); }
    }

    const MORNING_HOUR = 7, MORNING_MINUTE = 30, MORNING_BASE = 1000, STREAK_MAX = 30, STREAK_INC = 100;
    function todayKey(){ const d = new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
    function beforeDeadline(){ const n=new Date(); if(n.getHours()<MORNING_HOUR) return true; if(n.getHours()>MORNING_HOUR) return false; return n.getMinutes()<=MORNING_MINUTE; }
    function canClaimMorning(){
      const me=currentUser(); if(!me) return {ok:false,reason:'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'};
      if(isJackpot(me)) return {ok:false,reason:'ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆã¯æœæ´»å¯¾è±¡å¤–'};
      const t=todayKey(); if(me.lastMorningDate===t) return {ok:false,reason:'æœ¬æ—¥ã¯å—å–æ¸ˆã¿'};
      if(!beforeDeadline()) return {ok:false,reason:'7:30ã‚’éãã¦ã„ã¾ã™'}; return {ok:true};
    }
    function updateMorningButton(){
      const me=currentUser();
      const s=canClaimMorning(); els.morningBtn.disabled=!s.ok; els.morningBtn.title = s.ok? `æœæ´»ï¼š7:30ã¾ã§ / é€£ç¶š +${STREAK_INC}ï¼ˆä¸Šé™${STREAK_MAX}ï¼‰` : s.reason;
      const cnt = me ? (me.streakCount||0) : 0;
      els.streakBadge.textContent = `ğŸ”¥${cnt}`;
    }
    function morningClaim(){
      const me=currentUser(); const c=canClaimMorning();
      if(!c.ok){ toast(c.reason); updateMorningButton(); return; }
      const today = todayKey();
      if(me.lastMorningDate){
        const diff = Math.round((new Date(today) - new Date(me.lastMorningDate))/86400000);
        me.streakCount = (diff===1) ? Math.min((me.streakCount||0)+1, STREAK_MAX) : 1;
      } else { me.streakCount = 1; }
      me.lastMorningDate = today;
      const bonus = MORNING_BASE + STREAK_INC * (me.streakCount||0);
      me.balance += bonus;
      addTx({ type:'mint', to: me.id, amount: bonus, memo:`æœæ´»ï¼ˆé€£ç¶š${me.streakCount}æ—¥ï¼‰` });
      bump(); save(); renderAll(); toast(`æœæ´» +${fmt.format(bonus)} coinï¼ˆé€£ç¶š${me.streakCount}æ—¥ï¼‰`);
    }

    function renderJackpot(){
      const j = jackpotUser();
      const bal = j? j.balance : 0;
      els.jackpotChip.textContent = `ç¾åœ¨: ${fmt.format(bal)} coin`;
      els.jackpotBadge.textContent = `JPOT: ${fmt.format(bal)}`;
      const me=currentUser();
      els.rouletteBtn.disabled = !me || (me && me.balance < 100) || bal<=0 || (me && isJackpot(me));
    }
    function rouletteSpin(){
      const me=currentUser(); if(!me){ toast('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™'); return; }
      if(isJackpot(me)){ toast('ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆã§ã¯éŠã¹ã¾ã›ã‚“'); return; }
      if(me.balance < 100){ toast('æ®‹é«˜ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆ100 coinå¿…è¦ï¼‰'); return; }
      const j = jackpotUser(); if(!j){ toast('JPOTãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
      if(j.balance <= 0){ toast('ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆãŒç©ºã§ã™'); return; }

      me.balance -= 100; j.balance += 100;
      addTx({ type:'jpot-fee', from: me.id, to: j.id, amount: 100, memo:'ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆå‚åŠ è²»' });

      const roll = Math.random();
      if(roll < 0.01){
        const payout = j.balance;
        if(payout > 0){
          me.balance += payout;
          addTx({ type:'jackpot', from: j.id, to: me.id, amount: payout, memo:'ğŸ‰ ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆå½“é¸ï¼ˆãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼‰' });
          j.balance = 0;
          els.rouletteResult.textContent = `çµæœ: JACKPOT!! +${fmt.format(payout)} coin`;
        } else { els.rouletteResult.textContent = `çµæœ: JACKPOTç™ºç”Ÿã‚‚ãƒ—ãƒ¼ãƒ«0`; }
        bump(); save(); renderAll(); return;
      }
      const prizes = [{p:0.40, v:0},{p:0.25, v:50},{p:0.18, v:100},{p:0.09, v:150},{p:0.05, v:200},{p:0.02, v:400},{p:0.0099, v:700}];
      let r = Math.random(), acc=0, val=0;
      for(const it of prizes){ acc += it.p; if(r < acc){ val = it.v; break; } }
      const payout = Math.min(j.balance, val);
      if(payout>0){ me.balance += payout; j.balance -= payout; addTx({ type:'roulette', from: j.id, to: me.id, amount: payout, memo:'ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæ‰•ã„å‡ºã—' }); }
      els.rouletteResult.textContent = `çµæœ: +${fmt.format(payout)} coin`;
      bump(); save(); renderAll();
    }

    function renderSummary(){
      els.kpiMembers.textContent = state.users.filter(u=>!isJackpot(u)).length;
      const sumBalances = state.users.reduce((s,u)=>s+(u.balance||0),0);
      els.kpiSupply.textContent = coins(sumBalances);
      const last = state.txs[0];
      els.lastActivity.textContent = last ? `æœ€çµ‚æ›´æ–°ï¼š${ts2str(last.ts)}` : 'æœ€çµ‚æ›´æ–°ï¼šâ€”';
    }

    function renderWallets(){
      els.walletList.innerHTML = '';
      const frag = document.createDocumentFragment();
      state.users.forEach(u => {
        const row = document.createElement('div'); row.className = 'wallet';
        const name = document.createElement('div'); name.className = 'name'; name.textContent = u.name + (u.id===state.currentUserId?'ï¼ˆè‡ªåˆ†ï¼‰':'');
        const bal = document.createElement('div'); bal.className = 'balance'; bal.textContent = coins(u.balance);
        row.appendChild(name); row.appendChild(bal); frag.appendChild(row);
      });
      els.walletList.appendChild(frag);
    }

    function renderHeaderUser(){
      const me = currentUser();
      els.userBadge.textContent = me ? `${me.name} / ${coins(me.balance)}` : 'æœªãƒ­ã‚°ã‚¤ãƒ³';
      els.fromFixed.value = me ? `${me.name}ï¼ˆæ®‹é«˜ï¼š${fmt.format(me.balance)}ï¼‰` : 'æœªãƒ­ã‚°ã‚¤ãƒ³';
      if(me && isJackpot(me) && state.lastRealUserId){
        const actor = findUserById(state.lastRealUserId);
        els.actingBadge.style.display = actor? 'inline-block':'none';
        els.actingBadge.textContent = actor? `acting: ${actor.name}` : 'acting: â€”';
      } else { els.actingBadge.style.display = 'none'; }
      updateMorningButton();
      renderJackpot();
      renderApprovalBanner();
      renderRightRequestBanner();
    }

    function renderSelects(){
      const me = currentUser();
      let list = state.users.filter(u=>!me || u.id!==me.id);
      if(me && !isJackpot(me)) list = list.filter(u=>!isJackpot(u));
      const opts = list.map(u => `<option value="${u.id}">${escapeHtml(u.name)}ï¼ˆ${fmt.format(u.balance)}ï¼‰</option>`).join('');
      els.toSelect.innerHTML = `<option value="">é¸æŠ</option>${opts}`;
      els.memberFilter.innerHTML = `<option value="">ã™ã¹ã¦</option>` + state.users.map(u=>`<option value="${u.id}">${escapeHtml(u.name)}</option>`).join('');
    }

    function renderHistory(){
      const q = (els.searchInput.value||'').toLowerCase();
      const f = els.memberFilter.value||'';
      els.historyBody.innerHTML = '';
      const frag = document.createDocumentFragment();
      state.txs
        .filter(t => {
          if(f && !((t.from&&t.from===f) || (t.to&&t.to===f) || (t.actedBy&&t.actedBy===f))) return false;
          if(!q) return true;
          const fromName = nameOf(t.from);
          const toName = nameOf(t.to);
          const actorName = nameOf(t.actedBy);
          const text = `${fromName} ${toName} ${actorName} ${(t.memo||'')} ${(t.title||'')}`.toLowerCase();
          return text.includes(q);
        })
        .forEach(t => frag.appendChild(trHistory(t)));
      els.historyBody.appendChild(frag);
    }

    function trHistory(t){
      const tr = document.createElement('tr');
      const tdTime = document.createElement('td'); tdTime.textContent = ts2str(t.ts);
      const tdType = document.createElement('td'); tdType.textContent = typeLabel(t.type);
      const tdFrom = document.createElement('td'); tdFrom.innerHTML = pill(nameOf(t.from)||'â€”');
      const tdTo = document.createElement('td'); tdTo.innerHTML = pill(nameOf(t.to)||'â€”');
      const suffix = t.actedBy ? ` / actedBy:${nameOf(t.actedBy)}` : '';
      const tdMemo = document.createElement('td'); tdMemo.className='memo'; tdMemo.textContent = t.title ? `${t.title}${t.memo?` / ${t.memo}`:''}${suffix}` : ((t.memo||'')+suffix);
      const tdAmt = document.createElement('td'); tdAmt.style.textAlign = 'right'; tdAmt.innerHTML = t.amount? `<span class="amount">${fmt.format(t.amount)}</span>` : '';
      tr.append(tdTime, tdType, tdFrom, tdTo, tdMemo, tdAmt);
      return tr;
    }

    function typeLabel(tp){
      return tp==='transfer'?'é€é‡‘'
        : tp==='purchase'?'è³¼å…¥'
        : tp==='execute-request'?'å®Ÿè¡Œç”³è«‹'
        : tp==='execute-done'?'å®Ÿè¡Œï¼ˆè²©å£²è€…ï¼‰'
        : tp==='execute-finalize'?'å®Ÿè¡Œç¢ºå®šï¼ˆè³¼å…¥è€…ï¼‰'
        : tp==='execute-cancel-ask'?'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç”³è«‹ï¼ˆè²©å£²è€…ï¼‰'
        : tp==='execute-cancel-ok'?'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºå®šï¼ˆè³¼å…¥è€…ï¼‰'
        : tp==='return'?'è¿”å“'
        : tp==='mint'?'ç™ºè¡Œ'
        : tp==='burn'?'ç„¼å´'
        : tp==='fee'?'æ‰‹æ•°æ–™'
        : tp==='roulette'?'ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ'
        : tp==='jackpot'?'ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆ'
        : tp==='jpot-fee'?'JPOTå…¥é‡‘'
        : 'â€”';
    }

    function renderListings(){
      els.listingBody.innerHTML='';
      const me = currentUser();
      state.listings.forEach(l=>{
        const remaining = (l.qty||1)-(l.sold||0);
        const tr = document.createElement('tr');
        const tdT = document.createElement('td'); tdT.textContent = l.title + (l.active?'':'ï¼ˆåœæ­¢ä¸­ï¼‰');
        const tdP = document.createElement('td'); tdP.innerHTML = `<span class="amount">${fmt.format(l.price)}</span>`;
        const tdQ = document.createElement('td'); tdQ.textContent = `${remaining}/${l.qty}`;
        const tdS = document.createElement('td'); tdS.textContent = nameOf(l.sellerId);
        const tdD = document.createElement('td'); tdD.textContent = l.desc||'';
        const tdA = document.createElement('td');
        if(me){
          if(l.sellerId === me.id){
            const tog = document.createElement('button'); tog.className='btn secondary'; tog.textContent = l.active?'åœæ­¢':'å…¬é–‹'; tog.onclick = ()=>toggleListingActive(l.id);
            const del = document.createElement('button'); del.className='btn danger'; del.textContent='å‰Šé™¤'; del.disabled = (l.sold||0)>0; del.onclick = ()=>deleteListing(l.id);
            tdA.appendChild(tog); tdA.appendChild(document.createTextNode(' ')); tdA.appendChild(del);
          } else {
            const buy = document.createElement('button'); buy.className='btn'; buy.textContent='è³¼å…¥';
            buy.disabled = !l.active || remaining<=0 || isJackpot(me);
            buy.onclick=()=>{ buy.disabled=true; buyListing(l.id); };
            tdA.appendChild(buy);
          }
        } else {
          const s = document.createElement('span'); s.className='chip'; s.textContent='ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'; tdA.appendChild(s);
        }
        tr.append(tdT, tdP, tdQ, tdS, tdD, tdA);
        els.listingBody.appendChild(tr);
      });
    }

    function renderRights(){
      els.rightsBody.innerHTML='';
      const me = currentUser(); if(!me) return;
      const my = state.rights.filter(r=>r.buyerId===me.id);
      my.forEach(r=>{
        const tr = document.createElement('tr');
        const tdTs = document.createElement('td'); tdTs.textContent = ts2str(r.ts);
        const tdT = document.createElement('td'); tdT.textContent = r.title;
        const tdS = document.createElement('td'); tdS.textContent = nameOf(r.sellerId);
        const tdSt = document.createElement('td'); tdSt.textContent = statusLabel(r);
        const tdA = document.createElement('td'); tdA.appendChild(rightActionButtons(r));
        tr.append(tdTs, tdT, tdS, tdSt, tdA);
        els.rightsBody.appendChild(tr);
      });
    }

    function statusLabel(r){
      return r.status==='owned'?'ä¿æœ‰ä¸­'
        : r.status==='request'?'è²©å£²è€…ã®å¯¾å¿œå¾…ã¡'
        : r.status==='seller_executed'?'è²©å£²è€…ãŒå®Ÿè¡Œæ¸ˆï¼ˆç¢ºèªå¾…ã¡ï¼‰'
        : r.status==='seller_cancel_requested'?'è²©å£²è€…ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ç”³è«‹ï¼ˆç¢ºèªå¾…ã¡ï¼‰'
        : r.status==='finalized'? (r.executed?'ç¢ºå®šï¼ˆå®Ÿè¡Œæ¸ˆï¼‰':'ç¢ºå®šï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰')
        : 'â€”';
    }

    function rightActionButtons(r){
      const span = document.createElement('span');
      if(r.status==='owned'){
        const btn = document.createElement('button'); btn.className='btn warn'; btn.textContent='å®Ÿè¡Œã‚’ç”³è«‹'; btn.onclick=()=>{ btn.disabled=true; buyerRequest(r.id); };
        const ret = document.createElement('button'); ret.className='btn danger'; ret.textContent='è¿”å“'; ret.onclick=()=>{ ret.disabled=true; buyerReturn(r.id); };
        span.appendChild(btn); span.appendChild(document.createTextNode(' ')); span.appendChild(ret);
      } else if(r.status==='seller_executed'){
        const btn = document.createElement('button'); btn.className='btn'; btn.textContent='æ¸ˆï¼ˆç¢ºå®šï¼‰'; btn.onclick=()=>{ btn.disabled=true; buyerFinalize(r.id); };
        span.appendChild(btn);
      } else if(r.status==='seller_cancel_requested'){
        const btn = document.createElement('button'); btn.className='btn secondary'; btn.textContent='ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ‰¿èªï¼ˆç¢ºå®šï¼‰'; btn.onclick=()=>{ btn.disabled=true; buyerFinalize(r.id); };
        span.appendChild(btn);
      } else {
        const chip = document.createElement('span'); chip.className='chip'; chip.textContent='æ“ä½œãªã—'; span.appendChild(chip);
      }
      return span;
    }

    function switchMarketSub(which){
      els.subtabs.forEach(s=> s.classList.toggle('active', s.dataset.sub===which));
      els.marketSell.style.display = which==='sell' ? 'block' : 'none';
      els.marketList.style.display = which==='list' ? 'block' : 'none';
    }

    function renderApprovalBanner(forceGray){
      if(!state.approval.active){ els.approvalBanner.style.display='none'; return; }
      const to=findUserById(state.approval.toId);
      const amt=state.approval.amount||0;
      els.approvalText.textContent = `ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆãŒ ${to?to.name:'?'} ã« ${fmt.format(amt)} coin ã‚’é€é‡‘ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™` + (state.approval.memo? `ï¼ˆ${state.approval.memo}ï¼‰` : '');
      const me=currentUser();
      if(me && !isJackpot(me)){
        const voted = state.approval.votes && state.approval.votes[me.id];
        els.btnApprove.disabled = !!voted || !!forceGray;
        els.btnReject.disabled = !!voted || !!forceGray;
        els.approvalActions.style.display='flex';
      } else if(me && isJackpot(me)){
        els.btnApprove.disabled = true;
        els.btnReject.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
        els.btnReject.disabled = false;
        els.approvalActions.style.display='flex';
      } else { els.approvalActions.style.display='none'; }
      els.approvalBanner.style.display='flex';
    }

    function renderRightRequestBanner(){
      const me=currentUser(); if(!me){ els.rightReqBanner.style.display='none'; return; }
      const pending = state.rights.filter(r=>r.sellerId===me.id && r.status==='request').sort((a,b)=>b.ts-a.ts)[0];
      if(!pending){ els.rightReqBanner.style.display='none'; return; }
      const buyer = findUserById(pending.buyerId);
      els.rightReqText.textContent = `æ¨©åˆ©å®Ÿè¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼š${buyer?buyer.name:'?'} ãŒã€Œ${pending.title}ã€ã®å®Ÿè¡Œã‚’ç”³è«‹ã—ã¦ã„ã¾ã™`;
      els.btnRightExec.onclick = ()=>{ els.btnRightExec.disabled=true; els.btnRightCancel.disabled=true; sellerRespond(pending.id,'exec'); };
      els.btnRightCancel.onclick = ()=>{ els.btnRightExec.disabled=true; els.btnRightCancel.disabled=true; sellerRespond(pending.id,'cancel'); };
      els.rightReqBanner.style.display='flex';
    }

    function renderTabs(){
      const show = (name)=>{
        els.tabTransfer.style.display = name==='transfer'? 'block':'none';
        els.tabMarket.style.display   = name==='market'  ? 'block':'none';
        els.tabMyRights.style.display = name==='myrights'? 'block':'none';
        els.tabGamble.style.display   = name==='gamble'  ? 'block':'none';
      }
      const active = document.querySelector('.tabbar .tab.active');
      show(active? active.dataset.tab : 'transfer');
    }

    function renderAll(){ renderSummary(); renderWallets(); renderHeaderUser(); renderSelects(); renderHistory(); renderListings(); renderRights(); renderTabs(); }

    let syncTimer = null;
    function syncDebounced(){ if(!sync.connected) return; if(syncTimer) clearTimeout(syncTimer); syncTimer = setTimeout(()=>{ sync.broadcastState(); }, 180); }

    els.registerBtn.addEventListener('click', ()=> register(els.regName.value, els.regPass.value));
    els.loginBtn.addEventListener('click', ()=> login(els.loginName.value, els.loginPass.value));
    els.logoutBtn.addEventListener('click', logout);
    els.sendBtn.addEventListener('click', ()=>{ transfer(els.toSelect.value, els.amountInput.value, els.memoInput.value); els.amountInput.value=''; els.memoInput.value=''; });
    els.searchInput.addEventListener('input', renderHistory);
    els.memberFilter.addEventListener('change', renderHistory);
    els.exportBtn.addEventListener('click', exportJSON);
    els.importFile.addEventListener('change', (e)=>{ const f=e.target.files[0]; if(f) importJSON(f); e.target.value=''; });
    els.createListingBtn.addEventListener('click', ()=> createListing(els.listTitle.value, els.listPrice.value, els.listDesc.value));
    els.tabs.forEach(t=> t.addEventListener('click', ()=>{ document.querySelectorAll('.tabbar .tab').forEach(x=>x.classList.remove('active')); t.addEventListener('animationend',()=>{}, {once:true}); t.classList.add('active'); renderTabs(); }));
    els.subtabs.forEach(s=> s.addEventListener('click', ()=> switchMarketSub(s.dataset.sub)));
    els.morningBtn.addEventListener('click', morningClaim);
    els.rouletteBtn.addEventListener('click', rouletteSpin);
    els.btnApprove.addEventListener('click', ()=> approve(true));
    els.btnReject.addEventListener('click', ()=>{ const me=currentUser(); if(me && isJackpot(me)){ cancelApproval(); } else { approve(false); } });
    els.btnConnect.addEventListener('click', ()=> sync.connect());
    els.btnDisconnect.addEventListener('click', ()=> sync.disconnect());
    els.btnBroadcast.addEventListener('click', ()=> sync.broadcastState());

    load(); ensureJackpotUser();
    state.listings.forEach(l=>{ if(typeof l.qty!=='number') l.qty=1; if(typeof l.sold!=='number') l.sold=0; });
    state.rights.forEach(r=>{ if(!r.status){ r.status = r.executed? 'finalized':'owned'; } });
    if(typeof state.jackpot === 'number'){ jackpotUser().balance += state.jackpot; delete state.jackpot; }
    state.txs.forEach(t=>{ if(t.to==='_jackpot'){ t.to = state.jackpotUserId; } if(t.from==='_jackpot'){ t.from = state.jackpotUserId; } });
    state.users.forEach(u=>{ if(typeof u.streakCount!=='number') u.streakCount=0; if(typeof u.lastMorningDate!=='string') u.lastMorningDate=''; });

    sync.loadSettings();
    save(true); renderAll();
    setInterval(()=>{ try{ updateMorningButton(); renderApprovalBanner(); renderRightRequestBanner(); }catch(e){} }, 30000);

    if(state.users.filter(u=>!isJackpot(u)).length===0){ toast(`ã¾ãšã¯æ–°è¦ç™»éŒ²ã—ã¦ãã ã•ã„ï¼ˆåˆæœŸæ®‹é«˜ã¯ 10,000 coinï¼‰ / ${JACKPOT_NAME} ã¯ãƒ‘ã‚¹ä¸è¦ã§èª°ã§ã‚‚ãƒ­ã‚°ã‚¤ãƒ³å¯`); }
  })();
  </script>
</body>
</html>
