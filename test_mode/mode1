<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TRPGトークン | v15 (React)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <style>
        :root {
            --font-primary: 'Helvetica Neue', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            --font-mono: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            --bg-dark-1: #16161e; --bg-dark-2: #1a1b26; --bg-dark-3: #24283b; --bg-dark-4: #414868;
            --fg-light-1: #c0caf5; --fg-light-2: #a9b1d6; --fg-light-3: #787c99;
            --accent-blue: #7aa2f7; --accent-cyan: #7dcfff; --accent-purple: #bb9af7;
            --accent-green: #9ece6a; --accent-yellow: #e0af68; --accent-red: #f7768e;
            --border-radius: 8px; --transition-speed: 0.3s;
        }
        * { box-sizing: border-box; }
        html, body, #root { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { background-color: var(--bg-dark-1); color: var(--fg-light-1); font-family: var(--font-primary); font-size: 15px; -webkit-font-smoothing: antialiased; }
        #root { display: flex; transition: background-color var(--transition-speed); }
        .app-container, .login-screen { width: 100%; height: 100%; }
        .login-screen { display: flex; justify-content: center; align-items: center; background: linear-gradient(160deg, var(--bg-dark-2), var(--bg-dark-1)); }
        .login-box { background-color: var(--bg-dark-2); padding: 40px; border-radius: var(--border-radius); box-shadow: 0 15px 40px rgba(0,0,0,0.5); border: 1px solid var(--bg-dark-4); width: 100%; max-width: 400px; text-align: center; }
        .login-box h1 { color: var(--accent-purple); margin-bottom: 30px; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; color: var(--fg-light-2); font-size: 0.9em; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 12px; background-color: var(--bg-dark-1); border: 1px solid var(--bg-dark-4); border-radius: var(--border-radius); color: var(--fg-light-1); font-size: 1em; transition: all var(--transition-speed); }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(122, 162, 247, 0.3); }
        .btn { padding: 10px 15px; border-radius: var(--border-radius); border: none; background: linear-gradient(145deg, var(--accent-blue), var(--accent-purple)); color: white; font-size: 1em; font-weight: 600; cursor: pointer; transition: all var(--transition-speed); }
        .btn-secondary { background: var(--bg-dark-3); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .toggle-form { margin-top: 25px; font-size: 0.9em; color: var(--fg-light-3); }
        .toggle-form span { color: var(--accent-cyan); cursor: pointer; font-weight: 600; }
        .dashboard { display: grid; grid-template-columns: 320px 1fr 400px; grid-template-rows: auto 1fr; height: 100vh; gap: 1px; background-color: var(--bg-dark-4); }
        .dashboard-header { grid-column: 1 / -1; background-color: var(--bg-dark-2); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--bg-dark-4); }
        .dashboard-header h1 { font-size: 1.2em; margin: 0; }
        .user-badge { background-color: var(--bg-dark-3); padding: 8px 12px; border-radius: var(--border-radius); font-size: 0.9em; }
        .dashboard-left, .dashboard-main, .dashboard-right { overflow-y: auto; padding: 20px; background-color: var(--bg-dark-2); }
        .dashboard-main { background-color: var(--bg-dark-1); }
        .panel { background-color: var(--bg-dark-2); border: 1px solid var(--bg-dark-4); border-radius: var(--border-radius); padding: 20px; margin-bottom: 20px; }
        .panel h2 { margin-top: 0; color: var(--accent-purple); font-size: 1.1em; border-bottom: 1px solid var(--bg-dark-4); padding-bottom: 10px; margin-bottom: 15px;}
        .wallet-list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 4px; transition: background-color var(--transition-speed); }
        .wallet-list-item:hover { background-color: var(--bg-dark-3); }
        .history-item { font-size: 0.9em; padding: 8px 0; border-bottom: 1px solid var(--bg-dark-4); }
        .history-item:last-child { border-bottom: none; }
        .action-tabs { display: flex; border-bottom: 1px solid var(--bg-dark-4); margin-bottom: 15px; }
        .action-tab { padding: 10px 15px; cursor: pointer; color: var(--fg-light-2); border-bottom: 2px solid transparent; }
        .action-tab.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }
        .form-grid { display: grid; grid-template-columns: auto 1fr; gap: 12px; align-items: center; }
        .form-grid .full-width { grid-column: 1 / -1; }
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark-1); }
        ::-webkit-scrollbar-thumb { background: var(--bg-dark-4); border-radius: 5px; border: 2px solid var(--bg-dark-1); }
        ::-webkit-scrollbar-thumb:hover { background: var(--fg-light-3); }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        const API = {
            async sha256(text) { const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text)); return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join(''); },
            createOperation(type, data, userId) { return { id: `op_${Math.random().toString(36).slice(2)}_${Date.now()}`, type, data, timestamp: Date.now(), userId, clientId: 'client_main_v15' }; },
            async fetchState(settings, lastSync) {
                const url = new URL(settings.url);
                url.searchParams.set('room', settings.room); url.searchParams.set('key', settings.key);
                if (lastSync) url.searchParams.set('lastSync', lastSync);
                const res = await fetch(url.toString());
                if (res.status === 204) return null;
                if (!res.ok) throw new Error(`サーバーエラー: ${res.status}`);
                return res.json();
            },
            async sendOperations(settings, operations) {
                const url = new URL(settings.url);
                url.searchParams.set('room', settings.room); url.searchParams.set('key', settings.key);
                const res = await fetch(url.toString(), { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ operations }) });
                if (!res.ok) { const txt = await res.text(); throw new Error(`操作送信失敗: ${res.status} ${txt}`); }
                return res.json();
            }
        };

        function App() {
            const [appState, setAppState] = useState({ state: null, currentUser: null, settings: {} });
            const [error, setError] = useState('');

            const handleLogin = useCallback((user, state) => {
                setAppState(s => ({...s, currentUser: user, state}));
                localStorage.setItem('last_current_uid', user.id);
            }, []);

            useEffect(() => {
                try {
                    const settings = JSON.parse(localStorage.getItem('trpg_sync_kv') || '{}');
                    const lastUserId = localStorage.getItem('last_current_uid');
                    setAppState(s => ({...s, settings}));
                    if (lastUserId && settings.url) {
                        API.fetchState(settings).then(data => {
                            if (data && data.state) {
                                const user = data.state.users.find(u => u.id === lastUserId);
                                if (user) handleLogin(user, data.state);
                            }
                        }).catch(err => setError(`自動ログイン失敗: ${err.message}`));
                    }
                } catch (e) { console.error("Initialization error:", e); setError("アプリの初期化に失敗しました。"); }
            }, [handleLogin]);
            
            const handleLogout = () => {
                setAppState(s => ({...s, currentUser: null}));
                localStorage.removeItem('last_current_uid');
            };

            return (
                <div className="app-container">
                    {error && <div style={{color: 'var(--accent-red)', padding: '10px', textAlign: 'center'}}>{error}</div>}
                    {!appState.currentUser || !appState.state ? (
                        <LoginScreen onLogin={handleLogin} settings={appState.settings} />
                    ) : (
                        <MainDashboard user={appState.currentUser} initialState={appState.state} settings={appState.settings} onLogout={handleLogout} />
                    )}
                </div>
            );
        }

        function MainDashboard({ user, onLogout, initialState, settings }) {
            const [state, setState] = useState(initialState);
            const lastSyncTime = useRef(Date.now());

            const onSendOperation = useCallback(async (type, data) => {
                const op = API.createOperation(type, data, user.id);
                try {
                    const result = await API.sendOperations(settings, [op]);
                    if (result.newState) setState(result.newState);
                } catch (e) { console.error(e); }
            }, [user.id, settings]);

            useEffect(() => {
                const poll = () => {
                    API.fetchState(settings, lastSyncTime.current).then(data => {
                        if (data && data.state) {
                            setState(data.state);
                            lastSyncTime.current = data.lastUpdate;
                        }
                    }).catch(console.error);
                };
                const interval = setInterval(poll, 3000);
                return () => clearInterval(interval);
            }, [settings]);

            const currentUserInState = state.users.find(u => u.id === user.id);

            return (
                <div className="dashboard">
                    <header className="dashboard-header">
                        <h1>TRPGトークン</h1>
                        <div className="user-badge">{user.name} | {currentUserInState?.balance.toLocaleString()} coin</div>
                        <button className="btn" onClick={onLogout}>ログアウト</button>
                    </header>
                    <aside className="dashboard-left">
                        <WalletPanel users={state.users} />
                        <StatsPanel state={state} />
                    </aside>
                    <main className="dashboard-main">
                        <ActionPanel onSendOperation={onSendOperation} state={state} currentUser={user} />
                    </main>
                    <aside className="dashboard-right">
                        <HistoryPanel txs={state.txs} users={state.users} />
                    </aside>
                </div>
            );
        }

        const WalletPanel = ({ users }) => (
            <div className="panel">
                <h2>ウォレット一覧</h2>
                <div>{users.map(u => <div className="wallet-list-item" key={u.id}><span>{u.name}</span><span>{u.balance.toLocaleString()} coin</span></div>)}</div>
            </div>
        );

        const HistoryPanel = ({ txs, users }) => {
            const nameOf = (id) => users.find(u => u.id === id)?.name || 'N/A';
            return (
                <div className="panel">
                    <h2>取引履歴</h2>
                    <div>{(txs || []).slice(0, 40).map(tx => <div className="history-item" key={tx.id}><strong>{nameOf(tx.from)}</strong> &rarr; <strong>{nameOf(tx.to)}</strong>: {tx.amount} coin <br/><span style={{color: 'var(--fg-light-3)'}}>{tx.memo || tx.title}</span></div>)}</div>
                </div>
            );
        };

        const ActionPanel = ({ onSendOperation, state, currentUser }) => {
            const [activeTab, setActiveTab] = useState('transfer');
            return (
                <div className="panel">
                    <div className="action-tabs">
                        <div className={`action-tab ${activeTab === 'transfer' ? 'active' : ''}`} onClick={() => setActiveTab('transfer')}>送金</div>
                        <div className={`action-tab ${activeTab === 'market' ? 'active' : ''}`} onClick={() => setActiveTab('market')}>マーケット</div>
                    </div>
                    {activeTab === 'transfer' && <TransferPanel onSendOperation={onSendOperation} users={state.users} currentUser={currentUser} />}
                    {activeTab === 'market' && <div style={{padding: '20px', textAlign: 'center'}}>マーケット機能は現在開発中です。</div>}
                </div>
            );
        };

        const TransferPanel = ({ onSendOperation, users, currentUser }) => {
            const [toId, setToId] = useState('');
            const [amount, setAmount] = useState('');
            const [memo, setMemo] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                onSendOperation('transfer', { toId, amount: Number(amount), memo });
                setAmount(''); setMemo('');
            };

            return (
                <form onSubmit={handleSubmit}>
                    <div className="input-group">
                        <label>送信先</label>
                        <select value={toId} onChange={e => setToId(e.target.value)} required>
                            <option value="">選択...</option>
                            {users.filter(u => u.id !== currentUser.id && u.name !== 'ジャックポット').map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                        </select>
                    </div>
                    <div className="input-group"><label>金額</label><input type="number" value={amount} onChange={e => setAmount(e.target.value)} required min="1" /></div>
                    <div className="input-group"><label>メモ</label><input type="text" value={memo} onChange={e => setMemo(e.target.value)} /></div>
                    <button type="submit" className="btn">送金</button>
                </form>
            );
        }

        function StatsPanel({ state }) {
            const pieChartRef = useRef(null);
            useEffect(() => {
                if (!state.users || !d3 || !pieChartRef.current) return;
                const users = state.users.filter(u => u.name !== 'ジャックポット');
                const data = users.map(u => ({name: u.name, value: u.balance}));

                const width = 280, height = 280, margin = 20;
                const radius = Math.min(width, height) / 2 - margin;

                d3.select(pieChartRef.current).select("svg").remove();
                const svg = d3.select(pieChartRef.current).append("svg").attr("width", width).attr("height", height).append("g").attr("transform", `translate(${width / 2},${height / 2})`);
                const color = d3.scaleOrdinal().domain(data.map(d => d.name)).range(d3.schemeSpectral[data.length] || d3.schemeCategory10);
                const pie = d3.pie().value(d => d.value);
                const data_ready = pie(data);

                svg.selectAll('path').data(data_ready).join('path')
                    .attr('d', d3.arc().innerRadius(radius * 0.5).outerRadius(radius))
                    .attr('fill', d => color(d.data.name))
                    .attr("stroke", "var(--bg-dark-1)").style("stroke-width", "2px");
            }, [state.users]);

            return (<div className="panel"><h2>資産分布</h2><div ref={pieChartRef} style={{display: 'flex', justifyContent: 'center'}}></div></div>);
        }

        function LoginScreen({ onLogin, settings }) {
            const [isLoginView, setIsLoginView] = useState(true);
            const [name, setName] = useState('');
            const [pass, setPass] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const passRef = useRef(null);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                if (!settings.url) { setError("同期URLが設定されていません。"); return; }
                setLoading(true);
                try {
                    const serverData = await API.fetchState(settings);
                    const serverState = serverData ? serverData.state : { users: [] };
                    if (isLoginView) {
                        const user = serverState.users.find(u => u.name === name);
                        if (!user) throw new Error('ユーザーが見つかりません');
                        const passHash = await API.sha256(pass);
                        if (user.passHash !== passHash) { passRef.current.select(); throw new Error('パスワードが違います'); }
                        onLogin(user, serverState);
                    } else {
                        if (serverState.users.some(u => u.name === name)) throw new Error('そのユーザー名は使用済みです');
                        const passHash = await API.sha256(pass);
                        const op = API.createOperation('register_user', { name, passHash }, null);
                        const result = await API.sendOperations(settings, [op]);
                        const newUser = result.newState.users.find(u => u.name === name);
                        if (newUser) onLogin(newUser, result.newState);
                        else throw new Error('登録後のユーザーが見つかりませんでした。');
                    }
                } catch (err) { setError(err.message); } finally { setLoading(false); }
            };

            return (
                <div className="login-screen">
                    <div className="login-box">
                        <h1>{isLoginView ? 'ログイン' : '新規登録'}</h1>
                        <form onSubmit={handleSubmit}>
                            <div className="input-group"><label htmlFor="username">ユーザー名</label><input id="username" type="text" value={name} onChange={e => setName(e.target.value)} required /></div>
                            <div className="input-group"><label htmlFor="password">パスワード</label><input id="password" type="password" ref={passRef} value={pass} onChange={e => setPass(e.target.value)} required /></div>
                            {error && <p style={{color: 'var(--accent-red)', textAlign: 'center'}}>{error}</p>}
                            <button type="submit" className="btn" disabled={loading}>{loading ? '処理中...' : (isLoginView ? 'ログイン' : '登録してログイン')}</button>
                        </form>
                        <p className="toggle-form">{isLoginView ? 'アカウントがありませんか？' : '既にアカウントがありますか？'}<span onClick={() => setIsLoginView(!isLoginView)}>{isLoginView ? ' 新規登録' : ' ログイン'}</span></p>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
